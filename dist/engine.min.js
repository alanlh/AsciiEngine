const t={generateId:function(){let t=0;return function(e){return void 0===e&&(e="AsciiEngine"),t++,e+"_"+t}}(),clamp:function(t,e,s){return Math.max(e,Math.min(t,s))},breakLineIntoRows:(t,e,s=!1)=>{let i=t.split(" "),n=[],r=0,h=0,o=0;for(let t=0;t<i.length;t++){if(t>h){if(r+1+i[t].length<=e){r+=1+i[t].length;continue}let a=i.slice(h,t).join(" ").substr(o);a.length<e&&s&&(a+=" ".repeat(e-a.length)),n.push(a),r=0,h=t,o=0}if(i[t].length>e){let s=0;for(;s<i[t].length-e;s+=e)n.push(i[t].substr(s,e));r=i[t].length-s,o=s}else r=i[t].length}return n.push(i.slice(h,i.length).join(" ").substr(o)),n},stringSplice:(t,e,s,i)=>t.substring(0,e)+(i||"")+t.substring(e+s)};Object.freeze(t);class e{constructor(e){this._name=e,this._id=t.generateId(this._name),this._initialized=!1,this._entityManager=void 0,this._components={},this._parent=void 0,this._children={},this._changed=!0,this._enabled=!0,this._ancestorsEnabled=!0}clone(t){}init(t){this._initialized=!0,this._entityManager=t,this._entityManager.notifyAddition(this);for(let e in this._children)this._children[e].init(t)}get initialized(){return this._initialized}destroy(){for(let t in this._children)this._children[t].destroy();this._parent&&delete this._parent._children[this.id],this.initialized&&this._entityManager.notifyDeletion(this)}setParent(t){this._parent=t}getParent(){return this._parent}get name(){return this._name}get id(){return this._id}setComponent(t){this.initialized?this._entityManager.requestSetComponent(this,t):this._setComponent(t)}_setComponent(t){this._components[t.type]=t,this.initialized&&this._entityManager.notifyComponentChange(this,t)}getComponent(t){return this.hasComponent(t)?this._components[t]:null}hasComponent(t){return t in this._components}deleteComponent(t){this.initialized&&this.hasComponent(t)?this._entityManager.requestDeleteComponent(this,t):this._deleteComponent(t)}_deleteComponent(t){this.hasComponent(t)?(delete this._components[t],this.initialized&&this._entityManager.notifyComponentChange(this)):console.warn("Entity",this.id,"does not have component of type ",t)}addChild(t){this.initialized?this._entityManager.requestAddEntity(t,this):this._addChild(t)}_addChild(t){this._children[t.id]=t,t.setParent(this)}removeChild(t){this.initialized&&this._children}_removeChild(t){}markForDeletion(){this.initialized?this._entityManager.requestDeleteEntity(this):this.destroy()}enable(t){this.initialized?this._entityManager.requestEnable(this,t):this._enable(t)}_enable(t){if(this._entityManager.notifyEnable(this),t)for(let e in this._children)this._children[e]._enable(t)}disable(t){this.initialized?this._entityManager.requestDisable(this,t):this._disable(t)}_disable(t){if(this._entityManager.notifyDisable(this),t)for(let e in this._children)this._children[e]._disable(t)}}class s{constructor(){this._storage=[],this._size=0,this._currIdx=0}enqueue(t){this._storage.push(t),this._size++}dequeue(t){let e=this.front;if(void 0===t&&(t=1),this.size<=t)this._storage=[],this._size=0,this._currIdx=0;else if(this.size-t<this._storage.length/2)this._storage=this._storage.slice(this._currIdx+t),this._currIdx=0,this._size-=t;else{let e=0;for(;e<t;)this._storage[this._currIdx]=void 0,this._size--,this._currIdx++,e++}return e}get front(){if(this._size>0)return this._storage[this._currIdx]}get back(){if(this._size>0)return this._storage[this._storage.length-1]}at(t){if(!(t>=this._size||t<0))return this._storage[this._currIdx+t]}get size(){return this._size}get empty(){return 0==this.size}}class i{constructor(t,e,...s){this.operation=t,this.target=e,this.args=s,Object.freeze(this)}}i.ADD_ENTITY=Symbol("AddEntity"),i.DELETE_ENTITY=Symbol("DeleteEntity"),i.SET_COMPONENT=Symbol("SetComponent"),i.DELETE_COMPONENT=Symbol("DeleteComponent"),i.ENABLE=Symbol("Enable"),i.DISABLE=Symbol("Disable");class n{constructor(t){this._engine=t,this._entities=new Set,this._entityOperations=new s,this._added=new Set,this._deleted=new Set,this._changed=new Set,this._enabled=new Set,this._disabled=new Set}init(t){}initEntity(t){t.init(this)}postUpdateCleanup(){for(;!this._entityOperations.empty;){let t=this._entityOperations.dequeue();this[t.operation](t.target,...t.args)}}requestEntityChanges(){return{added:this._added,deleted:this._deleted,changed:this._changed,enabled:this._enabled,disabled:this._disabled}}markEntityChangesAsHandled(){this._added.clear(),this._deleted.clear(),this._changed.clear(),this._enabled.clear(),this._disabled.clear()}get entities(){return this._entities}requestAddEntity(t,e){this._entityOperations.enqueue(new i(i.ADD_ENTITY,t,e))}[i.ADD_ENTITY](t,e){e&&e._addChild(t),this.initEntity(t)}notifyAddition(t){this._added.add(t),this.entities.add(t)}requestDeleteEntity(t){this._entityOperations.enqueue(new i(i.DELETE_ENTITY,t))}[i.DELETE_ENTITY](t){t.destroy()}notifyDeletion(t){this._deleted.add(t),this.entities.delete(t)}requestSetComponent(t,e){this._entityOperations.enqueue(new i(i.SET_COMPONENT,t,e))}[i.SET_COMPONENT](t,e){t._setComponent(e)}requestDeleteComponent(t,e){this._entityOperations.enqueue(new i(i.DELETE_COMPONENT,t,e))}[i.DELETE_COMPONENT](t,e){target._deleteComponent(e)}notifyComponentChange(t){this._changed.add(t)}requestEnable(t,e){this._entityOperations.enqueue(new i(i.ENABLE,t,e))}[i.ENABLE](t,e){t._enable(e)}notifyEnable(t){this._enabled.add(t)}requestDisable(t,e){this._entityOperations.enqueue(new i(i.DISABLE,t,e))}[i.DISABLE](t,e){entity._disable(e)}notifyDisable(t){this._disabled.add(t)}}class r{constructor(t){this._engine=void 0,this._systemManager=void 0,this._entityManager=void 0,this._name=t,this._priority=0,this._active=!1}get type(){return this.constructor.type}get name(){return this._name}init(t){this._systemManager=t,this._engine=t.getEngine(),this._entityManager=this._engine.getEntityManager(),this._active=!0,this.startup()}destroy(){this.shutdown(),this.unsubscribe([])}getSystemManager(){return this._systemManager}getEngine(){return this._engine}getEntityManager(){return this._entityManager}enable(){this._active||(this._active=!0)}disable(){this._active&&(this._active=!1)}get active(){return this._active}subscribe(t,e,s,i){s&&(e=e.bind(this)),this.getSystemManager().getMessageBoard().subscribe(this.name,t,e,i)}unsubscribe(t){this.getSystemManager().getMessageBoard().unsubscribe(this.name,t)}postMessage(t,e,s){this.getSystemManager().getMessageBoard().post(this.name,t,e,s)}startup(){}shutdown(){}check(t){return!1}has(t){}add(t){}remove(t){}preUpdate(){}update(){}postUpdate(){}}class h{constructor(){this.children={},this.data=new Set,this.size=0}has(t,e){this._has(t,0,e)}_has(t,e,s){if(e>=t.length){if(void 0===s||this.data.has(s))return!0;for(let i in this.children)if(this.children[i]._has(t,e+1,s))return!0;return o in this.children&&this.children[o]._has(t,e+1,s)}if(void 0===t[e]){for(let i in this.children)if(this.children[i]._has(t,e+1,s))return!0;return o in this.children&&this.children[o]._has(t,e+1,s)}return!(!(t[e]in this.children)||!this.children[t[e]]._has(t,e+1,s))||o in this.children&&this.children[o]._has(t,e+1,s)}add(t,e){this._add(t,0,e)}_add(t,e,s){if(e===t.length)return this.data.add(s),void this.size++;let i=t[e];void 0===i&&(i=o),i in this.children||(this.children[i]=new h),this.children[i]._add(t,e+1,s),this.size++}delete(t,e){if(0===t.length&&void 0===e)return this.children={},this.data=new Set,void(this.size=0);this._delete(t,0,e)}_delete(t,e,s){let i=0;if(e>=t.length){if(void 0===s){let t=this.size;return this.size=0,t}this.data.delete(s)&&i++,this.size-=i;for(let n in this.children)i+=this._deleteHelper(t,e,s,n);return o in this.children&&(i+=this._deleteHelper(t,e,s,o)),i}if(void 0===t[e]){for(let n in this.children)i+=this._deleteHelper(t,e,s,n);return o in this.children&&(i+=this._deleteHelper(t,e,s,o)),i}return t[e]in this.children&&(i+=this._deleteHelper(t,e,s,t[e])),o in this.children&&(i+=this._deleteHelper(t,e,s,o)),i}_deleteHelper(t,e,s,i){let n=this.children[i]._delete(t,e+1,s);return 0===this.children[i].size&&delete this.children[i],this.size-=n,n}*getDescIt(t){yield*this._getDescIt(t,0)}*_getDescIt(t,e){if(e>=t.length){for(let t of this.data)yield t;for(let s in this.children)yield*this.children[s]._getDescIt(t,e+1);o in this.children&&(yield*this.children[o]._getDescIt(t,e+1))}else if(void 0===t[e]){for(let s in this.children)yield*this.children[s]._getDescIt(t,e+1);o in this.children&&(yield*this.children[o]._getDescIt(t,e+1))}else t[e]in this.children&&(yield*this.children[t[e]]._getDescIt(t,e+1)),o in this.children&&(yield*this.children[o]._getDescIt(t,e+1))}*getAnscIt(t){yield*this._getAnscIt(t,0)}*_getAnscIt(t,e){if(e>=t.length)for(let t of this.data)yield t;else{if(void 0===t[e]){for(let s in this.children)yield*this.children[s]._getAnscIt(t,e+1);o in this.children&&(yield*this.children[o]._getAnscIt(t,e+1))}else t[e]in this.children&&(yield*this.children[t[e]]._getAnscIt(t,e+1)),o in this.children&&(yield*this.children[o]._getAnscIt(t,e+1));for(let t of this.data)yield t}}}const o=Symbol("ANY");class a{constructor(){this._listeners={},this._subscribers={},this._descriptors=new h,this._messageQueue=new s,this._processImmediately=!1,this._currentlyProcessing=!1}get processImmediately(){return this._processImmediately}set processImmediately(t){this._processImmediately=!!t,this._processImmediately&&this.processMessages()}subscribe(e,s,i,n){e in this._subscribers||(this._subscribers[e]=new h);let r=t.generateId("SystemMessageBoard");this._subscribers[e].add(s,r);let o={name:e,handler:i,source:n};this._listeners[r]=o,this._descriptors.add(s,r)}unsubscribe(t,e){if(t in this._subscribers){for(let s of this._subscribers[t].getDescIt(e))this._descriptors.delete(e,s),delete this._listeners[s];this._subscribers[t].delete(e),0===this._subscribers[t].size&&delete this._subscribers[t]}}unsubscribeAll(t){this.unsubscribe(t,[])}post(t,e,s,i){this._messageQueue.enqueue([t,e,s,i]),this.processImmediately&&this.processMessages()}processMessages(){if(!this._currentlyProcessing){for(this._currentlyProcessing=!0;this._messageQueue.size>0;){let[t,e,s,i]=this._messageQueue.dequeue(1);for(let n of this._descriptors.getAnscIt(e)){let{name:r,handler:h,source:o}=this._listeners[n];void 0!==i&&i!==r||(void 0!==o&&o!==t||h(s,e,t))}}this._currentlyProcessing=!1}}}class l{constructor(t){this._data=new Map,this._sortedKeys=[],this._comparator=t}has(t,e){return this._data.has(t)&&(void 0===e||this._data.get(t).has(e))}*getIt(t){if(this.has(t))for(let e of this._data.get(t))yield e}get(t){let e=new Set;for(let t of this.getIt())e.add(t);return val}*[Symbol.iterator](){for(let t of this._sortedKeys)for(let e of this._data.get(t))yield e}add(t,e){this._data.has(t)||(this._data.set(t,new Set),this._sortedKeys.push(t),this._sortedKeys.sort(this._comparator)),this._data.get(t).add(e)}delete(t,e){this._data.has(t)&&(this._data.get(t).delete(e),0===this._data.get(t).size&&(this._data.delete(t),this._sortedKeys.splice(this._sortedKeys.indexOf(t),1)))}}l.NumericComparator=(t,e)=>t-e;class d{constructor(t){this._engine=t,this._activeSystems=new l,this._systems={},this._systemPriorities={},this._messageBoard=new a,this._systemsToEnable=new Set,this._systemsToDisable=new Set,this._systemsToRemove=new Set}init(t){}postUpdateCleanup(){this._processEntityUpdates(),this._updateSystemStatuses()}_processEntityUpdates(){let t=this._engine.getEntityManager().requestEntityChanges();for(let e in this._systems){let s=this._systems[e];for(let e of t.added)s.check(e)&&s.add(e);for(let e of t.enabled)s.check(e)&&s.add(e);for(let e of t.changed)!s.has(e)&&s.check(e)?s.add(e):s.has(e)&&!s.check(e)&&s.remove(e);for(let e of t.disabled)s.has(e)&&s.remove(e);for(let e of t.deleted)s.has(e)&&s.remove(e)}this._engine.getEntityManager().markEntityChangesAsHandled()}_updateSystemStatuses(){for(let t of this._systemsToEnable)this._enableSystem(t);this._systemsToEnable.clear();for(let t of this._systemsToDisable)this._activeSystems.delete(this._systemPriorities[t.name],t),t.disable();this._systemsToDisable.clear();for(let t of this._systemsToRemove)this._removeSystem(t);this._systemsToRemove.clear()}_enableSystem(t){this._activeSystems.add(this._systemPriorities[t.name],t),t.enable()}_disableSystem(t){this._activeSystems.delete(this._systemPriorities[t.name],t),t.disable()}_removeSystem(t){t.active&&this._disableSystem(t),delete this._systems[t.name],delete this._systemPriorities[t.name],t.destroy()}getEngine(){return this._engine}*[Symbol.iterator](){for(let t of this._activeSystems)yield t}addSystem(t,e,s){if(t.name in this._systems)throw new Error("Two systems with the same cannot be added at the same time. Name: ",t.name);e=e||0,this._systems[t.name]=t,this._systemPriorities[t.name]=e,s?this._systemsToEnable.add(t):this._enableSystem(t);let i=this.getEngine().getEntityManager();for(let e of i.entities)t.check(e)&&t.add(e);t.init(this)}removeSystem(t,e){if(t in this._systems){let s=this._systems[t];e?this._systemsToRemove.add(s):this._removeSystem(s)}}enableSystem(t,e){if(!(t in this._systems))return!1;let s=this._systems[t];return e?this._systemsToEnable.add(s):this._enableSystem(s),!0}disableSystem(t,e){if(t in this._systems){let s=this._systems[t];return e?this._systemsToDisable.add(s):this._disableSystem(s),!0}return!1}getMessageBoard(){return this._messageBoard}}class u{constructor(t){this._initialized=!1,this._entityManager=new n(this),this._systemManager=new d(this),this._modules={},this._millisecPerUpdate=1e3,this._intervalKey=void 0,this._delta=0}getEntityManager(){return this._entityManager}getSystemManager(){return this._systemManager}get modules(){return this._modules}setModule(t,e){this.modules[t]=e}getModule(t){return this.modules[t]}applyModuleConfig(t){for(let e in this._modules)this.modules[e].init(t)}get running(){return void 0!==this._intervalKey}startLoop(t){void 0!==t&&(this._millisecPerUpdate=t),this._intervalKey=setInterval(()=>{this.update()},this._millisecPerUpdate)}pauseLoop(){clearInterval(this._intervalKey),this._intervalKey=void 0}update(){this._systemManager.getMessageBoard().processMessages();for(let t of this._systemManager)t.preUpdate();this._systemManager.getMessageBoard().processMessages();for(let t of this._systemManager)t.update();this._systemManager.getMessageBoard().processMessages();for(let t of this._systemManager)t.postUpdate();this._systemManager.getMessageBoard().processMessages(),this.getEntityManager().postUpdateCleanup(),this.getSystemManager().postUpdateCleanup()}}class c{constructor(){if(this.constructor===c)throw new TypeError("Components cannot be instantiated directly!")}get type(){return this.constructor.type}}class _ extends c{constructor(t,e,s){super(),this.spriteNameList=t||[],this.styleNameList=e||[],this.relativePositionList=s||[],this.visible=!0,this.dataIsLocal=!1}}_.type="AsciiRender";class p extends c{constructor(){super(),this._name=void 0,this._spriteNameList={},this._styleNameList={},this._relativePositionList={},this.visible=!0,this.dataIsLocal=!1}get currentFrame(){return this._name}get spriteNameList(){return this._spriteNameList[this.currentFrame]}get styleNameList(){return this._styleNameList[this.currentFrame]}get relativePositionList(){return this._relativePositionList[this.currentFrame]}addFrame(t,e,s,i){console.assert(e.length===s.length&&e.length===i.length,"AsciiAnimateComponent inputs must be of the same length"),void 0===this._name&&(this._name=t),this._spriteNameList[t]=e,this._styleNameList[t]=s,this._relativePositionList[t]=i}setFrame(t){t in this._spriteNameList&&(this._name=t)}}p.type="AsciiAnimate";class g extends c{constructor(t,e,s){super(),this.x=t||0,this.y=e||0,this.z=s||0}}g.type="PositionComponent";class m{constructor(t){this.specs=t}construct(){let t=new p;for(let e in this.specs)t.addFrame(e,[...this.specs[e].spriteNameList],[...this.specs[e].styleNameList],[...this.specs[e].relativePositionList]);return t}}const y={AsciiRender:_,AsciiAnimate:p,Position:g,AsciiAnimateFactory:m};Object.freeze(y);class f extends r{constructor(t){if(super(t),this.constructor===f)throw new TypeError("SetSystem cannot be instantiated directly!");this.entities=new Set}has(t){return this.entities.has(t)}add(t){this.entities.add(t)}remove(t){this.entities.delete(t)}}const b={Graphics:Symbol("GraphicsLibrary"),Resources:Symbol("ResourceManager"),KeyboardInput:Symbol("KeyboardInput")};class v extends f{constructor(t){super(t||"AsciiRender"),this._asciiGl=null}startup(){this._asciiGl=this.getEngine().getModule(b.Graphics)}check(t){return(t.hasComponent(_.type)||t.hasComponent(p.type))&&t.hasComponent(g.type)}postUpdate(){let t=this.getEngine().getModule(b.Resources);for(let e of this.entities){let s=e.getComponent(_.type)||e.getComponent(p.type);if(!s.visible)continue;let i=this.getEntityAbsolutePosition(e);for(let n=0;n<s.spriteNameList.length;n++){let r,h;s.dataIsLocal?(r=s.spriteNameList[n],h=s.styleNameList[n]):(r=t.get(s.spriteNameList[n]),h=t.get(s.styleNameList[n]));let o=[i[0]+s.relativePositionList[n][0],i[1]+s.relativePositionList[n][1],i[2]+s.relativePositionList[n][2]];this._asciiGl.draw(r,o,h,e.id)}}this._asciiGl.render()}getEntityAbsolutePosition(t){let e=[0,0,0];for(;t;){if(t.hasComponent(g.type)){let s=t.getComponent(g.type);e[0]+=s.x,e[1]+=s.y,e[2]+=s.z}t=t.getParent()}return e}}v.type="AsciiRenderSystem";const E={Set:f,Map:class extends r{constructor(t){super(t),this.entities={}}has(t){return t.id in this.entities}add(t){this.entities[t.id]=t}remove(t){delete this.entities[t.id]}},AsciiRender:v,AsciiInputHandler:class extends r{constructor(t){super(t||"AsciiInputHandler"),this._mouseEventsEnabled=!1,this._keyboardEventsEnabled=!1,this._focusedElement=void 0,this._focusableEntityOwners={}}startup(){let t=this.getEngine().getModule(b.Graphics);void 0!==t&&(t.setHandler(this._mouseEventHandler.bind(this)),this._mouseEventsEnabled=!0);let e=this.getEngine().getModule(b.KeyboardInput);void 0!==e&&(e.addEventListener(this._keyboardEventHandler.bind(this)),this._keyboardEventsEnabled=!0),this.mouseEventsEnabled&&this.keyboardEventsEnabled&&(this.subscribe(["InputHandlerRequest","AddFocusable"],this._handleAddFocusable,!0),this.subscribe(["InputHandlerRequest","RemoveFocusable"],this._handleRemoveFocusable,!0),this.subscribe(["InputHandlerRequest","SetFocusRequest"],this._handleSetFocusRequest,!0),this.subscribe(["InputHandlerRequest","ReleaseFocus"],this._handleReleaseFocus,!0))}get mouseEventsEnabled(){return this._mouseEventsEnabled}get keyboardEventsEnabled(){return this._keyboardEventsEnabled}_mouseEventHandler(t,e,s,i){this.postMessage(["MouseEvent",s||"",e],{event:t,coords:i}),"click"===e&&this._switchFocus(s,i)}_keyboardEventHandler(t,e,s){let i=void 0!==this._focusedElement?this._focusedElement:"",n=void 0;if(1===e.length){let s=e.charCodeAt(0);n=s>=48&&s<=57?["KeyboardEvent",i,t,"Visible","Numeric",e]:s>=65&&s<=90?["KeyboardEvent",i,t,"Visible","Alphabetical","Upper",e]:s>=97&&s<=122?["KeyboardEvent",i,t,"Visible","Alphabetical","Lower",e]:["KeyboardEvent",i,t,"Visible","Symbol",e]}else n=e.startsWith("Arrow")?["KeyboardEvent",i,t,"Arrow",e]:["KeyboardEvent",i,t,e];let r={event:s};void 0!==this._focusedElement?(r.targetEntity=this._focusedElement,this.postMessage(n,r,this._focusableEntityOwners[this._focusedElement])):this.postMessage(n,r)}_handleAddFocusable(t,e,s){t in this._focusableEntityOwners||(this._focusableEntityOwners[t]=s)}_handleRemoveFocusable(t){t in this._focusableEntityOwners&&(this._focusedElement===t&&this._switchFocus(),delete this._focusableEntityOwners[t])}_handleSetFocusRequest(t){t in this._focusableEntityOwners&&this._switchFocus(t)}_handleReleaseFocus(t){void 0!==this._focusedElement&&this._focusedElement===t&&this._switchFocus()}_switchFocus(t,e){let s=this._focusedElement;void 0!==s&&s!==t&&(this.postMessage(["InputHandlerFocusEvent",s,"FocusLost"],{entityId:s},this._focusableEntityOwners[s]),this._focusedElement=void 0),void 0!==t&&s!==t&&(this._focusedElement=t,this.postMessage(["InputHandlerFocusEvent",t,"FocusSet"],{entityId:t,coords:e},this._focusableEntityOwners[t]))}}};Object.freeze(E);class S{constructor(){this.handlers=new Set;for(let t in S.EventTypes){let e=S.EventTypes[t];document.addEventListener(e,t=>{if(document.activeElement===document.body||null===document.activeElement){for(let s of this.handlers)s(e,t.key,t);(t.keyCode<=40&&t.keyCode>=37||32===t.keyCode)&&t.preventDefault()}})}}addEventListener(t){this.handlers.add(t)}removeEventListener(t){this.handlers.delete(t)}}S.EventTypes={KEY_DOWN:"keydown",KEY_UP:"keyup"};class w{constructor(){this.channelSubscribers={},this.subscriptions={},this.receivers={},this.channelQueue=new s,this.messageQueue=new s}getAllChannels(){return Object.keys(this.channelSubscribers)}getSubscriptions(t){if(t in this.subscriptions)return this.subscriptions[t];console.warn("Id ",t," not found in messageBoard")}getSubscribers(t){if(id in this.channelSubscribers)return this.channelSubscribers[id];console.warn("Id ",id," not found in messageBoard")}signup(t,e){t in this.receivers?console.warn("Id ",t," is already signed up."):(this.receivers[t]=e,this.subscriptions[t]=new Set)}subscribe(t,e){if(t in this.receivers)for(let s of e)s in this.channelSubscribers||(this.channelSubscribers[s]=new Set),t in this.channelSubscribers[s]||(this.channelSubscribers[s].add(t),this.subscriptions[t].add(s));else console.error("Id ",t," does not have a receiver but is signing up for messages.")}unsubscribe(t,e){if(t in this.subscriptions)for(let s of e)s in this.channelSubscribers?(t in this.channelSubscribers[s]||console.warn("State id: ",t," does not appear in the messageBoard list ",s),this.channelSubscribers[s].delete(t),0===this.channelSubscribers[s].size&&delete this.channelSubscribers[s],this.subscriptions[t].delete(s)):console.error("Channel ",s," does not belong the messageBoard");else console.warn("Channel: ",t," does not appear in the message board")}withdraw(t){t in this.subscriptions||console.warn("Id: ",t," does not appear in the message board");for(let e of this.subscriptions[t])this.channelSubscribers[e].delete(t),0===this.channelSubscribers[e].size&&delete this.channelSubscribers[e];delete this.subscriptions[t],delete this.receivers[t]}post(t,e,s){if(e in this.channelSubscribers)for(let i of this.channelSubscribers[e])this.receivers[i].receiveMessage(t,e,s)}}class C{constructor(t,e){t=t||"",e=e||{},this._text=t,this._rowIndices=[],this._firstVisibleChar=[],this._width=0,this._height=1,this._segments=void 0,this._setAsBlank="",this._setAsBlankRegexp=null,this._spaceIsTransparent=!0,this._ignoreLeadingSpaces=!0,this._spaceHasFormatting=!1,"setAsBlank"in e&&(this._setAsBlank=e.setAsBlank),this._setAsBlankRegexp=new RegExp("["+this._setAsBlank+"]","g"),this._processedText=this._text.replace(this._setAsBlankRegexp," "),"spaceIsTransparent"in e&&(this._spaceIsTransparent=e.spaceIsTransparent),"ignoreLeadingSpaces"in e&&(this._ignoreLeadingSpaces=e.ignoreLeadingSpaces),"spaceHasFormatting"in e&&(this._spaceHasFormatting=e.spaceHasFormatting),this._parseSpriteShape(),this._parseSegmentData(),Object.freeze(this)}_parseSpriteShape(){let t=!1,e=0;for("\n"===this.text[0]&&(e=1),this._rowIndices.push(e),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:e);e<this.text.length;e++)"\n"===this.text[e]?(e-this._rowIndices[this._rowIndices.length-1]>this._width&&(this._width=Math.max(this._width,e-this._rowIndices[this._rowIndices.length-1])),this._rowIndices.push(e+1),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:e),t=!1):t||" "===this.text[e]||(t=!0,this._firstVisibleChar[this._firstVisibleChar.length-1]=e),e>1&&"\n"===this.text[e-1]&&this._height++;"\n"!==this.text.charAt(this.text.length-1)?(this._width=Math.max(this._width,this.text.length-this._rowIndices[this._rowIndices.length-1]),this._rowIndices.push(this.text.length+1)):this._rowIndices.push(this.text.length)}_parseSegmentData(){this._segments=new Array(this.height);for(let t=0;t<this.height;t++){this._segments[t]=[];let e=this._rowIndices[t],s=this._rowIndices[t+1]-1-e,i=this.ignoreLeadingSpaces?this._firstVisibleChar[t]-e:0,n=i,r=I.BLANK;for(;i<s;){let s=e+i,h=this.text[s],o=this._charState(h);o!==r&&(this._addSegment(n,i,t,r),n=i,r=o),i++}this._addSegment(n,i,t,r)}}_addSegment(t,e,s,i){i!==I.BLANK&&this._segments[s].push({x:t,y:s,length:e-t,visibleText:i===I.HAS_TEXT})}get text(){return this._text}get width(){return this._width}get height(){return this._height}get setAsBlank(){return this._setAsBlank}get spaceIsTransparent(){return this._spaceIsTransparent}get ignoreLeadingSpaces(){return this._ignoreLeadingSpaces}get spaceHasFormatting(){return this._spaceHasFormatting}*getItSpritePos(t,e,s,i){let n=Math.max(s,0),r=Math.min(i,this.height);if(!(s>=this.height||i<=0))for(let s=n;s<r;s++){if(void 0===this._firstVisibleChar[s])continue;let i=this._rowIndices[s],n=this._rowIndices[s+1]-1-i,r=this.ignoreLeadingSpaces?this._firstVisibleChar[s]-i:0;if(!(t>=n||e<=r))for(let i of this._segments[s]){let n=Math.max(i.x,t),r=Math.min(i.x+i.length,e);if(e<=n)break;r<=t||(yield{x:n,y:s,length:r-n,visibleText:i.visibleText})}}}*getItScreenPos(t,e,s,i,n,r){for(let h of this.getItSpritePos(s-t,s+n-t,i-e,i+r-e))h.x+=t,h.y+=e,yield h}_charHasFormatting(t){return" "!==t||!this.spaceIsTransparent||this.spaceHasFormatting}_charHasText(t){return" "!==t||!this.spaceIsTransparent}_charState(t){return this._charHasText(t)?I.HAS_TEXT:this._charHasFormatting(t)?I.HAS_FORMATTING:I.BLANK}segmentLengthAt(t,e){if(e<0||e>=this.height)return 0;if(t<0||t>=this.width)return 0;for(let s of this._segments[e])if(!(s.x+s.length<=t))return t<s.x?0:s.x+s.length-t;return 0}segmentAt(t,e,s){const i=this._rowIndices[e];let n=this.segmentLengthAt(t,e);return n=s&&s<n?s:n,this._processedText.substring(i+t,i+t+n)}}const I={BLANK:0,HAS_FORMATTING:1,HAS_TEXT:2};class M{constructor(){this._styles={};for(let t in M.defaultValues)this._styles[t]=null}freeze(){Object.freeze(this._styles),Object.freeze(this)}clear(){for(let t in M.defaultValues)this._styles[t]=null}copy(t){this.clear();for(let e of t)this.setStyle(e,t.getStyle(e))}sameAs(t){for(let e in M.defaultValues)if(this.hasStyle(e)!==t.hasStyle(e)||this.getStyle(e)!==t.getStyle(e))return!1;return!0}setStyle(t,e){t in M.defaultValues||console.warn("AsciiGL currently does not support the style",t),this._styles[t]=e||null}hasStyle(t){return null!==this._styles[t]}getStyle(t){return this.hasStyle(t)?this._styles[t]:""}*[Symbol.iterator](){for(let t in this._styles)this.hasStyle(t)&&(yield t)}fillRemainder(t){for(let e in M.defaultValues)this.hasStyle(e)||(t&&t.hasStyle(e)?this.setStyle(e,t.getStyle(e)):this.setStyle(e,M.defaultValues[e]))}}M.defaultValues={color:"black",backgroundColor:"transparent",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",cursor:"default"},M.setDefaultStyle=function(t,e){t in M.defaultValues?M.defaultValues[t]=e:console.warn("Style does not support",t)};class x{constructor(){this.primaryElement=document.createElement("pre"),this._width=0,this._height=0,this.activeRowLength=[],this.rows=[],this.elements=[],this.primaryElement.style.margin="0"}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++){let e=document.createElement("div");e.dataset.asciiGlRow=s,this.primaryElement.appendChild(e),this.rows.push(e),this.elements.push([]),this.activeRowLength.push(0);for(let e=0;e<t;e++)this.elements[s].push(new L)}}get width(){return this._width}get height(){return this._height}getDomElement(){return this.primaryElement}setRowLength(t,e){if(e<this.activeRowLength[t])for(let s=this.activeRowLength[t]-1;s>=e;s--)this.rows[t].removeChild(this.elements[t][s].getDomElement());else if(e>this.activeRowLength[t])for(let s=this.activeRowLength[t];s<e;s++)this.rows[t].appendChild(this.elements[t][s].getDomElement());this.activeRowLength[t]=e}bind(t){for(let e=0;e<this.height;e++){let s=0,i=0;for(;s<this.width;){let n=this.elements[e][i],r=t.getSegmentLengthAt(s,e),h=t.getSegmentAt(s,e),o=h.textId,a=void 0;a=void 0===o?" ".repeat(r):t.sprites[o].segmentAt(s-t.locations[o][0],e-t.locations[o][1],r),n.setText(a);let l=h.styles;for(let t in l)n.setStyle(t,l[t]);n.setId(h.frontId),i++,s+=r,n.applyChanges()}this.setRowLength(e,i)}}}class L{constructor(){this._domElement=document.createElement("span"),this._currText="",this._currStyles={},this._nextText="",this._nextStyles={},this._currId="",this._nextId=""}getDomElement(){return this._domElement}setText(t){this._nextText=t}setStyle(t,e){this._nextStyles[t]=e||""}setId(t){this._nextId=t}applyChanges(){let t=this._domElement;this._nextText!==this._currText&&(t.textContent=this._nextText),this._currText=this._nextText;for(let e in this._nextStyles){let s=this._nextStyles[e];s!==this._currStyles[e]&&(t.style[e]=s),this._currStyles[e]=s}this._nextId!==this._currId&&(void 0===this._nextId?delete t.dataset.asciiGlId:t.dataset.asciiGlId=this._nextId),this._currId=this._nextId}}class T{constructor(){this._width=0,this._height=0,this.rowComputedData=[],this.sprites={},this.locations={},this.backgroundStyle=new M,this.backgroundStyle.fillRemainder()}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++)this.rowComputedData.push(new A(s,t,this.backgroundStyle))}get width(){return this._width}get height(){return this._height}clear(){for(let t=0;t<this.height;t++)this.rowComputedData[t].clear();this.sprites={},this.locations={}}draw(t,e,s,i){for(let n of t.getItScreenPos(e[0],e[1],0,0,this.width,this.height)){let t=n.y;this.rowComputedData[t].loadSegment(n.length,n.x,s,e[2],i,n.visibleText)}this.sprites[i]=t,this.locations[i]=e}getSegmentLengthAt(t,e){return this.rowComputedData[e].getSegmentLengthAt(t)}getSegmentAt(t,e){return this.rowComputedData[e].getSegmentAt(t)}}class A{constructor(t,e,s){this._width=e,this._rowNumber=t,this._nextPointer=new Array(e),this._computedSegments=new Array(e);for(let t=0;t<this.width;t++)this._computedSegments[t]=new B(s),this._nextPointer[t]=-1;this._nextPointer[0]=this.width}clear(){for(let t=1;t<this.width;t++)this._nextPointer[t]=-1;this._computedSegments[0].clear(),this._nextPointer[0]=this.width}get row(){return this._rowNumber}get width(){return this._width}insertSegmentStart(t){if(-1===this._nextPointer[t]){this._computedSegments[t].clear();let e=t-1;for(;-1===this._nextPointer[e];)e--;this._nextPointer[t]=this._nextPointer[e],this._nextPointer[e]=t,this._computedSegments[t].copy(this._computedSegments[e])}}loadSegment(t,e,s,i,n,r){let h=e+t;this.insertSegmentStart(e),this.insertSegmentStart(h);let o=e;do{this._computedSegments[o].addStyle(n,r,s,i),o=this._nextPointer[o]}while(o<this.width&&o<h)}getSegmentLengthAt(t){let e=t;for(;-1===this._nextPointer[e];)e--;return this._nextPointer[e]-t}getSegmentAt(t){for(;-1===this._nextPointer[t];)t--;return this._computedSegments[t]}}class B{constructor(t){this._default=t,this._spriteId=void 0,this._spritePriority=void 0,this._styleValues={},this._stylePriorities={},this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=void 0,this.clear(),Object.seal(this),Object.seal(this._styleValues),Object.seal(this._stylePriorities)}copy(t){for(let e in M.defaultValues)this._styleValues[e]=t._styleValues[e],this._stylePriorities[e]=t._stylePriorities[e];this._spriteId=t._spriteId,this._spritePriority=t._spritePriority,this._highestPriority=t._highestPriority,this._frontId=t._frontId}clear(){for(let t in M.defaultValues)this._styleValues[t]=this._default.getStyle(t),this._stylePriorities[t]=Number.POSITIVE_INFINITY;this._spriteId=void 0,this._spritePriority=Number.POSITIVE_INFINITY,this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=void 0}get frontId(){return this._frontId}get textId(){return this._spriteId}get styles(){return this._styleValues}addStyle(t,e,s,i){for(let t of s)if(i<this._stylePriorities[t]){let e=s.getStyle(t);void 0!==e&&(this._styleValues[t]=e,this._stylePriorities[t]=i)}e&&i<this._spritePriority&&(this._spriteId=t,this._spritePriority=i),i<this._highestPriority&&(this._highestPriority=i,this._frontId=t)}}const k={MOUSE_ENTER_CANVAS:"mouseentercanvas",MOUSE_LEAVE_CANVAS:"mouseleavecanvas",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_MOVE:"mousemove",MOUSE_ENTER:"mouseenter",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",CLICK:"click",CONTEXT_MENU:"contextmenu"};Object.freeze(k);const P={Instance:class{constructor(t){console.assert(t,"AsciiGL constructor requires a valid HTML element id parameter.");let e=document.getElementById(t);for(console.assert(e,"AsciiGL constructor parameter containerId does not correspond to a valid HTML element."),console.assert("DIV"===e.tagName,"Container element must be a DIV");e.lastChild;)e.removeChild(e.lastChild);e.style.textAlign="center";let s=document.createElement("DIV");s.style.display="inline-block",s.style.fontFamily="Courier New",s.style.fontSize="1em",s.style.userSelect="none",s.style.margin="0",e.appendChild(s),this._container=s,this._domBuffer=new x,this._nameBuffers=[{},{}],this._drawBufferIdx=0,this._activeBufferIdx=1,this._width=0,this._height=0,this._drawBuffer=new T,this._currMouseOver=void 0,this._currMouseDown=void 0,this._handler=()=>{}}init(t,e){console.assert(t>0&&e>0,"AsciiGL must have positive dimensions."),this._width=t,this._height=e,this._drawBuffer.init(t,e),this._domBuffer.init(t,e),this._nameBuffers[0]={},this._nameBuffers[1]={},this._container.appendChild(this._domBuffer.getDomElement()),this._setupEventListeners(),this.render()}_setupEventListeners(){this._container.addEventListener("mouseenter",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mouseentercanvas",void 0,e);let s=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId];this._currMouseOver=s,s&&this._handler(t,"mouseenter",this._currMouseOver,e)}),this._container.addEventListener("mouseleave",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver,e),this._currMouseDown&&(this._currMouseDown=void 0),this._currMouseOver=void 0,this._handler(t,"mouseleavecanvas",void 0,e)}),this._container.addEventListener("mousemove",t=>{let e=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],s=this.mousePositionToCoordinates(t.clientX,t.clientY);e!==this._currMouseOver&&(this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver,s),this._currMouseOver=e,e&&this._handler(t,"mouseenter",this._currMouseOver,s)),this._handler(t,"mousemove",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],s)}),this._container.addEventListener("mousedown",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._currMouseDown=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId]||void 0,this._handler(t,"mousedown",this._currMouseDown,e)}),this._container.addEventListener("mouseup",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mouseup",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)}),this._container.addEventListener("click",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY),s=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId];void 0!==this._currMouseDown&&s!==this._currMouseDown&&(this._currMouseDown=void 0),this._handler(t,"click",this._currMouseDown,e),this._currMouseDown=void 0}),this._container.addEventListener("contextmenu",t=>{t.preventDefault();let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"contextmenu",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)})}mousePositionToCoordinates(t,e){let s=this._container.getBoundingClientRect();return{x:Math.floor((t-s.x)*this.width/s.width),y:Math.floor((e-s.y)*this.height/s.height)}}_flipBuffers(){this._drawBufferIdx=1-this._drawBufferIdx,this._activeBufferIdx=1-this._activeBufferIdx}get width(){return this._width}get height(){return this._height}get backgroundStyles(){return this._drawBuffer.backgroundStyle}getBackgroundStyle(t){return this._drawBuffer.backgroundStyle.getStyle(t)}setBackgroundStyle(t,e){this._drawBuffer.backgroundStyle.setStyle(t,e)}setHandler(t){this._handler=t}draw(e,s,i,n){let r=t.generateId(n);this._drawBuffer.draw(e,s,i,r),n&&(this._nameBuffers[this._drawBufferIdx][r]=n)}render(){this._domBuffer.bind(this._drawBuffer),this._drawBuffer.clear(),this._nameBuffers[this._activeBufferIdx]={},this._flipBuffers()}},Sprite:C,Style:M,SpriteBuilder:class{constructor(t){this._template=t,this._paramCount=t.length-1}construct(t){let e="";for(let s=0;s<this._template.length;s++)e+=this._template[s],s<this._paramCount&&(e+=t[s]);return new C(e)}},EventTypes:k};Object.freeze(P);class F{constructor(t){this.GLOBAL=F.Global,this._agl=t,this._registeredTargets={},this._messageBoards={};for(let t in P.EventTypes)this._messageBoards[P.EventTypes[t]]=new w;t.setHandler((t,e,s,i)=>{void 0!==s&&this._messageBoards[e].post(e,s,{type:e,target:s,event:t,coords:i}),this._messageBoards[e].post(e,this.GLOBAL,{type:e,target:s,event:t,coords:i})})}signup(t,e){for(let s in this._messageBoards)this._messageBoards[s].signup(t,e)}withdraw(t){for(let e in this._messageBoards)this._messageBoards[e].withdraw(t)}subscribe(t,e,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].subscribe(t,[e]):console.warn("Message type",i,"not supported")}unsubscribe(t,e,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].unsubscribe(t,[e]):console.warn("Message type",i,"not supported")}}F.Global=Symbol("Global");const D={loadFileAsString:async function(t){return await async function(t){return new Promise((function(e,s){let i=new XMLHttpRequest;i.open("GET",t),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){let t=i.responseText;e(t)}else console.error("HTTP Request returned status code: ",i.status)},i.send()}))}(t)}};Object.freeze(D);const O={getSpriteDataFromString:function(t){let e=JSON.parse(t);O.getSpriteDataFromJson(e)},getSpriteDataFromJson:function(t){let e=t.sprites,s={};for(let t in e)s[t]=new C(e[t].text,e[t].settings);let i=t.styles,n={};for(let t in i){let e=new M;for(let s in i[t])e.setStyle(s,i[t][s]);n[t]=e}return{sprites:s,styles:n}},getComponentFactoriesFromString:function(t){let e=JSON.parse(t);O.getComponentFactoriesFromJson(e)},getComponentFactoriesFromJson:function(t){let e={};for(let s in t){let i=t[s];e[s]=new m(i)}return e}};Object.freeze(O);const N={KeyboardInput:S,AsciiMouseInput:F,ResourceManager:class{constructor(){this.data={}}add(t,e){this.data[t]=e}delete(t){this.has(t)&&delete this.data[t]}has(t){return t in this.data}get(t){return t in this.data||console.warn("Resource key: ",t,"not found"),this.data[t]}async loadSpriteFiles(t){for(let e of t){let t=await D.loadFileAsString(e);this.loadSpriteFileJson(JSON.parse(t))}}loadSpriteFileJson(t){let e=O.getSpriteDataFromJson(t);for(let t in e.sprites)this.add(t,e.sprites[t]);for(let t in e.styles)this.add(t,e.styles[t])}async loadTemplateFiles(t){for(let e of t){let t=await D.loadFileAsString(e);this.loadTemplateJson(JSON.parse(t))}}loadTemplateJson(t){let e=O.getComponentFactoriesFromJson(t);for(let t in e)this.add(t,e[t])}}};Object.freeze(N);const R={Parser:O,AssetLoader:D,MessageBoard:w,MessageReceiver:class{constructor(t){this.sourceQueue=new s,this.tagQueue=new s,this.messageQueue=new s,this.callback=t}receiveMessage(t,e,s){this.sourceQueue.enqueue(t),this.tagQueue.enqueue(e),this.messageQueue.enqueue(s)}handle(){let t=this.sourceQueue.dequeue(),e=this.tagQueue.dequeue(),s=this.messageQueue.dequeue();this.callback(t,e,s)}handleAll(){for(;this.tagQueue.size>0;)this.handle()}}};Object.freeze(R);class z extends c{constructor(){super(),this.dataIsLocal=!0,this.sprite=new C(""),this.textColor=void 0,this.backgroundColor=void 0,this.hoverColor=void 0,this.activeColor=void 0,this.templateKey=void 0,this.defaultFrame=void 0,this.hoverFrame=void 0,this.activeFrame=void 0}}z.type="AsciiButton";class H extends c{constructor(){super(),this.width=0,this.height=1,this.initialText="",this._currentText="",this.textColor=void 0,this.backgroundColor=void 0,this.focusedColor=void 0,this.cursorColor=void 0,this.editable=!1,this.maxLength=0}get currentText(){return this._currentText}}H.type="AsciiInputField";class q extends c{constructor(){super(),this.text="",this.width=0,this.height=1,this.textColor=void 0,this.backgroundColor=void 0}}q.type="TextBox";class K extends c{constructor(){super(),this.mouseState=K.MouseStates.Default,this.dataIsLocal=!0,this.defaultFrame=K.MouseStates.Default,this.hoverFrame=K.MouseStates.Hover,this.activeFrame=K.MouseStates.Active}get frameName(){switch(this.mouseState){case K.MouseStates.Default:return this.defaultFrame;case K.MouseStates.Hover:return this.hoverFrame;case K.MouseStates.Active:return this.activeFrame}}}K.type="AsciiButtonInternal",K.MouseStates={Default:"Default",Hover:"Hover",Active:"Active"};class V extends c{constructor(t){super(),this.width=t.width,this.height=t.height,this.defaultStyle=void 0,this.focusedStyle=void 0,this.cursorStyle=void 0,this.multiLine=!1,this.lines=[],this.data="",this.changed=!0,this.viewX=0,this.viewY=0,this.cursorX=0,this.cursorY=0,this.multiLine?this.initRows(t.initialText):this.data=t.initialText.replace("\n"," ")}initRows(e){let s=e.split("\n");for(let e=0;e<s.length;e++)this.rows.push(t.breakLineIntoRows(s[e],this.width));this.changed=!0}getDisplayString(){if(this.multiLine)return this.lines.slice(this.viewY,this.viewY+this.height).map(t=>{let e=t.join(" ").substr(this.viewX,this.width);return e.length<this.width&&(e+=" ".repeat(this.width-e.length)),e}).join("\n");let t=this.data.substr(this.viewX,this.width);return t+" ".repeat(this.width-t.length)}getTextString(){return this.multiLine?this.lines.map(t=>t.join(" ")).join("\n"):this.data}handleCharacterInput(e){this.multiLine||(this.data=t.stringSplice(this.data,this.cursorX,0,e.event.key),this.shiftCursor(1,0),this.changed=!0)}handleArrowInput(t,e){this.multiLine||("ArrowLeft"===t.event.key?(this.shiftCursor(-1,0),this.changed=!0):"ArrowRight"===t.event.key&&(this.shiftCursor(1,0),this.changed=!0))}handleBackspaceInput(){this.multiLine||this.cursorX>0&&(this.shiftCursor(-1,0),this.viewX===this.cursorX&&this.viewX>0&&this.viewX--,this.data=t.stringSplice(this.data,this.cursorX,1),this.changed=!0)}handleEnterInput(){this.multiLine}handleDeleteInput(){this.multiLine||this.cursorX<this.data.length&&(this.data=t.stringSplice(this.data,this.cursorX,1),this.changed=!0)}shiftCursor(t,e){this.multiLine||(this.cursorX=Math.max(0,Math.min(this.data.length,this.cursorX+t)),this.cursorX<this.viewX?this.viewX=this.cursorX:this.cursorX>=this.viewX+this.width&&(this.viewX=this.cursorX-this.width+1))}placeCursor(t,e){this.multiLine||(this.cursorX=this.viewX+Math.max(0,Math.min(this.data.length,t)),this.cursorY=0)}}V.type="AsciiInputFieldInternal";class X extends c{constructor(){super(),this.screenX=void 0,this.screenY=void 0,this.fieldX=void 0,this.fieldY=void 0,this.placedEntityKey=void 0}}X.type="TextFieldCursor";class G extends c{constructor(){super()}}G.type="TextBoxInternal";const U={Components:{Button:z,InputField:H,TextBox:q},Systems:{Button:class extends r{constructor(){super("Buttons"),this._handleMouseClick=this._handleMouseClick.bind(this),this._handleMouseEnter=this._handleMouseEnter.bind(this),this._handleMouseLeave=this._handleMouseLeave.bind(this),this._handleMouseDown=this._handleMouseDown.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this.buttonEntities={},this.buttonSubentities={},this.childMap={},this.defaultTextColor="#222222",this.defaultBackgroundColor="#dddddd",this.defaultHoverColor="#bbbbbb",this.defaultActiveColor="#aaaaaa"}check(t){return t.hasComponent(z.type)||t.hasComponent(K.type)}has(t){return t.id in this.buttonEntities||t.id in this.buttonSubentities}add(t){t.hasComponent(z.type)?(this.buttonEntities[t.id]=t,this._constructButtonSubentities(t)):t.hasComponent(K.type)&&(this.buttonSubentities[t.id]=t,this.childMap[t.getParent().id]=t.id)}remove(t){t.id in this.buttonEntities?(this._deconstructButtonSubentities(t),this.childMap[t.id]in this.buttonSubentities&&this.getEntityManager().requestDeleteEntity(this.buttonSubentities[this.childMap[t.id]]),delete this.childMap[t.id],delete this.buttonEntities[t.id]):t.id in this.buttonSubentities&&delete this.buttonSubentities[t.id]}postUpdate(){for(let t in this.buttonSubentities){let e=this.buttonSubentities[t],s=e.getComponent(p.type),i=e.getComponent(K.type);s.setFrame(i.frameName)}}_constructButtonSubentities(t){let s=t.getComponent(z.type),i=new e(t.id),n=new g(0,0,0);if(i.setComponent(n),s.dataIsLocal)this._setupButtonAnimateComponent(i,s);else{let t=this.getEngine().getModule(b.Resources).get(s.templateKey).construct();i.setComponent(t)}let r=new K;r.dataIsLocal=s.dataIsLocal,r.dataIsLocal||(r.defaultFrame=s.defaultFrame,r.hoverFrame=s.hoverFrame,r.activeFrame=s.activeFrame),i.setComponent(r),this.subscribe(["MouseEvent",i.id,"click"],this._handleMouseClick,!1),this.subscribe(["MouseEvent",i.id,"mouseenter"],this._handleMouseEnter,!1),this.subscribe(["MouseEvent",i.id,"mouseleave"],this._handleMouseLeave,!1),this.subscribe(["MouseEvent",i.id,"mousedown"],this._handleMouseDown,!1),this.subscribe(["MouseEvent",i.id,"mouseup"],this._handleMouseUp,!1),t.addChild(i)}_setupButtonAnimateComponent(t,e){let s=new p;s.dataIsLocal=!0;let i=e.textColor||this.defaultTextColor,n=new M;n.setStyle("cursor","pointer"),n.setStyle("color",i);let r=e.backgroundColor||this.defaultBackgroundColor;n.setStyle("backgroundColor",r),s.addFrame(K.MouseStates.Default,[e.sprite],[n],[[0,0,0]]);let h=new M;h.setStyle("cursor","pointer"),h.setStyle("color",i);let o=e.hoverColor||this.defaultHoverColor;h.setStyle("backgroundColor",o),s.addFrame(K.MouseStates.Hover,[e.sprite],[h],[[0,0,0]]);let a=new M;a.setStyle("cursor","pointer"),a.setStyle("color",i);let l=e.activeColor||this.defaultActiveColor;a.setStyle("backgroundColor",l),s.addFrame(K.MouseStates.Active,[e.sprite],[a],[[0,0,0]]),t.setComponent(s)}_deconstructButtonSubentities(t){let e=this.childMap[t.id];this.unsubscribe(["MouseEvent",e,"click"]),this.unsubscribe(["MouseEvent",e,"mouseenter"]),this.unsubscribe(["MouseEvent",e,"mouseleave"]),this.unsubscribe(["MouseEvent",e,"mousedown"]),this.unsubscribe(["MouseEvent",e,"mouseup"])}_handleMouseClick(t,e){let s=this.buttonSubentities[e[1]].getParent().id;this.postMessage(["AsciiButtonElement",s,"click"])}_handleMouseEnter(t,e){let s=e[1],i=this.buttonSubentities[s],n=i.getParent().id;this.postMessage(["AsciiButtonElement",n,"mouseenter"]),i.getComponent(K.type).mouseState=K.MouseStates.Hover}_handleMouseLeave(t,e){let s=e[1],i=this.buttonSubentities[s],n=i.getParent().id;this.postMessage(["AsciiButtonElement",n,"mouseleave"]),i.getComponent(K.type).mouseState=K.MouseStates.Default}_handleMouseDown(t,e){let s=e[1],i=this.buttonSubentities[s],n=i.getParent().id;this.postMessage(["AsciiButtonElement",n,"mousedown"]),i.getComponent(K.type).mouseState=K.MouseStates.Active}_handleMouseUp(t,e){let s=e[1],i=this.buttonSubentities[s],n=i.getParent().id;this.postMessage(["AsciiButtonElement",n,"mouseup"]),i.getComponent(K.type).mouseState=K.MouseStates.Hover}},InputField:class extends r{constructor(){super("InputFields"),this.parentEntities={},this.childEntities={},this.childMap={},this.defaultTextColor="#222222",this.defaultBackgroundColor="#dddddd",this.defaultFocusedColor="#bbbbbb",this.defaultCursorColor="#888888",this.cursorEntity=new e("AsciiCursor"),this.cursorComponent=new X,this.cursorEntity.setComponent(this.cursorComponent);let t=new g(0,0,0);this.cursorEntity.setComponent(t);let s=new M;s.setStyle("backgroundColor",this.defaultCursorColor);let i=new _([new C(" ",{ignoreLeadingSpaces:!1,spaceIsTransparent:!0,spaceHasFormatting:!0})],[s],[[0,0,0]]);i.visible=!1,i.dataIsLocal=!0,this.cursorEntity.setComponent(i),this._focusSet=this._focusSet.bind(this),this._focusLost=this._focusLost.bind(this),this._handleMouseClick=this._handleMouseClick.bind(this)}check(t){return t.hasComponent(H.type)||t.hasComponent(V.type)||t.hasComponent(X.type)&&t.id===this.cursorEntity.id}has(t){return t.id in this.parentEntities||t.id in this.childEntities}add(t){t.hasComponent(H.type)?(this.parentEntities[t.id]=t,this._constructChildEntity(t)):t.hasComponent(V.type)&&(this.childEntities[t.id]=t,this.childMap[t.getParent().id]=t.id)}remove(t){t.id in this.parentEntities?(this._deconstructChildEntity(t),this.childMap[t.id]in this.childEntities&&this.getEntityManager().requestDeleteEntity(this.childEntities[this.childMap[t.id]]),delete this.childMap[t.id],delete this.parentEntities[t.id]):t.id in this.childEntities&&delete this.childEntities[t.id]}startup(){this.getEntityManager().requestAddEntity(this.cursorEntity)}shutdown(){this.getEntityManager().requestDeleteEntity(this.cursorEntity)}postUpdate(){for(let t in this.childMap){let e=this.childMap[t],s=this.childEntities[e],i=this.parentEntities[t].getComponent(H.type),n=s.getComponent(V.type);if(!n.changed)continue;i._currentText=n.getTextString();let r=s.getComponent(_.type);r.spriteNameList[0]=new C(n.getDisplayString(),{ignoreLeadingSpaces:!1,spaceIsTransparent:!1});let h=n.defaultStyle;if(this.cursorComponent.placedEntityKey===e&&(h=n.focusedStyle),r.styleNameList[0]=h,this.cursorComponent.placedEntityKey!==s.id)continue;let o=this._getChildGlobalPositionComponent(e),a=o.x+n.cursorX-n.viewX,l=o.y+n.cursorY-n.viewY,d=this.cursorEntity.getComponent(g.type);d.x=a,d.y=l,n.changed=!1}}_constructChildEntity(t){let s=t.getComponent(H.type),i=new e(t.id),n=new g(0,0,0);i.setComponent(n);let r=new V(s);i.setComponent(r);let h=new C(r.getDisplayString(),{ignoreLeadingSpaces:!1,spaceIsTransparent:!1}),o=s.textColor||this.defaultTextColor,a=s.backgroundColor||this.defaultBackgroundColor,l=s.focusedColor||this.defaultFocusedColor,d=s.cursorColor||this.defaultCursorColor,u=new M;u.setStyle("cursor","text"),u.setStyle("color",o),u.setStyle("backgroundColor",a);let c=new M;c.setStyle("cursor","text"),c.setStyle("color",o),c.setStyle("backgroundColor",l);let p=new M;p.setStyle("backgroundColor",d),r.defaultStyle=u,r.focusedStyle=c,r.cursorStyle=p;let m=new _([h],[u],[[0,0,0]]);m.dataIsLocal=!0,i.setComponent(m),t.addChild(i),this.postMessage(["InputHandlerRequest","AddFocusable"],i.id),this.subscribe(["InputHandlerFocusEvent",i.id,"FocusSet"],this._focusSet),this.subscribe(["InputHandlerFocusEvent",i.id,"FocusLost"],this._focusLost),this.subscribe(["KeyboardEvent",i.id,"keydown","Visible"],r.handleCharacterInput.bind(r)),this.subscribe(["KeyboardEvent",i.id,"keydown","Arrow"],r.handleArrowInput.bind(r)),this.subscribe(["KeyboardEvent",i.id,"keydown","Enter"],this._handleEnterInput,!0),this.subscribe(["KeyboardEvent",i.id,"keydown","Backspace"],r.handleBackspaceInput.bind(r)),this.subscribe(["KeyboardEvent",i.id,"keydown","Delete"],r.handleDeleteInput.bind(r)),this.subscribe(["MouseEvent",i.id,"click"],this._handleMouseClick)}_deconstructChildEntity(t){let e=this.childMap[t.id];if(this.unsubscribe(["InputHandlerFocusEvent",e]),this.unsubscribe(["KeyboardEvent",e]),this.postMessage(["InputHandlerRequest","RemoveFocusable"],e),this.cursorComponent.placedEntityKey===e){this.cursorComponent.placedEntityKey=void 0,this.cursorEntity.getComponent(_.type).visible=!1}}_handleEnterInput(t,e){let s=e[1];if(!(s in this.childEntities))throw new Error("InputFieldSystem received a message for an internal entity that no longer exists in the system:",s);let i=this.childEntities[s],n=i.getComponent(V.type);if(n.handleEnterInput(),!n.multiLine){let t=i.getParent().id;this.postMessage(["InputFieldEvent",t,"submit"],{})}}_focusSet(t){let e=t.entityId;this.cursorComponent.placedEntityKey=e,this.cursorEntity.getComponent(_.type).visible=!0;let s=this.childEntities[e];this._placeCursor(t.coords,s),this._markChildEntityChanged(e)}_focusLost(){this._markChildEntityChanged(this.cursorComponent.placedEntityKey),this.cursorComponent.placedEntityKey=void 0,this.cursorEntity.getComponent(_.type).visible=!1}_handleMouseClick(t){if(this.cursorComponent.placedEntityKey){let e=this.childEntities[this.cursorComponent.placedEntityKey];this._placeCursor(t.coords,e),this._markChildEntityChanged(this.cursorComponent.placedEntityKey)}}_placeCursor(t,e){let s=e.getComponent(V.type),i=this._getChildGlobalPositionComponent(e.id);s.placeCursor(t.x-i.x,t.y-i.y)}_markChildEntityChanged(t){this.childEntities[t].getComponent(V.type).changed=!0}_getChildGlobalPositionComponent(t){return this.childEntities[t].getParent().getComponent(g.type)}},TextBox:class extends r{constructor(){super("TextBox"),this.parentEntities={},this.childEntities={},this.childMap={},this.defaultTextColor="#000000",this.defaultBackgroundColor="#ffffff"}check(t){return t.hasComponent(q.type)||t.hasComponent(G.type)}has(t){return t.id in this.parentEntities||t.id in this.childEntities}add(t){t.hasComponent(q.type)?(this.parentEntities[t.id]=t,this._constructChildEntity(t)):t.hasComponent(G.type)&&(this.childEntities[t.id]=t,this.childMap[t.getParent().id]=t.id)}remove(t){t.id in this.parentEntities?(this._deconstructChildEntity(t),this.childMap[t.id]in this.childEntities&&this.getEntityManager().requestDeleteEntity(this.childEntities[this.childMap[t.id]]),delete this.childMap[t.id],delete this.parentEntities[t.id]):t.id in this.childEntities&&delete this.childEntities[t.id]}_constructChildEntity(s){let i=s.getComponent(q.type),n=new e(s.id),r=new g(0,0,0);n.setComponent(r);let h=i.text.split("\n"),o=[];for(let e=0;e<h.length;e++){let s=t.breakLineIntoRows(h[e],i.width,!0);if(o.length+s.length>i.height&&(s=s.slice(0,i.height-o.length)),o.push(...s),o.length>=i.height)break}for(;o.length<i.height;)o.push(" ".repeat(i.width));let a=o.join("\n"),l=new C(a,{spaceIsTransparent:!1,ignoreLeadingSpaces:!1}),d=i.textColor||this.defaultTextColor,u=i.backgroundColor||this.defaultBackgroundColor,c=new M;c.setStyle("color",d),c.setStyle("backgroundColor",u);let p=new _([l],[c],[[0,0,0]]);p.dataIsLocal=!0,n.setComponent(p);let m=new G;n.setComponent(m),s.addChild(n)}_deconstructChildEntity(t){}}}},Y={Engine:u,Entity:e,Component:c,Components:y,System:r,Systems:E,Modules:N,ModuleSlots:b,GL:P,Gui:U};export default Y;export{c as Component,y as Components,u as Engine,e as Entity,P as GL,U as Gui,b as ModuleSlots,N as Modules,r as System,E as Systems};
