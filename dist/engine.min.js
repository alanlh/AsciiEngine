var AsciiEngine=function(){"use strict";const e={generateId:function(){let e=0;return function(t){return void 0===t&&(t="AsciiEngine"),e++,t+"_"+e}}(),clamp:function(e,t,s){return Math.max(t,Math.min(e,s))}};Object.freeze(e);class t{constructor(){this._storage=[],this._size=0,this._currIdx=0}enqueue(e){this._storage.push(e),this._size++}dequeue(e){let t=this.front;if(void 0===e&&(e=1),this.size<=e)this._storage=[],this._size=0,this._currIdx=0;else if(this.size-e<this._storage.length/2)this._storage=this._storage.slice(this._currIdx+e),this._currIdx=0,this._size-=e;else{let t=0;for(;t<e;)this._storage[this._currIdx]=void 0,this._size--,this._currIdx++,t++}return t}get front(){if(this._size>0)return this._storage[this._currIdx]}get back(){if(this._size>0)return this._storage[this._storage.length-1]}at(e){if(!(e>=this._size||e<0))return this._storage[this._currIdx+e]}get size(){return this._size}get empty(){return 0==this.size}}class s{constructor(e,t,...s){this.operation=e,this.target=t,this.args=s,Object.freeze(this)}}s.ADD_ENTITY=Symbol("AddEntity"),s.DELETE_ENTITY=Symbol("DeleteEntity"),s.SET_COMPONENT=Symbol("SetComponent"),s.DELETE_COMPONENT=Symbol("DeleteComponent"),s.ENABLE=Symbol("Enable"),s.DISABLE=Symbol("Disable");class i{constructor(e){this._engine=e,this._entities=[],this._entityOperations=new t,this._added=new Set,this._deleted=new Set,this._changed=new Set,this._enabled=new Set,this._disabled=new Set}init(e){}initEntity(e){e.init(this)}processEntityOperations(){for(;!this._entityOperations.empty;){let e=this._entityOperations.dequeue();this[e.operation](e.target,...e.args)}}requestEntityChanges(){return{added:this._added,deleted:this._deleted,changed:this._changed,enabled:this._enabled,disabled:this._disabled}}markEntityChangesAsHandled(){this._added.clear(),this._deleted.clear(),this._changed.clear(),this._enabled.clear(),this._disabled.clear()}requestAddEntity(e,t){this._entityOperations.enqueue(new s(s.ADD_ENTITY,e,t))}[s.ADD_ENTITY](e,t){t&&t._addChild(e),this.initEntity(e)}notifyAddition(e){this._added.add(e)}requestDeleteEntity(e){this._entityOperations.enqueue(new s(s.DELETE_ENTITY,e))}[s.DELETE_ENTITY](e){e.destroy()}notifyDeletion(e){this._deleted.add(e)}requestSetComponent(e,t){this._entityOperations.enqueue(new s(s.SET_COMPONENT,e,t))}[s.SET_COMPONENT](e,t){e._setComponent(t)}requestDeleteComponent(e,t){this._entityOperations.enqueue(new s(s.DELETE_COMPONENT,e,t))}[s.DELETE_COMPONENT](e,t){target._deleteComponent(t)}notifyComponentChange(e){this._changed.add(e)}requestEnable(e,t){this._entityOperations.enqueue(new s(s.ENABLE,e,t))}[s.ENABLE](e,t){e._enable(t)}notifyEnable(e){this._enabled.add(e)}requestDisable(e,t){this._entityOperations.enqueue(new s(s.DISABLE,e,t))}[s.DISABLE](e,t){entity._disable(t)}notifyDisable(e){this._disabled.add(e)}}class n{constructor(e){this.tagQueue=new t,this.messageQueue=new t,this.callback=e}receiveMessage(e,t){this.tagQueue.enqueue(e),this.messageQueue.enqueue(t)}handle(){let e=this.tagQueue.dequeue(),t=this.messageQueue.dequeue();this.callback(e,t)}handleAll(){for(;this.tagQueue.size>0;)this.handle()}}class r{constructor(e){this._engine=void 0,this._systemManager=void 0,this._entityManager=void 0,this._name=e,this._priority=0,this._active=!1,this._messageReceiver=new n(this.receiveMessage.bind(this))}get type(){return this.constructor.type}get name(){return this._name}init(e){this._systemManager=e,this._engine=e.engine,this._entityManager=this._engine.getEntityManager(),this.getSystemManager().getMessageBoard().signup(this.name,this.getMessageReceiver()),this._active=!0,this.startup()}destroy(){this.shutdown(),this.getSystemManager().getMessageBoard().withdraw(this.name)}getSystemManager(){return this._systemManager}getEngine(){return this._engine}getMessageReceiver(){return this._messageReceiver}enable(){this._active||(this._active=!0)}disable(){this._active&&(this._active=!1)}get active(){return this._active}startup(){}shutdown(){}check(e){return!1}hasEntity(e){}addEntity(e){}removeEntity(e){}preUpdate(){}update(){}postUpdate(){}receiveMessage(e,t){}}class a{constructor(){this.channelSubscribers={},this.subscriptions={},this.receivers={},this.channelQueue=new t,this.messageQueue=new t}getAllChannels(){return Object.keys(this.channelSubscribers)}getSubscriptions(e){if(e in this.subscriptions)return this.subscriptions[e];console.warn("Id ",e," not found in messageBoard")}getSubscribers(e){if(id in this.channelSubscribers)return this.channelSubscribers[id];console.warn("Id ",id," not found in messageBoard")}signup(e,t){e in this.receivers&&console.warn("Id ",e," is already signed up."),this.receivers[e]=t,this.subscriptions[e]=new Set}subscribe(e,t){e in this.receivers||console.error("Id ",e," does not have a receiver but is signing up for messages.");for(let s of t)s in this.channelSubscribers||(this.channelSubscribers[s]=new Set),e in this.channelSubscribers[s]||(this.channelSubscribers[s].add(e),this.subscriptions[e].add(s))}unsubscribe(e,t){e in this.subscriptions||console.warn("Channel: ",e," does not appear in the message board");for(let s of t)s in this.channelSubscribers?(e in this.channelSubscribers[s]||console.warn("State id: ",e," does not appear in the messageBoard list ",s),this.channelSubscribers[s].delete(e),0===this.channelSubscribers[s].size&&delete this.channelSubscribers[s],this.subscriptions[e].delete(s)):console.error("Channel ",s," does not belong the messageBoard")}withdraw(e){e in this.subscriptions||console.warn("Id: ",e," does not appear in the message board");for(let t of this.subscriptions[e])this.channelSubscribers[t].delete(e),0===this.channelSubscribers[t].size&&delete this.channelSubscribers[t];delete this.subscriptions[e],delete this.receivers[e]}post(e,t){if(e in this.channelSubscribers)for(let s of this.channelSubscribers[e])this.receivers[s].receiveMessage(e,t)}}class h{constructor(e){this._engine=e,this._systems={},this._messageBoard=new a}init(e){}processEntityOperations(){let e=this._engine.getEntityManager().requestEntityChanges();for(let t of this){for(let s of e.added)t.check(s)&&t.addEntity(s);for(let s of e.enabled)t.check(s)&&t.addEntity(s);for(let s of e.changed)!t.hasEntity(s)&&t.checkEntity(s)?t.addEntity(s):systm.hasEntity(s)&&!t.checkEntity(s)&&t.removeEntity(s);for(let s of e.disabled)t.hasEntity(s)&&t.removeEntity(s);for(let s of e.deleted)t.hasEntity(s)&&t.removeEntity(s)}this._engine.getEntityManager().markEntityChangesAsHandled()}get engine(){return this._engine}*[Symbol.iterator](){for(let e in this._systems){let t=this._systems[e];t.active&&(yield t)}}addSystem(e,t){this._systems[e.name]=e,e.init(this)}removeSystem(e,t){e in this._systems&&(this._systems[e].destroy(),delete this._systems[e])}enableSystem(e,t){return e in this._systems&&(this._systems[e].enable(),!0)}disableSystem(e,t){return e in this._systems&&(this._systems[e].disable(),!0)}getMessageBoard(){return this._messageBoard}}class o{constructor(e){this._initialized=!1,this._entityManager=new i(this),this._systemManager=new h(this),this._modules={},this._millisecPerUpdate=1e3,this._intervalKey=void 0,this._delta=0}getEntityManager(){return this._entityManager}getSystemManager(){return this._systemManager}get modules(){return this._modules}setModule(e,t){this.modules[e]=t}getModule(e){return this.modules[e]}applyModuleConfig(e){for(let t in this._modules)this.modules[t].init(e)}get running(){return void 0!==this._intervalKey}startLoop(e){void 0!==e&&(this._millisecPerUpdate=e),this._intervalKey=setInterval(()=>{this.update()},this._millisecPerUpdate)}pauseLoop(){clearInterval(this._intervalKey),this._intervalKey=void 0}update(){for(let e of this._systemManager)e.preUpdate();for(let e of this._systemManager)e.update();for(let e of this._systemManager)e.postUpdate();this.getEntityManager().processEntityOperations(),this.getSystemManager().processEntityOperations()}}o.ModuleSlots={Graphics:Symbol("GraphicsLibrary"),ResourceManager:Symbol("ResourceManager")},Object.freeze(o.Modules);class l{constructor(){if(this.constructor===l)throw new TypeError("Components cannot be instantiated directly!")}get type(){return this.constructor.type}}class d extends l{constructor(e,t,s){super(),this.spriteNameList=e||[],this.styleNameList=t||[],this.relativePositionList=s||[]}}d.type="AsciiRender";class c extends l{constructor(){super(),this._name=void 0,this._spriteNameList={},this._styleNameList={},this._relativePositionList={}}get currentFrame(){return this._name}get spriteNameList(){return this._spriteNameList[this.currentFrame]}get styleNameList(){return this._styleNameList[this.currentFrame]}get relativePositionList(){return this._relativePositionList[this.currentFrame]}addFrame(e,t,s,i){console.assert(t.length===s.length&&t.length===i.length,"AsciiAnimateComponent inputs must be of the same length"),void 0===this._name&&(this._name=e),this._spriteNameList[e]=t,this._styleNameList[e]=s,this._relativePositionList[e]=i}setFrame(e){e in this._spriteNameList&&(this._name=e)}}c.type=d.type;class u extends l{constructor(e,t,s){super(),this.x=e||0,this.y=t||0,this.z=s||0}}u.type="PositionComponent";const _={AsciiRender:d,AsciiAnimate:c,Position:u};Object.freeze(_);class g extends r{constructor(e){if(super(e),this.constructor===g)throw new TypeError("SetSystem cannot be instantiated directly!");this.entities=new Set}hasEntity(e){return this.entities.has(e)}addEntity(e){this.entities.add(e)}removeEntity(e){this.entities.delete(e)}}class m extends g{constructor(e){super(e),this._asciiGl=null}startup(){this._asciiGl=this.getEngine().getModule(o.ModuleSlots.Graphics)}check(e){return e.hasComponent(d.type)&&e.hasComponent(u.type)}postUpdate(){let e=this.getEngine().getModule(o.ModuleSlots.ResourceManager);for(let t of this.entities){let s=t.getComponent(d.type),i=this.getEntityAbsolutePosition(t);for(let n=0;n<s.spriteNameList.length;n++){let r=e.get(s.spriteNameList[n]),a=[i[0]+s.relativePositionList[n][0],i[1]+s.relativePositionList[n][1],i[2]+s.relativePositionList[n][2]],h=e.get(s.styleNameList[n]);this._asciiGl.draw(r,a,h,t.id)}}this._asciiGl.render()}getEntityAbsolutePosition(e){let t=[0,0,0];for(;e;){if(e.hasComponent(u.type)){let s=e.getComponent(u.type);t[0]+=s.x,t[1]+=s.y,t[2]+=s.z}e=e.getParent()}return t}}m.type="AsciiRenderSystem";const p={Set:g,Map:class extends r{constructor(e){super(e),this.entities={}}hasEntity(e){return e.id in this.entities}addEntity(e){this.entities[e.id]=e}removeEntity(e){delete this.entities[e.id]}},AsciiRender:m};Object.freeze(p);class y{constructor(){this._messageBoards={};for(let e in y.EventTypes){let t=y.EventTypes[e];this._messageBoards[t]=new a,document.addEventListener(t,e=>{this._messageBoards[t].post(e.key,e),this._messageBoards[t].post("",e)})}}signup(e,t){for(let s in this._messageBoards)this._messageBoards[s].signup(e,t)}withdraw(e){for(let t in this._messageBoards)this._messageBoards[t].withdraw(e,receiver)}subscribe(e,t,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].subscribe(e,[t]):console.warn("Keyboard event",i,"is not supported")}unsubscribe(e,t,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].unsubscribe(e,[t]):console.warn("Keyboard event",i,"is not supported")}}y.EventTypes={KEY_DOWN:"keydown",KEY_UP:"keyup"};class f{constructor(e,t){e=e||"",t=t||{},this._text=e,this._rowIndices=[],this._firstVisibleChar=[],this._width=0,this._height=1;let s=!1,i=0;for("\n"===e[0]&&(i=1),this._rowIndices.push(i);i<e.length;i++)"\n"===e[i]?(i-this._rowIndices[this._rowIndices.length-1]>this._width&&(this._width=Math.max(this._width,i-this._rowIndices[this._rowIndices.length-1])),this._rowIndices.push(i+1),s=!1):s||" "===e[i]||(s=!0,this._firstVisibleChar.push(i)),i>1&&"\n"===e[i-1]&&this._height++;"\n"!==e.charAt(e.length-1)?(this._width=Math.max(this._width,e.length-this._rowIndices[this._rowIndices.length-1]),this._rowIndices.push(e.length+1)):this._rowIndices.push(e.length),this._setAsBlank="",this._setAsBlankRegexp=null,this._spaceIsTransparent=!0,this._ignoreLeadingSpaces=!0,"setAsBlank"in t&&(this._setAsBlank=t.setAsBlank),this._setAsBlankRegexp=new RegExp("["+this._setAsBlank+"]","g"),"spaceIsTransparent"in t&&(this._spaceIsTransparent=t.spaceIsTransparent),"ignoreLeadingSpaces"in t&&(this._ignoreLeadingSpaces=t.ignoreLeadingSpaces),Object.freeze(this)}get text(){return this._text}get width(){return this._width}get height(){return this._height}get setAsBlank(){return this._setAsBlank}get spaceIsTransparent(){return this._spaceIsTransparent}get ignoreLeadingSpaces(){return this._ignoreLeadingSpaces}charAt(e,t){if(e<0||e>=this.width||t<0||t>=this.height)return"";let s=this._rowIndices[t];if(e+s+1>=this._rowIndices[t+1])return"";if(this.ignoreLeadingSpaces&&e+s<this._firstVisibleChar[t])return"";let i=this.text[s+e];return this.spaceIsTransparent&&" "===i?"":this.text[s+e]}segmentLengthAt(e,t){if(0===this.charAt(e,t).length)return 0;const s=this._rowIndices[t],i=s+e;for(;s+e+1<this._rowIndices[t+1];){e++;let t=this.text[s+e];if("\n"===t)break;if(" "===t&&this.spaceIsTransparent)break}return s+e-i}segmentAt(e,t,s){const i=this._rowIndices[t];let n=this.segmentLengthAt(e,t);return n=s&&s<n?s:n,this.text.substring(i+e,i+e+n).replace(this._setAsBlankRegexp," ")}}f.RENDER_LEVELS={};class b{constructor(){this._styles={};for(let e in b.defaultValues)this._styles[e]=null}freeze(){Object.freeze(this._styles),Object.freeze(this)}clear(){for(let e in b.defaultValues)this._styles[e]=null}copy(e){this.clear();for(let t of e)this.setStyle(t,e.getStyle(t))}sameAs(e){for(let t in b.defaultValues)if(this.hasStyle(t)!==e.hasStyle(t)||this.getStyle(t)!==e.getStyle(t))return!1;return!0}setStyle(e,t){e in b.defaultValues||console.warn("AsciiGL currently does not support the style",e),this._styles[e]=t||null}hasStyle(e){return null!==this._styles[e]}getStyle(e){return this.hasStyle(e)?this._styles[e]:""}*[Symbol.iterator](){for(let e in this._styles)this.hasStyle(e)&&(yield e)}fillRemainder(e){for(let t in b.defaultValues)this.hasStyle(t)||(e&&e.hasStyle(t)?this.setStyle(t,e.getStyle(t)):this.setStyle(t,b.defaultValues[t]))}}b.defaultValues={color:"black",backgroundColor:"transparent",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",cursor:"default"},b.setDefaultStyle=function(e,t){e in b.defaultValues?b.defaultValues[e]=t:console.warn("SpriteStyle does not support",e)};class S{constructor(){this.primaryElement=document.createElement("pre"),this._width=0,this._height=0,this.activeRowLength=[],this.rows=[],this.elements=[],this.primaryElement.style.margin="0"}init(e,t){this._width=e,this._height=t;for(let s=0;s<t;s++){let t=document.createElement("div");t.dataset.asciiGlRow=s,this.primaryElement.appendChild(t),this.rows.push(t),this.elements.push([]),this.activeRowLength.push(0);for(let t=0;t<e;t++)this.elements[s].push(document.createElement("span"))}}get width(){return this._width}get height(){return this._height}getDomElement(){return this.primaryElement}setRowLength(e,t){if(t<this.activeRowLength[e])for(let s=this.activeRowLength[e]-1;s>=t;s--)this.rows[e].removeChild(this.elements[e][s]);else if(t>this.activeRowLength[e])for(let s=this.activeRowLength[e];s<t;s++)this.rows[e].appendChild(this.elements[e][s]);this.activeRowLength[e]=t}bind(e){for(let t=0;t<this.height;t++){let s=0,i=0;for(;s<this.width;){let n=this.elements[t][i],r=e.getSegmentLengthAt(s,t),a=e.getStyleAt(s,t),h=a.front,o=null;o=null===h?" ".repeat(r):e.sprites[h].segmentAt(s-e.locations[h][0],t-e.locations[h][1],r),n.textContent=o,n.dataset.asciiGlId=h,a.completed||a.fillRemainder(e.backgroundStyle);for(let e of a)n.style[e]=a.getStyle(e);i++,s+=r}this.setRowLength(t,i)}}}class w{constructor(){this._width=0,this._height=0,this.computedStyles=[],this.sprites={},this.locations={},this.backgroundStyle=new b,this.backgroundStyle.fillRemainder()}init(e,t){this._width=e,this._height=t;for(let s=0;s<t;s++)this.computedStyles.push(new E(s,e))}get width(){return this._width}get height(){return this._height}clear(){for(let e=0;e<this.height;e++)this.computedStyles[e].clear();this.sprites={},this.locations={}}draw(e,t,s,i){let n=Math.max(t[0],0),r=Math.max(t[1],0),a=Math.min(t[0]+e.width,this.width),h=Math.min(t[1]+e.height,this.height);for(let o=r;o<h;o++){let r=n;for(;r<a;){let n=e.segmentLengthAt(r-t[0],o-t[1]);n>0?(this.computedStyles[o].loadSegment(n,r,s,t[2],i),r+=n):r++}}this.sprites[i]=e,this.locations[i]=t}getStyleAt(e,t){return this.computedStyles[t].getStyleAt(e)}getSegmentLengthAt(e,t){return this.computedStyles[t].getSegmentLengthAt(e)}}class E{constructor(e,t){this._width=t,this._rowNumber=e,this._computedStyles=new Array(t),this._nextPointer=new Array(t);for(let e=0;e<this.width;e++)this._computedStyles[e]=new v,this._nextPointer[e]=-1;this._nextPointer[0]=this.width}clear(){for(let e=1;e<this.width;e++)this._nextPointer[e]=-1;this._nextPointer[0]=this.width,this._computedStyles[0].clear()}get row(){return this._rowNumber}get width(){return this._width}insertSegmentStart(e){if(-1===this._nextPointer[e]){this._computedStyles[e].clear();let t=e-1;for(;-1===this._nextPointer[t];)t--;this._nextPointer[e]=this._nextPointer[t],this._nextPointer[t]=e,this._computedStyles[e].copy(this._computedStyles[t])}}loadSegment(e,t,s,i,n){let r=t+e;this.insertSegmentStart(t),this.insertSegmentStart(r),this._computedStyles[t].addStyle(s,i,n);let a=this._nextPointer[t];for(;a<this.width&&a<r;)this._computedStyles[a].addStyle(s,i,n),a=this._nextPointer[a]}getStyleAt(e){for(;-1===this._nextPointer[e];)e--;return this._computedStyles[e]}getSegmentLengthAt(e){let t=e;for(;-1===this._nextPointer[t];)t--;return this._nextPointer[t]-e}}class v extends b{constructor(){super(),this._priorities={},this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=null,this.clear()}copy(e){for(let t in b.defaultValues)this._styles[t]=e._styles[t],this._priorities[t]=e._priorities[t];this._frontId=e._frontId,this._highestPriority=e._highestPriority}clear(){for(let e in b.defaultValues)this._styles[e]=null,this._priorities[e]=Number.POSITIVE_INFINITY;this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=null}get completed(){for(let e in b.defaultValues)if(null===this._styles[e])return!1;return!0}get front(){return this._frontId}addStyle(e,t,s){for(let s of e)this._priorities[s]>t&&(this.setStyle(s,e.getStyle(s)),this._priorities[s]=t);t<this._highestPriority&&(this._highestPriority=t,this._frontId=s)}sameAs(e){return super.sameAs(e)&&this.front===e.front}}const M={MOUSE_ENTER_CANVAS:"mouseentercanvas",MOUSE_LEAVE_CANVAS:"mouseleavecanvas",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_MOVE:"mousemove",MOUSE_ENTER:"mouseenter",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",CLICK:"click",CONTEXT_MENU:"contextmenu"};Object.freeze(M);const I={Instance:class{constructor(e){console.assert(e,"AsciiGL constructor requires a valid HTML element id parameter.");let t=document.getElementById(e);for(console.assert(t,"AsciiGL constructor parameter containerId does not correspond to a valid HTML element."),console.assert("DIV"===t.tagName,"Container element must be a DIV");t.lastChild;)t.removeChild(t.lastChild);t.style.textAlign="center";let s=document.createElement("DIV");s.style.display="inline-block",s.style.fontFamily="Courier New",s.style.fontSize="1em",s.style.userSelect="none",s.style.margin="0",t.appendChild(s),this._container=s,this._domBuffer=new S,this._nameBuffers=[{},{}],this._drawBufferIdx=0,this._activeBufferIdx=1,this._width=0,this._height=0,this._drawBuffer=new w,this._currMouseOver=void 0,this._handler=()=>{}}init(e,t){console.assert(e>0&&t>0,"AsciiGL must have positive dimensions."),this._width=e,this._height=t,this._drawBuffer.init(e,t),this._domBuffer.init(e,t),this._nameBuffers[0]={},this._nameBuffers[1]={},this._container.appendChild(this._domBuffer.getDomElement()),this._setupEventListeners(),this.render()}_setupEventListeners(){this._container.addEventListener("mouseenter",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._handler(e,"mouseentercanvas",void 0,t);let s=this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId];this._currMouseOver=s,s&&this._handler(e,"mouseenter",this._currMouseOver,t)}),this._container.addEventListener("mouseleave",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._currMouseOver&&this._handler(e,"mouseleave",this._currMouseOver,t),this._currMouseOver=void 0,this._handler(e,"mouseleavecanvas",void 0,t)}),this._container.addEventListener("mousemove",e=>{let t=this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],s=this.mousePositionToCoordinates(e.clientX,e.clientY);t!==this._currMouseOver&&(this._currMouseOver&&this._handler(e,"mouseleave",this._currMouseOver,s),this._currMouseOver=t,t&&this._handler(e,"mouseenter",this._currMouseOver,s)),this._handler(e,"mousemove",this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],s)}),this._container.addEventListener("mousedown",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._handler(e,"mousedown",this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],t)}),this._container.addEventListener("mouseup",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._handler(e,"mouseup",this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],t)}),this._container.addEventListener("click",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._handler(e,"click",this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],t)}),this._container.addEventListener("contextmenu",e=>{e.preventDefault();let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._handler(e,"contextmenu",this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],t)})}mousePositionToCoordinates(e,t){let s=this._container.getBoundingClientRect();return{x:Math.floor((e-s.x)*this.width/s.width),y:Math.floor((t-s.y)*this.height/s.height)}}_flipBuffers(){this._drawBufferIdx=1-this._drawBufferIdx,this._activeBufferIdx=1-this._activeBufferIdx}get width(){return this._width}get height(){return this._height}get backgroundStyles(){return this._drawBuffer.backgroundStyle}getBackgroundStyle(e){return this._drawBuffer.backgroundStyle.getStyle(e)}setBackgroundStyle(e,t){this._drawBuffer.backgroundStyle.setStyle(e,t)}setHandler(e){this._handler=e}draw(t,s,i,n){let r=e.generateId(n);this._drawBuffer.draw(t,s,i,r),n&&(this._nameBuffers[this._drawBufferIdx][r]=n)}render(){this._domBuffer.bind(this._drawBuffer),this._drawBuffer.clear(),this._nameBuffers[this._activeBufferIdx]={},this._flipBuffers()}},Sprite:f,SpriteStyle:b,SpriteBuilder:class{constructor(e){this._template=e,this._paramCount=e.length-1}construct(e){let t="";for(let s=0;s<this._template.length;s++)t+=this._template.length,s<this._paramCount&&(t+=e[s]);return new f(t)}},EventTypes:M};Object.freeze(I);class B{constructor(e){this._agl=e,this._registeredTargets={},this._messageBoards={};for(let e in I.EventTypes)this._messageBoards[I.EventTypes[e]]=new a;e.setHandler((e,t,s,i)=>{void 0===s&&(s=B.Global),this._messageBoards[t].post(s,{type:t,target:s,event:e,coords:i})})}signup(e,t){for(let s in this._messageBoards)this._messageBoards[s].signup(e,t)}withdraw(e){for(let t in this._messageBoards)this._messageBoards[t].withdraw(e)}subscribe(e,t,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].subscribe(e,[t]):console.warn("Message type",i,"not supported")}unsubscribe(e,t,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].unsubscribe(e,[t]):console.warn("Message type",i,"not supported")}}B.Global=Symbol("Global");const C={loadFileAsString:async function(e){return await async function(e){return new Promise((function(t,s){let i=new XMLHttpRequest;i.open("GET",e),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){let e=i.responseText;t(e)}else console.error("HTTP Request returned status code: ",i.status)},i.send()}))}(e)}};Object.freeze(C);const L={getSpriteData:function(e){let t=JSON.parse(e),s=t.sprites,i={};for(let e in s)i[e]=new f(s[e].text,s[e].settings);let n=t.styles,r={};for(let e in n){let t=new b;for(let s in n[e])t.setStyle(s,n[e][s]);r[e]=t}return{sprites:i,styles:r}},getComponentFactories:function(e){let t=JSON.parse(e),s={};for(let e in t){let i=t[e];s[e]=function(){let e=new c;for(let t in i)e.addFrame(t,[...i[t].spriteNameList],[...i[t].styleNameList],[...i[t].relativePositionList]);return e}}return s}};Object.freeze(L);const A={KeyboardInput:y,AsciiMouseInput:B,ResourceManager:class{constructor(){this.data={}}add(e,t){this.data[e]=t}delete(e){this.has(e)&&delete this.data[e]}has(e){return e in this.data}get(e){return e in this.data||console.warn("Resource key: ",e,"not found"),this.data[e]}async loadSpriteFiles(e){for(let t of e){let e=await C.loadFileAsString(t),s=L.getSpriteData(e);for(let e in s.sprites)this.add(e,s.sprites[e]);for(let e in s.styles)this.add(e,s.styles[e])}}async loadTemplateFiles(e){for(let t of e){let e=await C.loadFileAsString(t),s=L.getComponentFactories(e);for(let e in s)this.add(e,s[e])}}}};Object.freeze(A);const x={Parser:L,AssetLoader:C,MessageBoard:a,MessageReceiver:n};Object.freeze(x);const T={Engine:o,Entity:class{constructor(t){this._name=t,this._id=e.generateId(this._name),this._initialized=!1,this._entityManager=void 0,this._components={},this._parent=void 0,this._children={},this._changed=!0,this._enabled=!0,this._ancestorsEnabled=!0}clone(){}init(e){this._initialized=!0,this._entityManager=e,this._entityManager.notifyAddition(this);for(let t in this._children)this._children[t].init(e)}get initialized(){return this._initialized}destroy(){for(let e in this._children)this._children[e].destroy();this._parent&&delete this._parent._children[this.id],this.initialized&&this._entityManager.notifyDeletion(this)}setParent(e){this._parent=e}getParent(){return this._parent}get name(){return this._name}get id(){return this._id}setComponent(e){this.initialized?this._entityManager.requestSetComponent(this,e):this._setComponent(e)}_setComponent(e){this._components[e.type]=e,this.initialized&&this._entityManager.notifyComponentChange(this,e)}getComponent(e){if(this.hasComponent(e))return this._components[e];console.warn("Entity",id,"does not have component of type ",e)}hasComponent(e){return e in this._components}deleteComponent(e){this.initialized&&this.hasComponent(e)?this._entityManager.requestDeleteComponent(this,e):this._deleteComponent(e)}_deleteComponent(e){this.hasComponent(e)?(delete this._components[e],this.initialized&&this._entityManager.notifyComponentChange(this)):console.warn("Entity",this.id,"does not have component of type ",e)}addChild(e){this.initialized?this._entityManager.requestAddEntity(e,this):this._addChild(e)}_addChild(e){this._children[e.id]=e,e.setParent(this)}removeChild(e){this.initialized&&this._children}_removeChild(e){}markForDeletion(){this.initialized?this._entityManager.requestDeleteEntity(this):this.destroy()}enable(e){this.initialized?this._entityManager.requestEnable(this,e):this._enable(e)}_enable(e){if(this._entityManager.notifyEnable(this),e)for(let t in this._children)this._children[t]._enable(e)}disable(e){this.initialized?this._entityManager.requestDisable(this,e):this._disable(e)}_disable(e){if(this._entityManager.notifyDisable(this),e)for(let t in this._children)this._children[t]._disable(e)}},Component:l,Components:_,System:r,Systems:p,Modules:A,GL:I,Utility:x};return Object.freeze(T),T}();
