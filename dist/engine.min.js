const e={generateId:function(){let e=0;return function(t){return void 0===t&&(t="AsciiEngine"),e++,t+"_"+e}}(),clamp:function(e,t,s){return Math.max(t,Math.min(e,s))}};Object.freeze(e);class t{constructor(t){this._name=t,this._id=e.generateId(this._name),this._initialized=!1,this._entityManager=void 0,this._components={},this._parent=void 0,this._children={},this._changed=!0,this._enabled=!0,this._ancestorsEnabled=!0}clone(){}init(e){this._initialized=!0,this._entityManager=e,this._entityManager.notifyAddition(this);for(let t in this._children)this._children[t].init(e)}get initialized(){return this._initialized}destroy(){for(let e in this._children)this._children[e].destroy();this._parent&&delete this._parent._children[this.id],this.initialized&&this._entityManager.notifyDeletion(this)}setParent(e){this._parent=e}getParent(){return this._parent}get name(){return this._name}get id(){return this._id}setComponent(e){this.initialized?this._entityManager.requestSetComponent(this,e):this._setComponent(e)}_setComponent(e){this._components[e.type]=e,this.initialized&&this._entityManager.notifyComponentChange(this,e)}getComponent(e){return this.hasComponent(e)?this._components[e]:null}hasComponent(e){return e in this._components}deleteComponent(e){this.initialized&&this.hasComponent(e)?this._entityManager.requestDeleteComponent(this,e):this._deleteComponent(e)}_deleteComponent(e){this.hasComponent(e)?(delete this._components[e],this.initialized&&this._entityManager.notifyComponentChange(this)):console.warn("Entity",this.id,"does not have component of type ",e)}addChild(e){this.initialized?this._entityManager.requestAddEntity(e,this):this._addChild(e)}_addChild(e){this._children[e.id]=e,e.setParent(this)}removeChild(e){this.initialized&&this._children}_removeChild(e){}markForDeletion(){this.initialized?this._entityManager.requestDeleteEntity(this):this.destroy()}enable(e){this.initialized?this._entityManager.requestEnable(this,e):this._enable(e)}_enable(e){if(this._entityManager.notifyEnable(this),e)for(let t in this._children)this._children[t]._enable(e)}disable(e){this.initialized?this._entityManager.requestDisable(this,e):this._disable(e)}_disable(e){if(this._entityManager.notifyDisable(this),e)for(let t in this._children)this._children[t]._disable(e)}}class s{constructor(){this._storage=[],this._size=0,this._currIdx=0}enqueue(e){this._storage.push(e),this._size++}dequeue(e){let t=this.front;if(void 0===e&&(e=1),this.size<=e)this._storage=[],this._size=0,this._currIdx=0;else if(this.size-e<this._storage.length/2)this._storage=this._storage.slice(this._currIdx+e),this._currIdx=0,this._size-=e;else{let t=0;for(;t<e;)this._storage[this._currIdx]=void 0,this._size--,this._currIdx++,t++}return t}get front(){if(this._size>0)return this._storage[this._currIdx]}get back(){if(this._size>0)return this._storage[this._storage.length-1]}at(e){if(!(e>=this._size||e<0))return this._storage[this._currIdx+e]}get size(){return this._size}get empty(){return 0==this.size}}class i{constructor(e,t,...s){this.operation=e,this.target=t,this.args=s,Object.freeze(this)}}i.ADD_ENTITY=Symbol("AddEntity"),i.DELETE_ENTITY=Symbol("DeleteEntity"),i.SET_COMPONENT=Symbol("SetComponent"),i.DELETE_COMPONENT=Symbol("DeleteComponent"),i.ENABLE=Symbol("Enable"),i.DISABLE=Symbol("Disable");class n{constructor(e){this._engine=e,this._entities=new Set,this._entityOperations=new s,this._added=new Set,this._deleted=new Set,this._changed=new Set,this._enabled=new Set,this._disabled=new Set}init(e){}initEntity(e){e.init(this)}processEntityOperations(){for(;!this._entityOperations.empty;){let e=this._entityOperations.dequeue();this[e.operation](e.target,...e.args)}}requestEntityChanges(){return{added:this._added,deleted:this._deleted,changed:this._changed,enabled:this._enabled,disabled:this._disabled}}markEntityChangesAsHandled(){this._added.clear(),this._deleted.clear(),this._changed.clear(),this._enabled.clear(),this._disabled.clear()}get entities(){return this._entities}requestAddEntity(e,t){this._entityOperations.enqueue(new i(i.ADD_ENTITY,e,t))}[i.ADD_ENTITY](e,t){t&&t._addChild(e),this.initEntity(e)}notifyAddition(e){this._added.add(e),this.entities.add(e)}requestDeleteEntity(e){this._entityOperations.enqueue(new i(i.DELETE_ENTITY,e))}[i.DELETE_ENTITY](e){e.destroy()}notifyDeletion(e){this._deleted.add(e),this.entities.delete(e)}requestSetComponent(e,t){this._entityOperations.enqueue(new i(i.SET_COMPONENT,e,t))}[i.SET_COMPONENT](e,t){e._setComponent(t)}requestDeleteComponent(e,t){this._entityOperations.enqueue(new i(i.DELETE_COMPONENT,e,t))}[i.DELETE_COMPONENT](e,t){target._deleteComponent(t)}notifyComponentChange(e){this._changed.add(e)}requestEnable(e,t){this._entityOperations.enqueue(new i(i.ENABLE,e,t))}[i.ENABLE](e,t){e._enable(t)}notifyEnable(e){this._enabled.add(e)}requestDisable(e,t){this._entityOperations.enqueue(new i(i.DISABLE,e,t))}[i.DISABLE](e,t){entity._disable(t)}notifyDisable(e){this._disabled.add(e)}}class r{constructor(e){this._engine=void 0,this._systemManager=void 0,this._entityManager=void 0,this._name=e,this._priority=0,this._active=!1}get type(){return this.constructor.type}get name(){return this._name}init(e){this._systemManager=e,this._engine=e.getEngine(),this._entityManager=this._engine.getEntityManager(),this._active=!0,this.startup()}destroy(){this.shutdown(),this.unsubscribe([])}getSystemManager(){return this._systemManager}getEngine(){return this._engine}getEntityManager(){return this._entityManager}enable(){this._active||(this._active=!0)}disable(){this._active&&(this._active=!1)}get active(){return this._active}subscribe(e,t,s,i){s&&(t=t.bind(this)),this.getSystemManager().getMessageBoard().subscribe(this.name,e,t,i)}unsubscribe(e){this.getSystemManager().getMessageBoard().unsubscribe(this.name,e)}postMessage(e,t,s){this.getSystemManager().getMessageBoard().post(this.name,e,t,s)}startup(){}shutdown(){}check(e){return!1}has(e){}add(e){}remove(e){}preUpdate(){}update(){}postUpdate(){}}class h{constructor(){this.children={},this.data=new Set,this.size=0}has(e,t){this._has(e,0,t)}_has(e,t,s){return t===e.length?this.data.has(s):e[t]in this.children&&this.children[e[t]]._has(e,t+1,s)}add(e,t){this._add(e,0,t)}_add(e,t,s){if(t===e.length)return this.data.add(s),void this.size++;let i=e[t];i in this.children||(this.children[i]=new h),this.children[i]._add(e,t+1,s),this.size++}delete(e,t){if(0===e.length&&void 0===t)return this.children={},this.data=new Set,void(this.size=0);this._delete(e,0,t)}_delete(e,t,s){let i=0;if(t>=e.length){if(void 0===s){let e=this.size;return this.size=0,e}this.data.has(s)&&(this.data.delete(s),i++);for(let n in this.children)i+=this.children[n]._delete(e,t+1,s),0===this.children[n].size&&delete this.children[n];return this.size-=i,i}return e[t]in this.children&&(i=this.children[e[t]]._delete(e,t+1,s),0===this.children[e[t]].size&&delete this.children[e[t]],this.size-=i),i}*getDescIt(e){yield*this._getDescIt(e,0)}*_getDescIt(e,t){if(t>=e.length){for(let e of this.data)yield e;for(let s in this.children)yield*this.children[s]._getDescIt(e,t+1)}e[t]in this.children&&(yield*this.children[e[t]]._getDescIt(e,t+1))}*getAnscIt(e){yield*this._getAnscIt(e,0)}*_getAnscIt(e,t){if(t>=e.length)for(let e of this.data)yield e;else{e[t]in this.children&&(yield*this.children[e[t]]._getAnscIt(e,t+1));for(let e of this.data)yield e}}}class o{constructor(){this._listeners={},this._subscribers={},this._descriptors=new h,this._messageQueue=new s,this._processImmediately=!1,this._currentlyProcessing=!1}get processImmediately(){return this._processImmediately}set processImmediately(e){this._processImmediately=!!e,this._processImmediately&&this.processMessages()}subscribe(t,s,i,n){t in this._subscribers||(this._subscribers[t]=new h);let r=e.generateId("SystemMessageBoard");this._subscribers[t].add(s,r);let o={name:t,handler:i,source:n};this._listeners[r]=o,this._descriptors.add(s,r)}unsubscribe(e,t){if(e in this._subscribers){for(let s of this._subscribers[e].getDescIt(t))this._descriptors.delete(t,s),delete this._listeners[s];this._subscribers[e].delete(t),0===this._subscribers[e].size&&delete this._subscribers[e]}}unsubscribeAll(e){this.unsubscribe(e,[])}post(e,t,s,i){this._messageQueue.enqueue([e,t,s,i]),this.processImmediately&&this.processMessages()}processMessages(){if(!this._currentlyProcessing){for(this._currentlyProcessing=!0;this._messageQueue.size>0;){let[e,t,s,i]=this._messageQueue.dequeue(1);for(let n of this._descriptors.getAnscIt(t)){let{name:r,handler:h,source:o}=this._listeners[n];void 0!==i&&i!==r||(void 0!==o&&o!==e||h(s,t,e))}}this._currentlyProcessing=!1}}}class a{constructor(e){this._data=new Map,this._sortedKeys=[],this._comparator=e}has(e,t){return this._data.has(e)&&(void 0===t||this._data.get(e).has(t))}*getIt(e){if(this.has(e))for(let t of this._data.get(e))yield t}get(e){let t=new Set;for(let e of this.getIt())t.add(e);return val}*[Symbol.iterator](){for(let e of this._sortedKeys)for(let t of this._data.get(e))yield t}add(e,t){this._data.has(e)||(this._data.set(e,new Set),this._sortedKeys.push(e),this._sortedKeys.sort(this._comparator)),this._data.get(e).add(t)}delete(e,t){this._data.has(e)&&(this._data.get(e).delete(t),0===this._data.get(e).size&&(this._data.delete(e),this._sortedKeys.splice(this._sortedKeys.indexOf(e),1)))}}a.NumericComparator=(e,t)=>e-t;class l{constructor(e){this._engine=e,this._activeSystems=new a,this._systems={},this._systemPriorities={},this._messageBoard=new o}init(e){}processEntityOperations(){let e=this._engine.getEntityManager().requestEntityChanges();for(let t in this._systems){let s=this._systems[t];for(let t of e.added)s.check(t)&&s.add(t);for(let t of e.enabled)s.check(t)&&s.add(t);for(let t of e.changed)!s.has(t)&&s.check(t)?s.add(t):s.has(t)&&!s.check(t)&&s.remove(t);for(let t of e.disabled)s.has(t)&&s.remove(t);for(let t of e.deleted)s.has(t)&&s.remove(t)}this._engine.getEntityManager().markEntityChangesAsHandled()}getEngine(){return this._engine}*[Symbol.iterator](){for(let e of this._activeSystems)yield e}addSystem(e,t,s){t=t||0,this._systems[e.name]=e,this._activeSystems.add(t,e),e.init(this);let i=this.getEngine().getEntityManager();for(let t of i.entities)e.check(t)&&e.add(t)}removeSystem(e,t){if(e in this._systems){let t=this._systems[e];if(this._systems[e].active){let s=this._systemPriorities[e];this._activeSystems.delete(s,t)}delete this._systems[e],t.destroy()}}enableSystem(e,t){if(e in this._systems){let t=this._systems[e];return t.enable(),this._activeSystems.add(this._systemPriorities[e],t),!0}return!1}disableSystem(e,t){if(e in this._systems){let t=this._systems[e];return t.disable(),this._activeSystems.delete(this._systemPriorities[e],t),!0}return!1}getMessageBoard(){return this._messageBoard}}class d{constructor(e){this._initialized=!1,this._entityManager=new n(this),this._systemManager=new l(this),this._modules={},this._millisecPerUpdate=1e3,this._intervalKey=void 0,this._delta=0}getEntityManager(){return this._entityManager}getSystemManager(){return this._systemManager}get modules(){return this._modules}setModule(e,t){this.modules[e]=t}getModule(e){return this.modules[e]}applyModuleConfig(e){for(let t in this._modules)this.modules[t].init(e)}get running(){return void 0!==this._intervalKey}startLoop(e){void 0!==e&&(this._millisecPerUpdate=e),this._intervalKey=setInterval(()=>{this.update()},this._millisecPerUpdate)}pauseLoop(){clearInterval(this._intervalKey),this._intervalKey=void 0}update(){this._systemManager.getMessageBoard().processMessages();for(let e of this._systemManager)e.preUpdate();this._systemManager.getMessageBoard().processMessages();for(let e of this._systemManager)e.update();this._systemManager.getMessageBoard().processMessages();for(let e of this._systemManager)e.postUpdate();this._systemManager.getMessageBoard().processMessages(),this.getEntityManager().processEntityOperations(),this.getSystemManager().processEntityOperations()}}class u{constructor(){if(this.constructor===u)throw new TypeError("Components cannot be instantiated directly!")}get type(){return this.constructor.type}}class c extends u{constructor(e,t,s){super(),this.spriteNameList=e||[],this.styleNameList=t||[],this.relativePositionList=s||[],this.visible=!0,this.dataIsLocal=!1}}c.type="AsciiRender";class _ extends u{constructor(){super(),this._name=void 0,this._spriteNameList={},this._styleNameList={},this._relativePositionList={},this.visible=!0,this.dataIsLocal=!1}get currentFrame(){return this._name}get spriteNameList(){return this._spriteNameList[this.currentFrame]}get styleNameList(){return this._styleNameList[this.currentFrame]}get relativePositionList(){return this._relativePositionList[this.currentFrame]}addFrame(e,t,s,i){console.assert(t.length===s.length&&t.length===i.length,"AsciiAnimateComponent inputs must be of the same length"),void 0===this._name&&(this._name=e),this._spriteNameList[e]=t,this._styleNameList[e]=s,this._relativePositionList[e]=i}setFrame(e){e in this._spriteNameList&&(this._name=e)}}_.type="AsciiAnimate";class g extends u{constructor(e,t,s){super(),this.x=e||0,this.y=t||0,this.z=s||0}}g.type="PositionComponent";const m={AsciiRender:c,AsciiAnimate:_,Position:g};Object.freeze(m);class p extends r{constructor(e){if(super(e),this.constructor===p)throw new TypeError("SetSystem cannot be instantiated directly!");this.entities=new Set}has(e){return this.entities.has(e)}add(e){this.entities.add(e)}remove(e){this.entities.delete(e)}}const y={Graphics:Symbol("GraphicsLibrary"),ResourceManager:Symbol("ResourceManager"),KeyboardInput:Symbol("KeyboardInput")};class f extends p{constructor(e){super(e||"AsciiRender"),this._asciiGl=null}startup(){this._asciiGl=this.getEngine().getModule(y.Graphics)}check(e){return(e.hasComponent(c.type)||e.hasComponent(_.type))&&e.hasComponent(g.type)}postUpdate(){let e=this.getEngine().getModule(y.ResourceManager);for(let t of this.entities){let s=t.getComponent(c.type)||t.getComponent(_.type);if(!s.visible)continue;let i=this.getEntityAbsolutePosition(t);for(let n=0;n<s.spriteNameList.length;n++){let r,h;s.dataIsLocal?(r=s.spriteNameList[n],h=s.styleNameList[n]):(r=e.get(s.spriteNameList[n]),h=e.get(s.styleNameList[n]));let o=[i[0]+s.relativePositionList[n][0],i[1]+s.relativePositionList[n][1],i[2]+s.relativePositionList[n][2]];this._asciiGl.draw(r,o,h,t.id)}}this._asciiGl.render()}getEntityAbsolutePosition(e){let t=[0,0,0];for(;e;){if(e.hasComponent(g.type)){let s=e.getComponent(g.type);t[0]+=s.x,t[1]+=s.y,t[2]+=s.z}e=e.getParent()}return t}}f.type="AsciiRenderSystem";const b={Set:p,Map:class extends r{constructor(e){super(e),this.entities={}}has(e){return e.id in this.entities}add(e){this.entities[e.id]=e}remove(e){delete this.entities[e.id]}},AsciiRender:f,AsciiInputHandler:class extends r{constructor(e){super(e||"AsciiInputHandler"),this._mouseEventsEnabled=!1,this._keyboardEventsEnabled=!1,this._focusedElement=void 0,this._focusableEntities={}}startup(){let e=this.getEngine().getModule(y.Graphics);void 0!==e&&(e.setHandler(this._mouseEventHandler.bind(this)),this._mouseEventsEnabled=!0);let t=this.getEngine().getModule(y.KeyboardInput);void 0!==t&&(t.addEventListener(this._keyboardEventHandler.bind(this)),this._keyboardEventsEnabled=!0),this.mouseEventsEnabled&&this.keyboardEventsEnabled&&(this.subscribe(["InputHandlerRequest","AddFocusable"],this._handleAddFocusable,!0),this.subscribe(["InputHandlerRequest","RemoveFocusable"],this._handleRemoveFocusable,!0),this.subscribe(["InputHandlerRequest","SetFocusRequest"],this._handleSetFocusRequest,!0),this.subscribe(["InputHandlerRequest","ReleaseFocus"],this._handleReleaseFocus,!0))}get mouseEventsEnabled(){return this._mouseEventsEnabled}get keyboardEventsEnabled(){return this._keyboardEventsEnabled}_mouseEventHandler(e,t,s,i){let n=void 0!==s?["MouseEvent",t,s]:["MouseEvent",t];this.postMessage(n,{event:e,coords:i}),"click"===t&&s in this._focusableEntities&&this._switchFocus(s)}_keyboardEventHandler(e,t,s){let i=void 0;if(1===t.length){let s=t.charCodeAt(0);i=s>=48&&s<=57?["KeyboardEvent",e,"Visible","Numeric",t]:s>=65&&s<=90?["KeyboardEvent",e,"Visible","Alphabetical","Upper",t]:s>=97&&s<=122?["KeyboardEvent",e,"Visible","Alphabetical","Lower",t]:["KeyboardEvent",e,"Visible","Symbol",t],i=["KeyboardEvent",e,"Visible",t]}else i=t.startsWith("Arrow")?["KeyboardEvent",e,"Arrow",t]:["KeyboardEvent",e,t];void 0!==this._focusedElement?this.postMessage(i,s,this._focusableEntities[this._focusedElement]):this.postMessage(i,s)}_handleAddFocusable(e,t,s){e in this._focusableEntities||(this._focusableEntities[e]=s)}_handleRemoveFocusable(e){e in this._focusableEntities&&(this._focusedElement===e&&this._switchFocus(),delete this._focusableEntities[e])}_handleSetFocusRequest(e){e in this._focusableEntities&&this._switchFocus(e)}_handleReleaseFocus(e){void 0!==this._focusedElement&&this._focusedElement===e&&this._switchFocus()}_switchFocus(e){let t=this._focusedElement;void 0!==t&&t!==e&&(this.postMessage(["InputHandlerFocusEvent","FocusLost"],t,this._focusableEntities[t]),this._focusedElement=void 0),void 0!==e&&(this._focusedElement=entityId,this.postMessage(["InputHandlerFocusEvent","FocusSet"],entityId,this._focusableEntities[entityId]))}}};Object.freeze(b);class v{constructor(){this.handlers=new Set;for(let e in v.EventTypes){let t=v.EventTypes[e];document.addEventListener(t,e=>{if(document.activeElement===document.body||null===document.activeElement){for(let s of this.handlers)s(t,e.key,e);(e.keyCode<=40&&e.keyCode>=37||32===e.keyCode)&&e.preventDefault()}})}}addEventListener(e){this.handlers.add(e)}removeEventListener(e){this.handlers.delete(e)}}v.EventTypes={KEY_DOWN:"keydown",KEY_UP:"keyup"};class S{constructor(){this.channelSubscribers={},this.subscriptions={},this.receivers={},this.channelQueue=new s,this.messageQueue=new s}getAllChannels(){return Object.keys(this.channelSubscribers)}getSubscriptions(e){if(e in this.subscriptions)return this.subscriptions[e];console.warn("Id ",e," not found in messageBoard")}getSubscribers(e){if(id in this.channelSubscribers)return this.channelSubscribers[id];console.warn("Id ",id," not found in messageBoard")}signup(e,t){e in this.receivers?console.warn("Id ",e," is already signed up."):(this.receivers[e]=t,this.subscriptions[e]=new Set)}subscribe(e,t){if(e in this.receivers)for(let s of t)s in this.channelSubscribers||(this.channelSubscribers[s]=new Set),e in this.channelSubscribers[s]||(this.channelSubscribers[s].add(e),this.subscriptions[e].add(s));else console.error("Id ",e," does not have a receiver but is signing up for messages.")}unsubscribe(e,t){if(e in this.subscriptions)for(let s of t)s in this.channelSubscribers?(e in this.channelSubscribers[s]||console.warn("State id: ",e," does not appear in the messageBoard list ",s),this.channelSubscribers[s].delete(e),0===this.channelSubscribers[s].size&&delete this.channelSubscribers[s],this.subscriptions[e].delete(s)):console.error("Channel ",s," does not belong the messageBoard");else console.warn("Channel: ",e," does not appear in the message board")}withdraw(e){e in this.subscriptions||console.warn("Id: ",e," does not appear in the message board");for(let t of this.subscriptions[e])this.channelSubscribers[t].delete(e),0===this.channelSubscribers[t].size&&delete this.channelSubscribers[t];delete this.subscriptions[e],delete this.receivers[e]}post(e,t,s){if(t in this.channelSubscribers)for(let i of this.channelSubscribers[t])this.receivers[i].receiveMessage(e,t,s)}}class E{constructor(e,t){e=e||"",t=t||{},this._text=e,this._rowIndices=[],this._firstVisibleChar=[],this._width=0,this._height=1,this._segments=void 0,this._setAsBlank="",this._setAsBlankRegexp=null,this._spaceIsTransparent=!0,this._ignoreLeadingSpaces=!0,this._spaceHasFormatting=!1,"setAsBlank"in t&&(this._setAsBlank=t.setAsBlank),this._setAsBlankRegexp=new RegExp("["+this._setAsBlank+"]","g"),this._processedText=this._text.replace(this._setAsBlankRegexp," "),"spaceIsTransparent"in t&&(this._spaceIsTransparent=t.spaceIsTransparent),"ignoreLeadingSpaces"in t&&(this._ignoreLeadingSpaces=t.ignoreLeadingSpaces),"spaceHasFormatting"in t&&(this._spaceHasFormatting=t.spaceHasFormatting),this._parseSpriteShape(),this._parseSegmentData(),Object.freeze(this)}_parseSpriteShape(){let e=!1,t=0;for("\n"===this.text[0]&&(t=1),this._rowIndices.push(t),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:t);t<this.text.length;t++)"\n"===this.text[t]?(t-this._rowIndices[this._rowIndices.length-1]>this._width&&(this._width=Math.max(this._width,t-this._rowIndices[this._rowIndices.length-1])),this._rowIndices.push(t+1),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:t),e=!1):e||" "===this.text[t]||(e=!0,this._firstVisibleChar[this._firstVisibleChar.length-1]=t),t>1&&"\n"===this.text[t-1]&&this._height++;"\n"!==this.text.charAt(this.text.length-1)?(this._width=Math.max(this._width,this.text.length-this._rowIndices[this._rowIndices.length-1]),this._rowIndices.push(this.text.length+1)):this._rowIndices.push(this.text.length)}_parseSegmentData(){this._segments=new Array(this.height);for(let e=0;e<this.height;e++){this._segments[e]=[];let t=this._rowIndices[e],s=this._rowIndices[e+1]-1-t,i=this.ignoreLeadingSpaces?this._firstVisibleChar[e]-t:0,n=i,r=w.BLANK;for(;i<s;){let s=t+i,h=this.text[s],o=this._charState(h);o!==r&&(this._addSegment(n,i,e,r),n=i,r=o),i++}this._addSegment(n,i,e,r)}}_addSegment(e,t,s,i){i!==w.BLANK&&this._segments[s].push({x:e,y:s,length:t-e,visibleText:i===w.HAS_TEXT})}get text(){return this._text}get width(){return this._width}get height(){return this._height}get setAsBlank(){return this._setAsBlank}get spaceIsTransparent(){return this._spaceIsTransparent}get ignoreLeadingSpaces(){return this._ignoreLeadingSpaces}get spaceHasFormatting(){return this._spaceHasFormatting}*getItSpritePos(e,t,s,i){let n=Math.max(s,0),r=Math.min(i,this.height);if(!(s>=this.height||i<=0))for(let s=n;s<r;s++){if(void 0===this._firstVisibleChar[s])continue;let i=this._rowIndices[s],n=this._rowIndices[s+1]-1-i,r=this.ignoreLeadingSpaces?this._firstVisibleChar[s]-i:0;if(!(e>=n||t<=r))for(let i of this._segments[s]){let n=Math.max(i.x,e),r=Math.min(i.x+i.length,t);if(t<=n)break;r<=e||(yield{x:n,y:s,length:r-n,visibleText:i.visibleText})}}}*getItScreenPos(e,t,s,i,n,r){for(let h of this.getItSpritePos(s-e,s+n-e,i-t,i+r-t))h.x+=e,h.y+=t,yield h}_charHasFormatting(e){return" "!==e||!this.spaceIsTransparent||this.spaceHasFormatting}_charHasText(e){return" "!==e||!this.spaceIsTransparent}_charState(e){return this._charHasText(e)?w.HAS_TEXT:this._charHasFormatting(e)?w.HAS_FORMATTING:w.BLANK}segmentLengthAt(e,t){if(t<0||t>=this.height)return 0;if(e<0||e>=this.width)return 0;for(let s of this._segments[t])if(!(s.x+s.length<=e))return e<s.x?0:s.x+s.length-e;return 0}segmentAt(e,t,s){const i=this._rowIndices[t];let n=this.segmentLengthAt(e,t);return n=s&&s<n?s:n,this._processedText.substring(i+e,i+e+n)}}const w={BLANK:0,HAS_FORMATTING:1,HAS_TEXT:2};class M{constructor(){this._styles={};for(let e in M.defaultValues)this._styles[e]=null}freeze(){Object.freeze(this._styles),Object.freeze(this)}clear(){for(let e in M.defaultValues)this._styles[e]=null}copy(e){this.clear();for(let t of e)this.setStyle(t,e.getStyle(t))}sameAs(e){for(let t in M.defaultValues)if(this.hasStyle(t)!==e.hasStyle(t)||this.getStyle(t)!==e.getStyle(t))return!1;return!0}setStyle(e,t){e in M.defaultValues||console.warn("AsciiGL currently does not support the style",e),this._styles[e]=t||null}hasStyle(e){return null!==this._styles[e]}getStyle(e){return this.hasStyle(e)?this._styles[e]:""}*[Symbol.iterator](){for(let e in this._styles)this.hasStyle(e)&&(yield e)}fillRemainder(e){for(let t in M.defaultValues)this.hasStyle(t)||(e&&e.hasStyle(t)?this.setStyle(t,e.getStyle(t)):this.setStyle(t,M.defaultValues[t]))}}M.defaultValues={color:"black",backgroundColor:"transparent",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",cursor:"default"},M.setDefaultStyle=function(e,t){e in M.defaultValues?M.defaultValues[e]=t:console.warn("Style does not support",e)};class I{constructor(){this.primaryElement=document.createElement("pre"),this._width=0,this._height=0,this.activeRowLength=[],this.rows=[],this.elements=[],this.primaryElement.style.margin="0"}init(e,t){this._width=e,this._height=t;for(let s=0;s<t;s++){let t=document.createElement("div");t.dataset.asciiGlRow=s,this.primaryElement.appendChild(t),this.rows.push(t),this.elements.push([]),this.activeRowLength.push(0);for(let t=0;t<e;t++)this.elements[s].push(new C)}}get width(){return this._width}get height(){return this._height}getDomElement(){return this.primaryElement}setRowLength(e,t){if(t<this.activeRowLength[e])for(let s=this.activeRowLength[e]-1;s>=t;s--)this.rows[e].removeChild(this.elements[e][s].getDomElement());else if(t>this.activeRowLength[e])for(let s=this.activeRowLength[e];s<t;s++)this.rows[e].appendChild(this.elements[e][s].getDomElement());this.activeRowLength[e]=t}bind(e){for(let t=0;t<this.height;t++){let s=0,i=0;for(;s<this.width;){let n=this.elements[t][i],r=e.getSegmentLengthAt(s,t),h=e.getSegmentAt(s,t),o=h.textId,a=void 0;a=void 0===o?" ".repeat(r):e.sprites[o].segmentAt(s-e.locations[o][0],t-e.locations[o][1],r),n.setText(a);let l=h.styles;for(let e in l)n.setStyle(e,l[e]);n.setId(h.frontId),i++,s+=r,n.applyChanges()}this.setRowLength(t,i)}}}class C{constructor(){this._domElement=document.createElement("span"),this._currText="",this._currStyles={},this._nextText="",this._nextStyles={},this._currId="",this._nextId=""}getDomElement(){return this._domElement}setText(e){this._nextText=e}setStyle(e,t){this._nextStyles[e]=t||""}setId(e){this._nextId=e}applyChanges(){let e=this._domElement;this._nextText!==this._currText&&(e.textContent=this._nextText),this._currText=this._nextText;for(let t in this._nextStyles){let s=this._nextStyles[t];s!==this._currStyles[t]&&(e.style[t]=s),this._currStyles[t]=s}this._nextId!==this._currId&&(void 0===this._nextId?delete e.dataset.asciiGlId:e.dataset.asciiGlId=this._nextId),this._currId=this._nextId}}class x{constructor(){this._width=0,this._height=0,this.rowComputedData=[],this.sprites={},this.locations={},this.backgroundStyle=new M,this.backgroundStyle.fillRemainder()}init(e,t){this._width=e,this._height=t;for(let s=0;s<t;s++)this.rowComputedData.push(new A(s,e,this.backgroundStyle))}get width(){return this._width}get height(){return this._height}clear(){for(let e=0;e<this.height;e++)this.rowComputedData[e].clear();this.sprites={},this.locations={}}draw(e,t,s,i){for(let n of e.getItScreenPos(t[0],t[1],0,0,this.width,this.height)){let e=n.y;this.rowComputedData[e].loadSegment(n.length,n.x,s,t[2],i,n.visibleText)}this.sprites[i]=e,this.locations[i]=t}getSegmentLengthAt(e,t){return this.rowComputedData[t].getSegmentLengthAt(e)}getSegmentAt(e,t){return this.rowComputedData[t].getSegmentAt(e)}}class A{constructor(e,t,s){this._width=t,this._rowNumber=e,this._nextPointer=new Array(t),this._computedSegments=new Array(t);for(let e=0;e<this.width;e++)this._computedSegments[e]=new B(s),this._nextPointer[e]=-1;this._nextPointer[0]=this.width}clear(){for(let e=1;e<this.width;e++)this._nextPointer[e]=-1;this._computedSegments[0].clear(),this._nextPointer[0]=this.width}get row(){return this._rowNumber}get width(){return this._width}insertSegmentStart(e){if(-1===this._nextPointer[e]){this._computedSegments[e].clear();let t=e-1;for(;-1===this._nextPointer[t];)t--;this._nextPointer[e]=this._nextPointer[t],this._nextPointer[t]=e,this._computedSegments[e].copy(this._computedSegments[t])}}loadSegment(e,t,s,i,n,r){let h=t+e;this.insertSegmentStart(t),this.insertSegmentStart(h);let o=t;do{this._computedSegments[o].addStyle(n,r,s,i),o=this._nextPointer[o]}while(o<this.width&&o<h)}getSegmentLengthAt(e){let t=e;for(;-1===this._nextPointer[t];)t--;return this._nextPointer[t]-e}getSegmentAt(e){for(;-1===this._nextPointer[e];)e--;return this._computedSegments[e]}}class B{constructor(e){this._default=e,this._spriteId=void 0,this._spritePriority=void 0,this._styleValues={},this._stylePriorities={},this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=void 0,this.clear(),Object.seal(this),Object.seal(this._styleValues),Object.seal(this._stylePriorities)}copy(e){for(let t in M.defaultValues)this._styleValues[t]=e._styleValues[t],this._stylePriorities[t]=e._stylePriorities[t];this._spriteId=e._spriteId,this._spritePriority=e._spritePriority,this._highestPriority=e._highestPriority,this._frontId=e._frontId}clear(){for(let e in M.defaultValues)this._styleValues[e]=this._default.getStyle(e),this._stylePriorities[e]=Number.POSITIVE_INFINITY;this._spriteId=void 0,this._spritePriority=Number.POSITIVE_INFINITY,this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=void 0}get frontId(){return this._frontId}get textId(){return this._spriteId}get styles(){return this._styleValues}addStyle(e,t,s,i){for(let e of s)if(i<this._stylePriorities[e]){let t=s.getStyle(e);void 0!==t&&(this._styleValues[e]=t,this._stylePriorities[e]=i)}t&&i<this._spritePriority&&(this._spriteId=e,this._spritePriority=i),i<this._highestPriority&&(this._highestPriority=i,this._frontId=e)}}const L={MOUSE_ENTER_CANVAS:"mouseentercanvas",MOUSE_LEAVE_CANVAS:"mouseleavecanvas",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_MOVE:"mousemove",MOUSE_ENTER:"mouseenter",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",CLICK:"click",CONTEXT_MENU:"contextmenu"};Object.freeze(L);const T={Instance:class{constructor(e){console.assert(e,"AsciiGL constructor requires a valid HTML element id parameter.");let t=document.getElementById(e);for(console.assert(t,"AsciiGL constructor parameter containerId does not correspond to a valid HTML element."),console.assert("DIV"===t.tagName,"Container element must be a DIV");t.lastChild;)t.removeChild(t.lastChild);t.style.textAlign="center";let s=document.createElement("DIV");s.style.display="inline-block",s.style.fontFamily="Courier New",s.style.fontSize="1em",s.style.userSelect="none",s.style.margin="0",t.appendChild(s),this._container=s,this._domBuffer=new I,this._nameBuffers=[{},{}],this._drawBufferIdx=0,this._activeBufferIdx=1,this._width=0,this._height=0,this._drawBuffer=new x,this._currMouseOver=void 0,this._currMouseDown=void 0,this._handler=()=>{}}init(e,t){console.assert(e>0&&t>0,"AsciiGL must have positive dimensions."),this._width=e,this._height=t,this._drawBuffer.init(e,t),this._domBuffer.init(e,t),this._nameBuffers[0]={},this._nameBuffers[1]={},this._container.appendChild(this._domBuffer.getDomElement()),this._setupEventListeners(),this.render()}_setupEventListeners(){this._container.addEventListener("mouseenter",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._handler(e,"mouseentercanvas",void 0,t);let s=this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId];this._currMouseOver=s,s&&this._handler(e,"mouseenter",this._currMouseOver,t)}),this._container.addEventListener("mouseleave",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._currMouseOver&&this._handler(e,"mouseleave",this._currMouseOver,t),this._currMouseDown&&(this._currMouseDown=void 0),this._currMouseOver=void 0,this._handler(e,"mouseleavecanvas",void 0,t)}),this._container.addEventListener("mousemove",e=>{let t=this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],s=this.mousePositionToCoordinates(e.clientX,e.clientY);t!==this._currMouseOver&&(this._currMouseOver&&this._handler(e,"mouseleave",this._currMouseOver,s),this._currMouseOver=t,t&&this._handler(e,"mouseenter",this._currMouseOver,s)),this._handler(e,"mousemove",this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],s)}),this._container.addEventListener("mousedown",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._currMouseDown=this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId]||void 0,this._handler(e,"mousedown",this._currMouseDown,t)}),this._container.addEventListener("mouseup",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._handler(e,"mouseup",this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],t)}),this._container.addEventListener("click",e=>{let t=this.mousePositionToCoordinates(e.clientX,e.clientY),s=this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId];void 0!==this._currMouseDown&&s!==this._currMouseDown&&(this._currMouseDown=void 0),this._handler(e,"click",this._currMouseDown,t),this._currMouseDown=void 0}),this._container.addEventListener("contextmenu",e=>{e.preventDefault();let t=this.mousePositionToCoordinates(e.clientX,e.clientY);this._handler(e,"contextmenu",this._nameBuffers[this._activeBufferIdx][e.target.dataset.asciiGlId],t)})}mousePositionToCoordinates(e,t){let s=this._container.getBoundingClientRect();return{x:Math.floor((e-s.x)*this.width/s.width),y:Math.floor((t-s.y)*this.height/s.height)}}_flipBuffers(){this._drawBufferIdx=1-this._drawBufferIdx,this._activeBufferIdx=1-this._activeBufferIdx}get width(){return this._width}get height(){return this._height}get backgroundStyles(){return this._drawBuffer.backgroundStyle}getBackgroundStyle(e){return this._drawBuffer.backgroundStyle.getStyle(e)}setBackgroundStyle(e,t){this._drawBuffer.backgroundStyle.setStyle(e,t)}setHandler(e){this._handler=e}draw(t,s,i,n){let r=e.generateId(n);this._drawBuffer.draw(t,s,i,r),n&&(this._nameBuffers[this._drawBufferIdx][r]=n)}render(){this._domBuffer.bind(this._drawBuffer),this._drawBuffer.clear(),this._nameBuffers[this._activeBufferIdx]={},this._flipBuffers()}},Sprite:E,Style:M,SpriteBuilder:class{constructor(e){this._template=e,this._paramCount=e.length-1}construct(e){let t="";for(let s=0;s<this._template.length;s++)t+=this._template[s],s<this._paramCount&&(t+=e[s]);return new E(t)}},EventTypes:L};Object.freeze(T);class P{constructor(e){this.GLOBAL=P.Global,this._agl=e,this._registeredTargets={},this._messageBoards={};for(let e in T.EventTypes)this._messageBoards[T.EventTypes[e]]=new S;e.setHandler((e,t,s,i)=>{void 0!==s&&this._messageBoards[t].post(t,s,{type:t,target:s,event:e,coords:i}),this._messageBoards[t].post(t,this.GLOBAL,{type:t,target:s,event:e,coords:i})})}signup(e,t){for(let s in this._messageBoards)this._messageBoards[s].signup(e,t)}withdraw(e){for(let t in this._messageBoards)this._messageBoards[t].withdraw(e)}subscribe(e,t,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].subscribe(e,[t]):console.warn("Message type",i,"not supported")}unsubscribe(e,t,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].unsubscribe(e,[t]):console.warn("Message type",i,"not supported")}}P.Global=Symbol("Global");const D={loadFileAsString:async function(e){return await async function(e){return new Promise((function(t,s){let i=new XMLHttpRequest;i.open("GET",e),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){let e=i.responseText;t(e)}else console.error("HTTP Request returned status code: ",i.status)},i.send()}))}(e)}};Object.freeze(D);const O={getSpriteData:function(e){let t=JSON.parse(e),s=t.sprites,i={};for(let e in s)i[e]=new E(s[e].text,s[e].settings);let n=t.styles,r={};for(let e in n){let t=new M;for(let s in n[e])t.setStyle(s,n[e][s]);r[e]=t}return{sprites:i,styles:r}},getComponentFactories:function(e){let t=JSON.parse(e),s={};for(let e in t){let i=t[e];s[e]=new N(i)}return s}};class N{constructor(e){this.specs=e}construct(){let e=new _;for(let t in this.specs)e.addFrame(t,[...this.specs[t].spriteNameList],[...this.specs[t].styleNameList],[...this.specs[t].relativePositionList]);return e}}Object.freeze(O);const k={KeyboardInput:v,AsciiMouseInput:P,ResourceManager:class{constructor(){this.data={}}add(e,t){this.data[e]=t}delete(e){this.has(e)&&delete this.data[e]}has(e){return e in this.data}get(e){return e in this.data||console.warn("Resource key: ",e,"not found"),this.data[e]}async loadSpriteFiles(e){for(let t of e){let e=await D.loadFileAsString(t),s=O.getSpriteData(e);for(let e in s.sprites)this.add(e,s.sprites[e]);for(let e in s.styles)this.add(e,s.styles[e])}}async loadTemplateFiles(e){for(let t of e){let e=await D.loadFileAsString(t),s=O.getComponentFactories(e);for(let e in s)this.add(e,s[e])}}}};Object.freeze(k);const z={Parser:O,AssetLoader:D,MessageBoard:S,MessageReceiver:class{constructor(e){this.sourceQueue=new s,this.tagQueue=new s,this.messageQueue=new s,this.callback=e}receiveMessage(e,t,s){this.sourceQueue.enqueue(e),this.tagQueue.enqueue(t),this.messageQueue.enqueue(s)}handle(){let e=this.sourceQueue.dequeue(),t=this.tagQueue.dequeue(),s=this.messageQueue.dequeue();this.callback(e,t,s)}handleAll(){for(;this.tagQueue.size>0;)this.handle()}}};Object.freeze(z);class F extends u{constructor(){super(),this.sprite=new E(""),this.textColor=void 0,this.backgroundColor=void 0,this.hoverColor=void 0,this.activeColor=void 0}}F.type="AsciiButton";class R extends u{constructor(){super(),this.mouseState=R.MouseStates.Default}}R.type="AsciiButtonInternal",R.MouseStates={Default:"Default",Hover:"Hover",Active:"Active"};const H={Components:{Button:F},Systems:{Button:class extends r{constructor(){super("Buttons"),this._handleMouseClick=this._handleMouseClick.bind(this),this._handleMouseEnter=this._handleMouseEnter.bind(this),this._handleMouseLeave=this._handleMouseLeave.bind(this),this._handleMouseDown=this._handleMouseDown.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this.buttonEntities={},this.buttonSubentities={},this.childMap={},this.defaultTextColor="#222222",this.defaultBackgroundColor="#dddddd",this.defaultHoverColor="#bbbbbb",this.defaultActiveColor="#aaaaaa"}check(e){return e.hasComponent(F.type)||e.hasComponent(R.type)}has(e){return e.id in this.buttonEntities||e.id in this.buttonSubentities}add(e){e.hasComponent(F.type)?(this.buttonEntities[e.id]=e,this._constructButtonSubentities(e)):e.hasComponent(R.type)&&(this.buttonSubentities[e.id]=e,this.childMap[e.getParent().id]=e.id)}remove(e){e.hasComponent(F.type)?(this._deconstructButtonSubentities(e),delete this.childMap[e.id],delete this.buttonEntities[e.id]):e.hasComponent(R.type)&&delete this.buttonSubentities[e.id]}postUpdate(){for(let e in this.buttonSubentities){let t=this.buttonSubentities[e],s=t.getComponent(_.type),i=t.getComponent(R.type);s.setFrame(i.mouseState)}}_constructButtonSubentities(e){let s=e.getComponent(F.type),i=new t(e.id),n=new g(0,0,0);i.setComponent(n);let r=new _;r.dataIsLocal=!0;let h=s.textColor||this.defaultTextColor,o=new M;o.setStyle("cursor","pointer"),o.setStyle("color",h);let a=s.backgroundColor||this.defaultBackgroundColor;o.setStyle("backgroundColor",a),r.addFrame(R.MouseStates.Default,[s.sprite],[o],[[0,0,0]]);let l=new M;l.setStyle("cursor","pointer"),l.setStyle("color",h);let d=s.hoverColor||a;l.setStyle("backgroundColor",d),r.addFrame(R.MouseStates.Hover,[s.sprite],[l],[[0,0,0]]);let u=new M;u.setStyle("cursor","pointer"),u.setStyle("color",h);let c=s.activeColor||d;u.setStyle("backgroundColor",c),r.addFrame(R.MouseStates.Active,[s.sprite],[u],[[0,0,0]]),i.setComponent(r);let m=new R;i.setComponent(m),this.subscribe(["MouseEvent","click",i.id],this._handleMouseClick,!1),this.subscribe(["MouseEvent","mouseenter",i.id],this._handleMouseEnter,!1),this.subscribe(["MouseEvent","mouseleave",i.id],this._handleMouseLeave,!1),this.subscribe(["MouseEvent","mousedown",i.id],this._handleMouseDown,!1),this.subscribe(["MouseEvent","mouseup",i.id],this._handleMouseUp,!1),e.addChild(i)}_deconstructButtonSubentities(e){let t=this.childMap[e.id];this.unsubscribe(["MouseEvent","click",t]),this.unsubscribe(["MouseEvent","mouseenter",t]),this.unsubscribe(["MouseEvent","mouseleave",t]),this.unsubscribe(["MouseEvent","mousedown",t]),this.unsubscribe(["MouseEvent","mouseup",t])}_handleMouseClick(e,t){let s=this.buttonSubentities[t[2]].getParent().id;this.postMessage(["AsciiButtonElement",s,"click"])}_handleMouseEnter(e,t){let s=t[2],i=this.buttonSubentities[s],n=i.getParent().id;this.postMessage(["AsciiButtonElement",n,"mouseenter"]),i.getComponent(R.type).mouseState=R.MouseStates.Hover}_handleMouseLeave(e,t){let s=t[2],i=this.buttonSubentities[s],n=i.getParent().id;this.postMessage(["AsciiButtonElement",n,"mouseleave"]),i.getComponent(R.type).mouseState=R.MouseStates.Default}_handleMouseDown(e,t){let s=t[2],i=this.buttonSubentities[s],n=i.getParent().id;this.postMessage(["AsciiButtonElement",n,"mousedown"]),i.getComponent(R.type).mouseState=R.MouseStates.Active}_handleMouseUp(e,t){let s=t[2],i=this.buttonSubentities[s],n=i.getParent().id;this.postMessage(["AsciiButtonElement",n,"mouseup"]),i.getComponent(R.type).mouseState=R.MouseStates.Hover}}}},V={Engine:d,Entity:t,Component:u,Components:m,System:r,Systems:b,Modules:k,ModuleSlots:y,GL:T,Gui:H,Utility:z};export default V;export{u as Component,m as Components,d as Engine,t as Entity,T as GL,H as Gui,y as ModuleSlots,k as Modules,r as System,b as Systems};
