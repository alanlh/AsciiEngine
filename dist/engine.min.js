var AsciiEngine=function(){"use strict";const t={generateId:function(){let t=0;return function(e){return void 0===e&&(e="AsciiEngine"),t++,e+"_"+t}}(),clamp:function(t,e,s){return Math.max(e,Math.min(t,s))}};Object.freeze(t);class e{constructor(){this._storage=[],this._size=0,this._currIdx=0}enqueue(t){this._storage.push(t),this._size++}dequeue(t){let e=this.front;if(void 0===t&&(t=1),this.size<=t)this._storage=[],this._size=0,this._currIdx=0;else if(this.size-t<this._storage.length/2)this._storage=this._storage.slice(this._currIdx+t),this._currIdx=0,this._size-=t;else{let e=0;for(;e<t;)this._storage[this._currIdx]=void 0,this._size--,this._currIdx++,e++}return e}get front(){if(this._size>0)return this._storage[this._currIdx]}get back(){if(this._size>0)return this._storage[this._storage.length-1]}at(t){if(!(t>=this._size||t<0))return this._storage[this._currIdx+t]}get size(){return this._size}get empty(){return 0==this.size}}class s{constructor(t,e,...s){this.operation=t,this.target=e,this.args=s,Object.freeze(this)}}s.ADD_ENTITY=Symbol("AddEntity"),s.DELETE_ENTITY=Symbol("DeleteEntity"),s.SET_COMPONENT=Symbol("SetComponent"),s.DELETE_COMPONENT=Symbol("DeleteComponent"),s.ENABLE=Symbol("Enable"),s.DISABLE=Symbol("Disable");class i{constructor(t){this._engine=t,this._entities=new Set,this._entityOperations=new e,this._added=new Set,this._deleted=new Set,this._changed=new Set,this._enabled=new Set,this._disabled=new Set}init(t){}initEntity(t){t.init(this)}processEntityOperations(){for(;!this._entityOperations.empty;){let t=this._entityOperations.dequeue();this[t.operation](t.target,...t.args)}}requestEntityChanges(){return{added:this._added,deleted:this._deleted,changed:this._changed,enabled:this._enabled,disabled:this._disabled}}markEntityChangesAsHandled(){this._added.clear(),this._deleted.clear(),this._changed.clear(),this._enabled.clear(),this._disabled.clear()}get entities(){return this._entities}requestAddEntity(t,e){this._entityOperations.enqueue(new s(s.ADD_ENTITY,t,e))}[s.ADD_ENTITY](t,e){e&&e._addChild(t),this.initEntity(t)}notifyAddition(t){this._added.add(t),this.entities.add(t)}requestDeleteEntity(t){this._entityOperations.enqueue(new s(s.DELETE_ENTITY,t))}[s.DELETE_ENTITY](t){t.destroy()}notifyDeletion(t){this._deleted.add(t),this.entities.delete(t)}requestSetComponent(t,e){this._entityOperations.enqueue(new s(s.SET_COMPONENT,t,e))}[s.SET_COMPONENT](t,e){t._setComponent(e)}requestDeleteComponent(t,e){this._entityOperations.enqueue(new s(s.DELETE_COMPONENT,t,e))}[s.DELETE_COMPONENT](t,e){target._deleteComponent(e)}notifyComponentChange(t){this._changed.add(t)}requestEnable(t,e){this._entityOperations.enqueue(new s(s.ENABLE,t,e))}[s.ENABLE](t,e){t._enable(e)}notifyEnable(t){this._enabled.add(t)}requestDisable(t,e){this._entityOperations.enqueue(new s(s.DISABLE,t,e))}[s.DISABLE](t,e){entity._disable(e)}notifyDisable(t){this._disabled.add(t)}}class n{constructor(t){this.sourceQueue=new e,this.tagQueue=new e,this.messageQueue=new e,this.callback=t}receiveMessage(t,e,s){this.sourceQueue.enqueue(t),this.tagQueue.enqueue(e),this.messageQueue.enqueue(s)}handle(){let t=this.sourceQueue.dequeue(),e=this.tagQueue.dequeue(),s=this.messageQueue.dequeue();this.callback(t,e,s)}handleAll(){for(;this.tagQueue.size>0;)this.handle()}}class r{constructor(t){this._engine=void 0,this._systemManager=void 0,this._entityManager=void 0,this._name=t,this._priority=0,this._active=!1,this._messageReceiver=new n(this.receiveMessage.bind(this))}get type(){return this.constructor.type}get name(){return this._name}init(t){this._systemManager=t,this._engine=t.getEngine(),this._entityManager=this._engine.getEntityManager(),this.getSystemManager().getMessageBoard().signup(this.name,this.getMessageReceiver()),this._active=!0,this.startup()}destroy(){this.shutdown(),this.getSystemManager().getMessageBoard().withdraw(this.name)}getSystemManager(){return this._systemManager}getEngine(){return this._engine}getEntityManager(){return this._entityManager}getMessageReceiver(){return this._messageReceiver}enable(){this._active||(this._active=!0)}disable(){this._active&&(this._active=!1)}get active(){return this._active}startup(){}shutdown(){}check(t){return!1}has(t){}add(t){}remove(t){}preUpdate(){}update(){}postUpdate(){}receiveMessage(t,e,s){}}class a{constructor(){this.channelSubscribers={},this.subscriptions={},this.receivers={},this.channelQueue=new e,this.messageQueue=new e}getAllChannels(){return Object.keys(this.channelSubscribers)}getSubscriptions(t){if(t in this.subscriptions)return this.subscriptions[t];console.warn("Id ",t," not found in messageBoard")}getSubscribers(t){if(id in this.channelSubscribers)return this.channelSubscribers[id];console.warn("Id ",id," not found in messageBoard")}signup(t,e){t in this.receivers?console.warn("Id ",t," is already signed up."):(this.receivers[t]=e,this.subscriptions[t]=new Set)}subscribe(t,e){if(t in this.receivers)for(let s of e)s in this.channelSubscribers||(this.channelSubscribers[s]=new Set),t in this.channelSubscribers[s]||(this.channelSubscribers[s].add(t),this.subscriptions[t].add(s));else console.error("Id ",t," does not have a receiver but is signing up for messages.")}unsubscribe(t,e){if(t in this.subscriptions)for(let s of e)s in this.channelSubscribers?(t in this.channelSubscribers[s]||console.warn("State id: ",t," does not appear in the messageBoard list ",s),this.channelSubscribers[s].delete(t),0===this.channelSubscribers[s].size&&delete this.channelSubscribers[s],this.subscriptions[t].delete(s)):console.error("Channel ",s," does not belong the messageBoard");else console.warn("Channel: ",t," does not appear in the message board")}withdraw(t){t in this.subscriptions||console.warn("Id: ",t," does not appear in the message board");for(let e of this.subscriptions[t])this.channelSubscribers[e].delete(t),0===this.channelSubscribers[e].size&&delete this.channelSubscribers[e];delete this.subscriptions[t],delete this.receivers[t]}post(t,e,s){if(e in this.channelSubscribers)for(let i of this.channelSubscribers[e])this.receivers[i].receiveMessage(t,e,s)}}class h{constructor(t){this._data=new Map,this._sortedKeys=[],this._comparator=t}has(t,e){return this._data.has(t)&&(void 0===e||this._data.get(t).has(e))}*getIt(t){if(this.has(t))for(let e of this._data.get(t))yield e}get(t){let e=new Set;for(let t of this.getIt())e.add(t);return val}*[Symbol.iterator](){for(let t of this._sortedKeys)for(let e of this._data.get(t))yield e}add(t,e){this._data.has(t)||(this._data.set(t,new Set),this._sortedKeys.push(t),this._sortedKeys.sort(this._comparator)),this._data.get(t).add(e)}delete(t,e){this._data.has(t)&&(this._data.get(t).delete(e),0===this._data.get(t).size&&(this._data.delete(t),this._sortedKeys.splice(this._sortedKeys.indexOf(t),1)))}}h.NumericComparator=(t,e)=>t-e;class o{constructor(t){this._engine=t,this._activeSystems=new h,this._systems={},this._systemPriorities={},this._messageBoard=new a}init(t){}processEntityOperations(){let t=this._engine.getEntityManager().requestEntityChanges();for(let e in this._systems){let s=this._systems[e];for(let e of t.added)s.check(e)&&s.add(e);for(let e of t.enabled)s.check(e)&&s.add(e);for(let e of t.changed)!s.has(e)&&s.check(e)?s.add(e):s.has(e)&&!s.check(e)&&s.remove(e);for(let e of t.disabled)s.has(e)&&s.remove(e);for(let e of t.deleted)s.has(e)&&s.remove(e)}this._engine.getEntityManager().markEntityChangesAsHandled()}getEngine(){return this._engine}*[Symbol.iterator](){for(let t of this._activeSystems)yield t}addSystem(t,e,s){e=e||0,this._systems[t.name]=t,this._activeSystems.add(e,t),t.init(this);let i=this.getEngine().getEntityManager();for(let e of i.entities)t.check(e)&&t.add(e)}removeSystem(t,e){if(t in this._systems){let e=this._systems[t];if(this._systems[t].active){let s=this._systemPriorities[t];this._activeSystems.delete(s,e)}delete this._systems[t],e.destroy()}}enableSystem(t,e){if(t in this._systems){let e=this._systems[t];return e.enable(),this._activeSystems.add(this._systemPriorities[t],e),!0}return!1}disableSystem(t,e){if(t in this._systems){let e=this._systems[t];return e.disable(),this._activeSystems.delete(this._systemPriorities[t],e),!0}return!1}getMessageBoard(){return this._messageBoard}}class l{constructor(t){this._initialized=!1,this._entityManager=new i(this),this._systemManager=new o(this),this._modules={},this._millisecPerUpdate=1e3,this._intervalKey=void 0,this._delta=0}getEntityManager(){return this._entityManager}getSystemManager(){return this._systemManager}get modules(){return this._modules}setModule(t,e){this.modules[t]=e}getModule(t){return this.modules[t]}applyModuleConfig(t){for(let e in this._modules)this.modules[e].init(t)}get running(){return void 0!==this._intervalKey}startLoop(t){void 0!==t&&(this._millisecPerUpdate=t),this._intervalKey=setInterval(()=>{this.update()},this._millisecPerUpdate)}pauseLoop(){clearInterval(this._intervalKey),this._intervalKey=void 0}update(){for(let t of this._systemManager)t.preUpdate();for(let t of this._systemManager)t.update();for(let t of this._systemManager)t.postUpdate();this.getEntityManager().processEntityOperations(),this.getSystemManager().processEntityOperations()}}Object.freeze(l.Modules);class d{constructor(){if(this.constructor===d)throw new TypeError("Components cannot be instantiated directly!")}get type(){return this.constructor.type}}class c extends d{constructor(t,e,s){super(),this.spriteNameList=t||[],this.styleNameList=e||[],this.relativePositionList=s||[],this.visible=!0}}c.type="AsciiRender";class u extends d{constructor(){super(),this._name=void 0,this._spriteNameList={},this._styleNameList={},this._relativePositionList={},this.visible=!0}get currentFrame(){return this._name}get spriteNameList(){return this._spriteNameList[this.currentFrame]}get styleNameList(){return this._styleNameList[this.currentFrame]}get relativePositionList(){return this._relativePositionList[this.currentFrame]}addFrame(t,e,s,i){console.assert(e.length===s.length&&e.length===i.length,"AsciiAnimateComponent inputs must be of the same length"),void 0===this._name&&(this._name=t),this._spriteNameList[t]=e,this._styleNameList[t]=s,this._relativePositionList[t]=i}setFrame(t){t in this._spriteNameList&&(this._name=t)}}u.type="AsciiAnimate";class _ extends d{constructor(t,e,s){super(),this.x=t||0,this.y=e||0,this.z=s||0}}_.type="PositionComponent";const g={AsciiRender:c,AsciiAnimate:u,Position:_};Object.freeze(g);class m extends r{constructor(t){if(super(t),this.constructor===m)throw new TypeError("SetSystem cannot be instantiated directly!");this.entities=new Set}has(t){return this.entities.has(t)}add(t){this.entities.add(t)}remove(t){this.entities.delete(t)}}const p={Graphics:Symbol("GraphicsLibrary"),ResourceManager:Symbol("ResourceManager")};class f extends m{constructor(t){super(t),this._asciiGl=null}startup(){this._asciiGl=this.getEngine().getModule(p.Graphics)}check(t){return(t.hasComponent(c.type)||t.hasComponent(u.type))&&t.hasComponent(_.type)}postUpdate(){let t=this.getEngine().getModule(p.ResourceManager);for(let e of this.entities){let s=e.getComponent(c.type)||e.getComponent(u.type);if(!s.visible)continue;let i=this.getEntityAbsolutePosition(e);for(let n=0;n<s.spriteNameList.length;n++){let r=t.get(s.spriteNameList[n]),a=[i[0]+s.relativePositionList[n][0],i[1]+s.relativePositionList[n][1],i[2]+s.relativePositionList[n][2]],h=t.get(s.styleNameList[n]);this._asciiGl.draw(r,a,h,e.id)}}this._asciiGl.render()}getEntityAbsolutePosition(t){let e=[0,0,0];for(;t;){if(t.hasComponent(_.type)){let s=t.getComponent(_.type);e[0]+=s.x,e[1]+=s.y,e[2]+=s.z}t=t.getParent()}return e}}f.type="AsciiRenderSystem";const y={Set:m,Map:class extends r{constructor(t){super(t),this.entities={}}has(t){return t.id in this.entities}add(t){this.entities[t.id]=t}remove(t){delete this.entities[t.id]}},AsciiRender:f};Object.freeze(y);class S{constructor(){this.ALL="ALL_KEYS",this._messageBoards={};for(let t in S.EventTypes){let e=S.EventTypes[t];this._messageBoards[e]=new a,document.addEventListener(e,t=>{document.activeElement!==document.body&&null!==document.activeElement||(this._messageBoards[e].post(e,t.key,t),this._messageBoards[e].post(e,this.ALL,t),(t.keyCode<=40&&t.keyCode>=37||32===t.keyCode)&&t.preventDefault())})}}signup(t,e){for(let s in this._messageBoards)this._messageBoards[s].signup(t,e)}withdraw(t){for(let e in this._messageBoards)this._messageBoards[e].withdraw(t)}subscribe(t,e,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].subscribe(t,[e]):console.warn("Keyboard event",i,"is not supported")}unsubscribe(t,e,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].unsubscribe(t,[e]):console.warn("Keyboard event",i,"is not supported")}}S.EventTypes={KEY_DOWN:"keydown",KEY_UP:"keyup"};class b{constructor(t,e){t=t||"",e=e||{},this._text=t,this._rowIndices=[],this._firstVisibleChar=[],this._width=0,this._height=1,this._segments=void 0,this._setAsBlank="",this._setAsBlankRegexp=null,this._spaceIsTransparent=!0,this._ignoreLeadingSpaces=!0,this._spaceHasFormatting=!1,"setAsBlank"in e&&(this._setAsBlank=e.setAsBlank),this._setAsBlankRegexp=new RegExp("["+this._setAsBlank+"]","g"),"spaceIsTransparent"in e&&(this._spaceIsTransparent=e.spaceIsTransparent),"ignoreLeadingSpaces"in e&&(this._ignoreLeadingSpaces=e.ignoreLeadingSpaces),"spaceHasFormatting"in e&&(this._spaceHasFormatting=e.spaceHasFormatting),this._parseSpriteShape(),this._parseSegmentData(),Object.freeze(this)}_parseSpriteShape(){let t=!1,e=0;for("\n"===this.text[0]&&(e=1),this._rowIndices.push(e),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:e);e<this.text.length;e++)"\n"===this.text[e]?(e-this._rowIndices[this._rowIndices.length-1]>this._width&&(this._width=Math.max(this._width,e-this._rowIndices[this._rowIndices.length-1])),this._rowIndices.push(e+1),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:e),t=!1):t||" "===this.text[e]||(t=!0,this._firstVisibleChar[this._firstVisibleChar.length-1]=e),e>1&&"\n"===this.text[e-1]&&this._height++;"\n"!==this.text.charAt(this.text.length-1)?(this._width=Math.max(this._width,this.text.length-this._rowIndices[this._rowIndices.length-1]),this._rowIndices.push(this.text.length+1)):this._rowIndices.push(this.text.length)}_parseSegmentData(){this._segments=new Array(this.height);for(let t=0;t<this.height;t++){this._segments[t]=[];let e=this._rowIndices[t],s=this._rowIndices[t+1]-1-e,i=this.ignoreLeadingSpaces?this._firstVisibleChar[t]-e:0,n=i,r=w.BLANK;for(;i<s;){let s=e+i,a=this.text[s],h=this._charState(a);h!==r&&(this._addSegment(n,i,t,r),n=i,r=h),i++}this._addSegment(n,i,t,r)}}_addSegment(t,e,s,i){i!==w.BLANK&&this._segments[s].push({x:t,y:s,length:e-t,visibleText:i===w.HAS_TEXT})}get text(){return this._text}get width(){return this._width}get height(){return this._height}get setAsBlank(){return this._setAsBlank}get spaceIsTransparent(){return this._spaceIsTransparent}get ignoreLeadingSpaces(){return this._ignoreLeadingSpaces}get spaceHasFormatting(){return this._spaceHasFormatting}*getItSpritePos(t,e,s,i){let n=Math.max(s,0),r=Math.min(i,this.height);if(!(s>=this.height||i<=0))for(let s=n;s<r;s++){if(void 0===this._firstVisibleChar[s])continue;let i=this._rowIndices[s],n=this._rowIndices[s+1]-1-i,r=this.ignoreLeadingSpaces?this._firstVisibleChar[s]-i:0;if(!(t>=n||e<=r))for(let i of this._segments[s]){let n=Math.max(i.x,t),r=Math.min(i.x+i.length,e);if(e<=n)break;r<=t||(yield{x:n,y:s,length:r-n,visibleText:i.visibleText})}}}*getItScreenPos(t,e,s,i,n,r){for(let a of this.getItSpritePos(s-t,s+n-t,i-e,i+r-e))a.x+=t,a.y+=e,yield a}_charHasFormatting(t){return" "!==t||!this.spaceIsTransparent||this.spaceHasFormatting}_charHasText(t){return" "!==t||!this.spaceIsTransparent}_charState(t){return this._charHasText(t)?w.HAS_TEXT:this._charHasFormatting(t)?w.HAS_FORMATTING:w.BLANK}substring(t,e,s){return this.text.substr(this._rowIndices[e]+t,s).replace(this._setAsBlankRegexp," ")}charAt(t,e){if(t<0||t>=this.width||e<0||e>=this.height)return"";let s=this._rowIndices[e];if(void 0===s)return"";if(t+s+1>=this._rowIndices[e+1])return"";if(this.ignoreLeadingSpaces&&t+s<this._firstVisibleChar[e])return"";let i=this.text[s+t];return this.spaceIsTransparent&&" "===i?"":this.text[s+t]}segmentLengthAt(t,e){let s=this._rowIndices[e],i=this._rowIndices[e+1]-1;if(s+t<this._firstVisibleChar[e])return 0;let n=this._charState(this.text[s+t]);if(n===w.BLANK)return 0;let r=t;for(t++;s+t<i;){if(this._charState(this.text[s+t])!==n)break;t++}return t-r}segmentAt(t,e,s){const i=this._rowIndices[e];let n=this.segmentLengthAt(t,e);return n=s&&s<n?s:n,this.text.substring(i+t,i+t+n).replace(this._setAsBlankRegexp," ")}}const w={BLANK:0,HAS_FORMATTING:1,HAS_TEXT:2};class v{constructor(){this._styles={};for(let t in v.defaultValues)this._styles[t]=null}freeze(){Object.freeze(this._styles),Object.freeze(this)}clear(){for(let t in v.defaultValues)this._styles[t]=null}copy(t){this.clear();for(let e of t)this.setStyle(e,t.getStyle(e))}sameAs(t){for(let e in v.defaultValues)if(this.hasStyle(e)!==t.hasStyle(e)||this.getStyle(e)!==t.getStyle(e))return!1;return!0}setStyle(t,e){t in v.defaultValues||console.warn("AsciiGL currently does not support the style",t),this._styles[t]=e||null}hasStyle(t){return null!==this._styles[t]}getStyle(t){return this.hasStyle(t)?this._styles[t]:""}*[Symbol.iterator](){for(let t in this._styles)this.hasStyle(t)&&(yield t)}fillRemainder(t){for(let e in v.defaultValues)this.hasStyle(e)||(t&&t.hasStyle(e)?this.setStyle(e,t.getStyle(e)):this.setStyle(e,v.defaultValues[e]))}}v.defaultValues={color:"black",backgroundColor:"transparent",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",cursor:"default"},v.setDefaultStyle=function(t,e){t in v.defaultValues?v.defaultValues[t]=e:console.warn("SpriteStyle does not support",t)};class E{constructor(){this.primaryElement=document.createElement("pre"),this._width=0,this._height=0,this.activeRowLength=[],this.rows=[],this.elements=[],this.primaryElement.style.margin="0"}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++){let e=document.createElement("div");e.dataset.asciiGlRow=s,this.primaryElement.appendChild(e),this.rows.push(e),this.elements.push([]),this.activeRowLength.push(0);for(let e=0;e<t;e++)this.elements[s].push(document.createElement("span"))}}get width(){return this._width}get height(){return this._height}getDomElement(){return this.primaryElement}setRowLength(t,e){if(e<this.activeRowLength[t])for(let s=this.activeRowLength[t]-1;s>=e;s--)this.rows[t].removeChild(this.elements[t][s]);else if(e>this.activeRowLength[t])for(let s=this.activeRowLength[t];s<e;s++)this.rows[t].appendChild(this.elements[t][s]);this.activeRowLength[t]=e}bind(t){for(let e=0;e<this.height;e++){let s=0,i=0;for(;s<this.width;){let n=this.elements[e][i],r=t.getSegmentLengthAt(s,e),a=t.getSpriteIdAt(s,e),h=void 0;h=void 0===a?" ".repeat(r):t.sprites[a].segmentAt(s-t.locations[a][0],e-t.locations[a][1],r),n.textContent=h;let o=t.getStyleAt(s,e);o.completed||o.fillRemainder(t.backgroundStyle);for(let t of o)n.style[t]=o.getStyle(t);n.dataset.asciiGlId=o.front,i++,s+=r}this.setRowLength(e,i)}}}class I{constructor(){this._width=0,this._height=0,this.rowComputedData=[],this.sprites={},this.locations={},this.backgroundStyle=new v,this.backgroundStyle.fillRemainder()}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++)this.rowComputedData.push(new x(s,t))}get width(){return this._width}get height(){return this._height}clear(){for(let t=0;t<this.height;t++)this.rowComputedData[t].clear();this.sprites={},this.locations={}}draw(t,e,s,i){for(let n of t.getItScreenPos(e[0],e[1],0,0,this.width,this.height)){let t=n.y;this.rowComputedData[t].loadSegment(n.length,n.x,s,e[2],i,n.visibleText)}this.sprites[i]=t,this.locations[i]=e}getStyleAt(t,e){return this.rowComputedData[e].getStyleAt(t)}getSegmentLengthAt(t,e){return this.rowComputedData[e].getSegmentLengthAt(t)}getSpriteIdAt(t,e){return this.rowComputedData[e].getSpriteIdAt(t)}}class x{constructor(t,e){this._width=e,this._rowNumber=t,this._textIds=new Array(e),this._textPriority=new Array(e),this._computedStyles=new Array(e),this._nextPointer=new Array(e);for(let t=0;t<this.width;t++)this._textIds[t]=void 0,this._textPriority[t]=Number.POSITIVE_INFINITY,this._computedStyles[t]=new M,this._nextPointer[t]=-1;this._nextPointer[0]=this.width}clear(){for(let t=1;t<this.width;t++)this._nextPointer[t]=-1;this._nextPointer[0]=this.width,this._computedStyles[0].clear(),this._textIds[0]=void 0,this._textPriority[0]=Number.POSITIVE_INFINITY}get row(){return this._rowNumber}get width(){return this._width}insertSegmentStart(t){if(-1===this._nextPointer[t]){this._computedStyles[t].clear(),this._textIds[t]=void 0;let e=t-1;for(;-1===this._nextPointer[e];)e--;this._nextPointer[t]=this._nextPointer[e],this._nextPointer[e]=t,this._computedStyles[t].copy(this._computedStyles[e]),this._textIds[t]=this._textIds[e],this._textPriority[t]=this._textPriority[e]}}loadSegment(t,e,s,i,n,r){let a=e+t;this.insertSegmentStart(e),this.insertSegmentStart(a);let h=e;do{this._computedStyles[h].addStyle(s,i,n),r&&this._textPriority[h]>i?(this._textIds[h]=n,this._textPriority[h]=i):r||(r=!1),h=this._nextPointer[h]}while(h<this.width&&h<a)}getStyleAt(t){for(;-1===this._nextPointer[t];)t--;return this._computedStyles[t]}getSegmentLengthAt(t){let e=t;for(;-1===this._nextPointer[e];)e--;return this._nextPointer[e]-t}getSpriteIdAt(t){for(;-1===this._nextPointer[t];)t--;return this._textIds[t]}}class M extends v{constructor(){super(),this._priorities={},this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=null,this.clear()}copy(t){for(let e in v.defaultValues)this._styles[e]=t._styles[e],this._priorities[e]=t._priorities[e];this._frontId=t._frontId,this._highestPriority=t._highestPriority}clear(){for(let t in v.defaultValues)this._styles[t]=null,this._priorities[t]=Number.POSITIVE_INFINITY;this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=null}get completed(){for(let t in v.defaultValues)if(null===this._styles[t])return!1;return!0}get front(){return this._frontId}addStyle(t,e,s){for(let s of t)this._priorities[s]>e&&(this.setStyle(s,t.getStyle(s)),this._priorities[s]=e);e<this._highestPriority&&(this._highestPriority=e,this._frontId=s)}sameAs(t){return super.sameAs(t)&&this.front===t.front}}const C={MOUSE_ENTER_CANVAS:"mouseentercanvas",MOUSE_LEAVE_CANVAS:"mouseleavecanvas",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_MOVE:"mousemove",MOUSE_ENTER:"mouseenter",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",CLICK:"click",CONTEXT_MENU:"contextmenu"};Object.freeze(C);const B={Instance:class{constructor(t){console.assert(t,"AsciiGL constructor requires a valid HTML element id parameter.");let e=document.getElementById(t);for(console.assert(e,"AsciiGL constructor parameter containerId does not correspond to a valid HTML element."),console.assert("DIV"===e.tagName,"Container element must be a DIV");e.lastChild;)e.removeChild(e.lastChild);e.style.textAlign="center";let s=document.createElement("DIV");s.style.display="inline-block",s.style.fontFamily="Courier New",s.style.fontSize="1em",s.style.userSelect="none",s.style.margin="0",e.appendChild(s),this._container=s,this._domBuffer=new E,this._nameBuffers=[{},{}],this._drawBufferIdx=0,this._activeBufferIdx=1,this._width=0,this._height=0,this._drawBuffer=new I,this._currMouseOver=void 0,this._handler=()=>{}}init(t,e){console.assert(t>0&&e>0,"AsciiGL must have positive dimensions."),this._width=t,this._height=e,this._drawBuffer.init(t,e),this._domBuffer.init(t,e),this._nameBuffers[0]={},this._nameBuffers[1]={},this._container.appendChild(this._domBuffer.getDomElement()),this._setupEventListeners(),this.render()}_setupEventListeners(){this._container.addEventListener("mouseenter",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mouseentercanvas",void 0,e);let s=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId];this._currMouseOver=s,s&&this._handler(t,"mouseenter",this._currMouseOver,e)}),this._container.addEventListener("mouseleave",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver,e),this._currMouseOver=void 0,this._handler(t,"mouseleavecanvas",void 0,e)}),this._container.addEventListener("mousemove",t=>{let e=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],s=this.mousePositionToCoordinates(t.clientX,t.clientY);e!==this._currMouseOver&&(this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver,s),this._currMouseOver=e,e&&this._handler(t,"mouseenter",this._currMouseOver,s)),this._handler(t,"mousemove",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],s)}),this._container.addEventListener("mousedown",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mousedown",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)}),this._container.addEventListener("mouseup",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mouseup",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)}),this._container.addEventListener("click",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"click",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)}),this._container.addEventListener("contextmenu",t=>{t.preventDefault();let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"contextmenu",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)})}mousePositionToCoordinates(t,e){let s=this._container.getBoundingClientRect();return{x:Math.floor((t-s.x)*this.width/s.width),y:Math.floor((e-s.y)*this.height/s.height)}}_flipBuffers(){this._drawBufferIdx=1-this._drawBufferIdx,this._activeBufferIdx=1-this._activeBufferIdx}get width(){return this._width}get height(){return this._height}get backgroundStyles(){return this._drawBuffer.backgroundStyle}getBackgroundStyle(t){return this._drawBuffer.backgroundStyle.getStyle(t)}setBackgroundStyle(t,e){this._drawBuffer.backgroundStyle.setStyle(t,e)}setHandler(t){this._handler=t}draw(e,s,i,n){let r=t.generateId(n);this._drawBuffer.draw(e,s,i,r),n&&(this._nameBuffers[this._drawBufferIdx][r]=n)}render(){this._domBuffer.bind(this._drawBuffer),this._drawBuffer.clear(),this._nameBuffers[this._activeBufferIdx]={},this._flipBuffers()}},Sprite:b,SpriteStyle:v,SpriteBuilder:class{constructor(t){this._template=t,this._paramCount=t.length-1}construct(t){let e="";for(let s=0;s<this._template.length;s++)e+=this._template[s],s<this._paramCount&&(e+=t[s]);return new b(e)}},EventTypes:C};Object.freeze(B);class L{constructor(t){this.GLOBAL=L.Global,this._agl=t,this._registeredTargets={},this._messageBoards={};for(let t in B.EventTypes)this._messageBoards[B.EventTypes[t]]=new a;t.setHandler((t,e,s,i)=>{void 0!==s&&this._messageBoards[e].post(e,s,{type:e,target:s,event:t,coords:i}),this._messageBoards[e].post(e,this.GLOBAL,{type:e,target:s,event:t,coords:i})})}signup(t,e){for(let s in this._messageBoards)this._messageBoards[s].signup(t,e)}withdraw(t){for(let e in this._messageBoards)this._messageBoards[e].withdraw(t)}subscribe(t,e,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].subscribe(t,[e]):console.warn("Message type",i,"not supported")}unsubscribe(t,e,s){for(let i of s)i in this._messageBoards?this._messageBoards[i].unsubscribe(t,[e]):console.warn("Message type",i,"not supported")}}L.Global=Symbol("Global");const A={loadFileAsString:async function(t){return await async function(t){return new Promise((function(e,s){let i=new XMLHttpRequest;i.open("GET",t),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){let t=i.responseText;e(t)}else console.error("HTTP Request returned status code: ",i.status)},i.send()}))}(t)}};Object.freeze(A);const T={getSpriteData:function(t){let e=JSON.parse(t),s=e.sprites,i={};for(let t in s)i[t]=new b(s[t].text,s[t].settings);let n=e.styles,r={};for(let t in n){let e=new v;for(let s in n[t])e.setStyle(s,n[t][s]);r[t]=e}return{sprites:i,styles:r}},getComponentFactories:function(t){let e=JSON.parse(t),s={};for(let t in e){let i=e[t];s[t]=new P(i)}return s}};class P{constructor(t){this.specs=t}construct(){let t=new u;for(let e in this.specs)t.addFrame(e,[...this.specs[e].spriteNameList],[...this.specs[e].styleNameList],[...this.specs[e].relativePositionList]);return t}}Object.freeze(T);const O={KeyboardInput:S,AsciiMouseInput:L,ResourceManager:class{constructor(){this.data={}}add(t,e){this.data[t]=e}delete(t){this.has(t)&&delete this.data[t]}has(t){return t in this.data}get(t){return t in this.data||console.warn("Resource key: ",t,"not found"),this.data[t]}async loadSpriteFiles(t){for(let e of t){let t=await A.loadFileAsString(e),s=T.getSpriteData(t);for(let t in s.sprites)this.add(t,s.sprites[t]);for(let t in s.styles)this.add(t,s.styles[t])}}async loadTemplateFiles(t){for(let e of t){let t=await A.loadFileAsString(e),s=T.getComponentFactories(t);for(let t in s)this.add(t,s[t])}}}};Object.freeze(O);const N={Parser:T,AssetLoader:A,MessageBoard:a,MessageReceiver:n};Object.freeze(N);const z={Engine:l,Entity:class{constructor(e){this._name=e,this._id=t.generateId(this._name),this._initialized=!1,this._entityManager=void 0,this._components={},this._parent=void 0,this._children={},this._changed=!0,this._enabled=!0,this._ancestorsEnabled=!0}clone(){}init(t){this._initialized=!0,this._entityManager=t,this._entityManager.notifyAddition(this);for(let e in this._children)this._children[e].init(t)}get initialized(){return this._initialized}destroy(){for(let t in this._children)this._children[t].destroy();this._parent&&delete this._parent._children[this.id],this.initialized&&this._entityManager.notifyDeletion(this)}setParent(t){this._parent=t}getParent(){return this._parent}get name(){return this._name}get id(){return this._id}setComponent(t){this.initialized?this._entityManager.requestSetComponent(this,t):this._setComponent(t)}_setComponent(t){this._components[t.type]=t,this.initialized&&this._entityManager.notifyComponentChange(this,t)}getComponent(t){return this.hasComponent(t)?this._components[t]:null}hasComponent(t){return t in this._components}deleteComponent(t){this.initialized&&this.hasComponent(t)?this._entityManager.requestDeleteComponent(this,t):this._deleteComponent(t)}_deleteComponent(t){this.hasComponent(t)?(delete this._components[t],this.initialized&&this._entityManager.notifyComponentChange(this)):console.warn("Entity",this.id,"does not have component of type ",t)}addChild(t){this.initialized?this._entityManager.requestAddEntity(t,this):this._addChild(t)}_addChild(t){this._children[t.id]=t,t.setParent(this)}removeChild(t){this.initialized&&this._children}_removeChild(t){}markForDeletion(){this.initialized?this._entityManager.requestDeleteEntity(this):this.destroy()}enable(t){this.initialized?this._entityManager.requestEnable(this,t):this._enable(t)}_enable(t){if(this._entityManager.notifyEnable(this),t)for(let e in this._children)this._children[e]._enable(t)}disable(t){this.initialized?this._entityManager.requestDisable(this,t):this._disable(t)}_disable(t){if(this._entityManager.notifyDisable(this),t)for(let e in this._children)this._children[e]._disable(t)}},Component:d,Components:g,System:r,Systems:y,Modules:O,ModuleSlots:p,GL:B,Utility:N};return Object.freeze(z),z}();
