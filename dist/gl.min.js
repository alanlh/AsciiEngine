var AsciiGL=function(){"use strict";class t{constructor(t,e){t=t||"",e=e||{},this._text=t,this._rowIndices=[],this._firstVisibleChar=[],this._width=0,this._height=1,this._segments=void 0,this._setAsBlank="",this._setAsBlankRegexp=null,this._spaceIsTransparent=!0,this._ignoreLeadingSpaces=!0,this._spaceHasFormatting=!1,"setAsBlank"in e&&(this._setAsBlank=e.setAsBlank),this._setAsBlankRegexp=new RegExp("["+this._setAsBlank+"]","g"),"spaceIsTransparent"in e&&(this._spaceIsTransparent=e.spaceIsTransparent),"ignoreLeadingSpaces"in e&&(this._ignoreLeadingSpaces=e.ignoreLeadingSpaces),"spaceHasFormatting"in e&&(this._spaceHasFormatting=e.spaceHasFormatting),this._parseSpriteShape(),this._parseSegmentData(),Object.freeze(this)}_parseSpriteShape(){let t=!1,e=0;for("\n"===this.text[0]&&(e=1),this._rowIndices.push(e),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:e);e<this.text.length;e++)"\n"===this.text[e]?(e-this._rowIndices[this._rowIndices.length-1]>this._width&&(this._width=Math.max(this._width,e-this._rowIndices[this._rowIndices.length-1])),this._rowIndices.push(e+1),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:e),t=!1):t||" "===this.text[e]||(t=!0,this._firstVisibleChar[this._firstVisibleChar.length-1]=e),e>1&&"\n"===this.text[e-1]&&this._height++;"\n"!==this.text.charAt(this.text.length-1)?(this._width=Math.max(this._width,this.text.length-this._rowIndices[this._rowIndices.length-1]),this._rowIndices.push(this.text.length+1)):this._rowIndices.push(this.text.length)}_parseSegmentData(){this._segments=new Array(this.height);for(let t=0;t<this.height;t++){this._segments[t]=[];let s=this._rowIndices[t],i=this._rowIndices[t+1]-1-s,r=this.ignoreLeadingSpaces?this._firstVisibleChar[t]-s:0,h=r,n=e.BLANK;for(;r<i;){let e=s+r,i=this.text[e],a=this._charState(i);a!==n&&(this._addSegment(h,r,t,n),h=r,n=a),r++}this._addSegment(h,r,t,n)}}_addSegment(t,s,i,r){r!==e.BLANK&&this._segments[i].push({x:t,y:i,length:s-t,visibleText:r===e.HAS_TEXT})}get text(){return this._text}get width(){return this._width}get height(){return this._height}get setAsBlank(){return this._setAsBlank}get spaceIsTransparent(){return this._spaceIsTransparent}get ignoreLeadingSpaces(){return this._ignoreLeadingSpaces}get spaceHasFormatting(){return this._spaceHasFormatting}*getItSpritePos(t,e,s,i){let r=Math.max(s,0),h=Math.min(i,this.height);if(!(s>=this.height||i<=0))for(let s=r;s<h;s++){if(void 0===this._firstVisibleChar[s])continue;let i=this._rowIndices[s],r=this._rowIndices[s+1]-1-i,h=this.ignoreLeadingSpaces?this._firstVisibleChar[s]-i:0;if(!(t>=r||e<=h))for(let i of this._segments[s]){let r=Math.max(i.x,t),h=Math.min(i.x+i.length,e);if(e<=r)break;h<=t||(yield{x:r,y:s,length:h-r,visibleText:i.visibleText})}}}*getItScreenPos(t,e,s,i,r,h){for(let n of this.getItSpritePos(s-t,s+r-t,i-e,i+h-e))n.x+=t,n.y+=e,yield n}_charHasFormatting(t){return" "!==t||!this.spaceIsTransparent||this.spaceHasFormatting}_charHasText(t){return" "!==t||!this.spaceIsTransparent}_charState(t){return this._charHasText(t)?e.HAS_TEXT:this._charHasFormatting(t)?e.HAS_FORMATTING:e.BLANK}substring(t,e,s){return this.text.substr(this._rowIndices[e]+t,s).replace(this._setAsBlankRegexp," ")}charAt(t,e){if(t<0||t>=this.width||e<0||e>=this.height)return"";let s=this._rowIndices[e];if(void 0===s)return"";if(t+s+1>=this._rowIndices[e+1])return"";if(this.ignoreLeadingSpaces&&t+s<this._firstVisibleChar[e])return"";let i=this.text[s+t];return this.spaceIsTransparent&&" "===i?"":this.text[s+t]}segmentLengthAt(t,s){let i=this._rowIndices[s],r=this._rowIndices[s+1]-1;if(i+t<this._firstVisibleChar[s])return 0;let h=this._charState(this.text[i+t]);if(h===e.BLANK)return 0;let n=t;for(t++;i+t<r;){if(this._charState(this.text[i+t])!==h)break;t++}return t-n}segmentAt(t,e,s){const i=this._rowIndices[e];let r=this.segmentLengthAt(t,e);return r=s&&s<r?s:r,this.text.substring(i+t,i+t+r).replace(this._setAsBlankRegexp," ")}}const e={BLANK:0,HAS_FORMATTING:1,HAS_TEXT:2};class s{constructor(){this._styles={};for(let t in s.defaultValues)this._styles[t]=null}freeze(){Object.freeze(this._styles),Object.freeze(this)}clear(){for(let t in s.defaultValues)this._styles[t]=null}copy(t){this.clear();for(let e of t)this.setStyle(e,t.getStyle(e))}sameAs(t){for(let e in s.defaultValues)if(this.hasStyle(e)!==t.hasStyle(e)||this.getStyle(e)!==t.getStyle(e))return!1;return!0}setStyle(t,e){t in s.defaultValues||console.warn("AsciiGL currently does not support the style",t),this._styles[t]=e||null}hasStyle(t){return null!==this._styles[t]}getStyle(t){return this.hasStyle(t)?this._styles[t]:""}*[Symbol.iterator](){for(let t in this._styles)this.hasStyle(t)&&(yield t)}fillRemainder(t){for(let e in s.defaultValues)this.hasStyle(e)||(t&&t.hasStyle(e)?this.setStyle(e,t.getStyle(e)):this.setStyle(e,s.defaultValues[e]))}}s.defaultValues={color:"black",backgroundColor:"transparent",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",cursor:"default"},s.setDefaultStyle=function(t,e){t in s.defaultValues?s.defaultValues[t]=e:console.warn("SpriteStyle does not support",t)};class i{constructor(){this.primaryElement=document.createElement("pre"),this._width=0,this._height=0,this.activeRowLength=[],this.rows=[],this.elements=[],this.primaryElement.style.margin="0"}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++){let e=document.createElement("div");e.dataset.asciiGlRow=s,this.primaryElement.appendChild(e),this.rows.push(e),this.elements.push([]),this.activeRowLength.push(0);for(let e=0;e<t;e++)this.elements[s].push(document.createElement("span"))}}get width(){return this._width}get height(){return this._height}getDomElement(){return this.primaryElement}setRowLength(t,e){if(e<this.activeRowLength[t])for(let s=this.activeRowLength[t]-1;s>=e;s--)this.rows[t].removeChild(this.elements[t][s]);else if(e>this.activeRowLength[t])for(let s=this.activeRowLength[t];s<e;s++)this.rows[t].appendChild(this.elements[t][s]);this.activeRowLength[t]=e}bind(t){for(let e=0;e<this.height;e++){let s=0,i=0;for(;s<this.width;){let r=this.elements[e][i],h=t.getSegmentLengthAt(s,e),n=t.getSpriteIdAt(s,e),a=void 0;a=void 0===n?" ".repeat(h):t.sprites[n].segmentAt(s-t.locations[n][0],e-t.locations[n][1],h),r.textContent=a;let o=t.getStyleAt(s,e);o.completed||o.fillRemainder(t.backgroundStyle);for(let t of o)r.style[t]=o.getStyle(t);r.dataset.asciiGlId=o.front,i++,s+=h}this.setRowLength(e,i)}}}class r{constructor(){this._width=0,this._height=0,this.rowComputedData=[],this.sprites={},this.locations={},this.backgroundStyle=new s,this.backgroundStyle.fillRemainder()}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++)this.rowComputedData.push(new h(s,t))}get width(){return this._width}get height(){return this._height}clear(){for(let t=0;t<this.height;t++)this.rowComputedData[t].clear();this.sprites={},this.locations={}}draw(t,e,s,i){for(let r of t.getItScreenPos(e[0],e[1],0,0,this.width,this.height)){let t=r.y;this.rowComputedData[t].loadSegment(r.length,r.x,s,e[2],i,r.visibleText)}this.sprites[i]=t,this.locations[i]=e}getStyleAt(t,e){return this.rowComputedData[e].getStyleAt(t)}getSegmentLengthAt(t,e){return this.rowComputedData[e].getSegmentLengthAt(t)}getSpriteIdAt(t,e){return this.rowComputedData[e].getSpriteIdAt(t)}}class h{constructor(t,e){this._width=e,this._rowNumber=t,this._textIds=new Array(e),this._textPriority=new Array(e),this._computedStyles=new Array(e),this._nextPointer=new Array(e);for(let t=0;t<this.width;t++)this._textIds[t]=void 0,this._textPriority[t]=Number.POSITIVE_INFINITY,this._computedStyles[t]=new n,this._nextPointer[t]=-1;this._nextPointer[0]=this.width}clear(){for(let t=1;t<this.width;t++)this._nextPointer[t]=-1;this._nextPointer[0]=this.width,this._computedStyles[0].clear(),this._textIds[0]=void 0,this._textPriority[0]=Number.POSITIVE_INFINITY}get row(){return this._rowNumber}get width(){return this._width}insertSegmentStart(t){if(-1===this._nextPointer[t]){this._computedStyles[t].clear(),this._textIds[t]=void 0;let e=t-1;for(;-1===this._nextPointer[e];)e--;this._nextPointer[t]=this._nextPointer[e],this._nextPointer[e]=t,this._computedStyles[t].copy(this._computedStyles[e]),this._textIds[t]=this._textIds[e],this._textPriority[t]=this._textPriority[e]}}loadSegment(t,e,s,i,r,h){let n=e+t;this.insertSegmentStart(e),this.insertSegmentStart(n);let a=e;do{this._computedStyles[a].addStyle(s,i,r),h&&this._textPriority[a]>i?(this._textIds[a]=r,this._textPriority[a]=i):h||(h=!1),a=this._nextPointer[a]}while(a<this.width&&a<n)}getStyleAt(t){for(;-1===this._nextPointer[t];)t--;return this._computedStyles[t]}getSegmentLengthAt(t){let e=t;for(;-1===this._nextPointer[e];)e--;return this._nextPointer[e]-t}getSpriteIdAt(t){for(;-1===this._nextPointer[t];)t--;return this._textIds[t]}}class n extends s{constructor(){super(),this._priorities={},this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=null,this.clear()}copy(t){for(let e in s.defaultValues)this._styles[e]=t._styles[e],this._priorities[e]=t._priorities[e];this._frontId=t._frontId,this._highestPriority=t._highestPriority}clear(){for(let t in s.defaultValues)this._styles[t]=null,this._priorities[t]=Number.POSITIVE_INFINITY;this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=null}get completed(){for(let t in s.defaultValues)if(null===this._styles[t])return!1;return!0}get front(){return this._frontId}addStyle(t,e,s){for(let s of t)this._priorities[s]>e&&(this.setStyle(s,t.getStyle(s)),this._priorities[s]=e);e<this._highestPriority&&(this._highestPriority=e,this._frontId=s)}sameAs(t){return super.sameAs(t)&&this.front===t.front}}const a={generateId:function(){let t=0;return function(e){return void 0===e&&(e="AsciiEngine"),t++,e+"_"+t}}(),clamp:function(t,e,s){return Math.max(e,Math.min(t,s))}};Object.freeze(a);const o={MOUSE_ENTER_CANVAS:"mouseentercanvas",MOUSE_LEAVE_CANVAS:"mouseleavecanvas",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_MOVE:"mousemove",MOUSE_ENTER:"mouseenter",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",CLICK:"click",CONTEXT_MENU:"contextmenu"};Object.freeze(o);const l={Instance:class{constructor(t){console.assert(t,"AsciiGL constructor requires a valid HTML element id parameter.");let e=document.getElementById(t);for(console.assert(e,"AsciiGL constructor parameter containerId does not correspond to a valid HTML element."),console.assert("DIV"===e.tagName,"Container element must be a DIV");e.lastChild;)e.removeChild(e.lastChild);e.style.textAlign="center";let s=document.createElement("DIV");s.style.display="inline-block",s.style.fontFamily="Courier New",s.style.fontSize="1em",s.style.userSelect="none",s.style.margin="0",e.appendChild(s),this._container=s,this._domBuffer=new i,this._nameBuffers=[{},{}],this._drawBufferIdx=0,this._activeBufferIdx=1,this._width=0,this._height=0,this._drawBuffer=new r,this._currMouseOver=void 0,this._handler=()=>{}}init(t,e){console.assert(t>0&&e>0,"AsciiGL must have positive dimensions."),this._width=t,this._height=e,this._drawBuffer.init(t,e),this._domBuffer.init(t,e),this._nameBuffers[0]={},this._nameBuffers[1]={},this._container.appendChild(this._domBuffer.getDomElement()),this._setupEventListeners(),this.render()}_setupEventListeners(){this._container.addEventListener("mouseenter",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mouseentercanvas",void 0,e);let s=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId];this._currMouseOver=s,s&&this._handler(t,"mouseenter",this._currMouseOver,e)}),this._container.addEventListener("mouseleave",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver,e),this._currMouseOver=void 0,this._handler(t,"mouseleavecanvas",void 0,e)}),this._container.addEventListener("mousemove",t=>{let e=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],s=this.mousePositionToCoordinates(t.clientX,t.clientY);e!==this._currMouseOver&&(this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver,s),this._currMouseOver=e,e&&this._handler(t,"mouseenter",this._currMouseOver,s)),this._handler(t,"mousemove",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],s)}),this._container.addEventListener("mousedown",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mousedown",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)}),this._container.addEventListener("mouseup",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mouseup",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)}),this._container.addEventListener("click",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"click",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)}),this._container.addEventListener("contextmenu",t=>{t.preventDefault();let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"contextmenu",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)})}mousePositionToCoordinates(t,e){let s=this._container.getBoundingClientRect();return{x:Math.floor((t-s.x)*this.width/s.width),y:Math.floor((e-s.y)*this.height/s.height)}}_flipBuffers(){this._drawBufferIdx=1-this._drawBufferIdx,this._activeBufferIdx=1-this._activeBufferIdx}get width(){return this._width}get height(){return this._height}get backgroundStyles(){return this._drawBuffer.backgroundStyle}getBackgroundStyle(t){return this._drawBuffer.backgroundStyle.getStyle(t)}setBackgroundStyle(t,e){this._drawBuffer.backgroundStyle.setStyle(t,e)}setHandler(t){this._handler=t}draw(t,e,s,i){let r=a.generateId(i);this._drawBuffer.draw(t,e,s,r),i&&(this._nameBuffers[this._drawBufferIdx][r]=i)}render(){this._domBuffer.bind(this._drawBuffer),this._drawBuffer.clear(),this._nameBuffers[this._activeBufferIdx]={},this._flipBuffers()}},Sprite:t,SpriteStyle:s,SpriteBuilder:class{constructor(t){this._template=t,this._paramCount=t.length-1}construct(e){let s="";for(let t=0;t<this._template.length;t++)s+=this._template[t],t<this._paramCount&&(s+=e[t]);return new t(s)}},EventTypes:o};return Object.freeze(l),l}();
