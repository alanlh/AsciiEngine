var AsciiGL=function(){"use strict";class t{constructor(t,e){t=t||"",e=e||{},this._text=t,this._rowIndices=[],this._firstVisibleChar=[],this._width=0,this._height=1;let s=!1,i=0;for("\n"===t[0]&&(i=1),this._rowIndices.push(i);i<t.length;i++)"\n"===t[i]?(i-this._rowIndices[this._rowIndices.length-1]>this._width&&(this._width=Math.max(this._width,i-this._rowIndices[this._rowIndices.length-1])),this._rowIndices.push(i+1),s=!1):s||" "===t[i]||(s=!0,this._firstVisibleChar.push(i)),i>1&&"\n"===t[i-1]&&this._height++;"\n"!==t.charAt(t.length-1)?(this._width=Math.max(this._width,t.length-this._rowIndices[this._rowIndices.length-1]),this._rowIndices.push(t.length+1)):this._rowIndices.push(t.length),this._setAsBlank="",this._setAsBlankRegexp=null,this._spaceIsTransparent=!0,this._ignoreLeadingSpaces=!0,"setAsBlank"in e&&(this._setAsBlank=e.setAsBlank),this._setAsBlankRegexp=new RegExp("["+this._setAsBlank+"]","g"),"spaceIsTransparent"in e&&(this._spaceIsTransparent=e.spaceIsTransparent),"ignoreLeadingSpaces"in e&&(this._ignoreLeadingSpaces=e.ignoreLeadingSpaces),Object.freeze(this)}get text(){return this._text}get width(){return this._width}get height(){return this._height}get setAsBlank(){return this._setAsBlank}get spaceIsTransparent(){return this._spaceIsTransparent}get ignoreLeadingSpaces(){return this._ignoreLeadingSpaces}charAt(t,e){if(t<0||t>=this.width||e<0||e>=this.height)return"";let s=this._rowIndices[e];if(t+s+1>=this._rowIndices[e+1])return"";if(this.ignoreLeadingSpaces&&t+s<this._firstVisibleChar[e])return"";let i=this.text[s+t];return this.spaceIsTransparent&&" "===i?"":this.text[s+t]}segmentLengthAt(t,e){if(0===this.charAt(t,e).length)return 0;const s=this._rowIndices[e],i=s+t;for(;s+t+1<this._rowIndices[e+1];){t++;let e=this.text[s+t];if("\n"===e)break;if(" "===e&&this.spaceIsTransparent)break}return s+t-i}segmentAt(t,e,s){const i=this._rowIndices[e];let r=this.segmentLengthAt(t,e);return r=s&&s<r?s:r,this.text.substring(i+t,i+t+r).replace(this._setAsBlankRegexp," ")}}t.RENDER_LEVELS={};class e{constructor(){this._styles={};for(let t in e.defaultValues)this._styles[t]=null}freeze(){Object.freeze(this._styles),Object.freeze(this)}clear(){for(let t in e.defaultValues)this._styles[t]=null}copy(t){this.clear();for(let e of t)this.setStyle(e,t.getStyle(e))}sameAs(t){for(let s in e.defaultValues)if(this.hasStyle(s)!==t.hasStyle(s)||this.getStyle(s)!==t.getStyle(s))return!1;return!0}setStyle(t,s){t in e.defaultValues||console.warn("AsciiGL currently does not support the style",t),this._styles[t]=s||null}hasStyle(t){return null!==this._styles[t]}getStyle(t){return this.hasStyle(t)?this._styles[t]:""}*[Symbol.iterator](){for(let t in this._styles)this.hasStyle(t)&&(yield t)}fillRemainder(t){for(let s in e.defaultValues)this.hasStyle(s)||(t&&t.hasStyle(s)?this.setStyle(s,t.getStyle(s)):this.setStyle(s,e.defaultValues[s]))}}e.defaultValues={color:"black",backgroundColor:"transparent",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",cursor:"default"},e.setDefaultStyle=function(t,s){t in e.defaultValues?e.defaultValues[t]=s:console.warn("SpriteStyle does not support",t)};class s{constructor(){this.primaryElement=document.createElement("pre"),this._width=0,this._height=0,this.activeRowLength=[],this.rows=[],this.elements=[]}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++){let e=document.createElement("div");this.primaryElement.appendChild(e),this.rows.push(e),this.elements.push([]),this.activeRowLength.push(0);for(let e=0;e<t;e++)this.elements[s].push(document.createElement("span"))}}get width(){return this._width}get height(){return this._height}getDomElement(){return this.primaryElement}setRowLength(t,e){if(e<this.activeRowLength[t])for(let s=this.activeRowLength[t]-1;s>=e;s--)this.rows[t].removeChild(this.elements[t][s]);else if(e>this.activeRowLength[t])for(let s=this.activeRowLength[t];s<e;s++)this.rows[t].appendChild(this.elements[t][s]);this.activeRowLength[t]=e}bind(t){for(let e=0;e<this.height;e++){let s=0,i=0;for(;s<this.width;){let r=this.elements[e][i],h=t.getSegmentLengthAt(s,e),n=t.getStyleAt(s,e),a=n.front,l=null;l=null===a?" ".repeat(h):t.sprites[a].segmentAt(s-t.locations[a][0],e-t.locations[a][1],h),r.textContent=l,r.dataset.asciiGlId=a,n.completed||n.fillRemainder(t.backgroundStyle);for(let t of n)r.style[t]=n.getStyle(t);i++,s+=h}this.setRowLength(e,i)}}}class i{constructor(){this._width=0,this._height=0,this.computedStyles=[],this.sprites={},this.locations={},this.backgroundStyle=new e,this.backgroundStyle.fillRemainder()}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++)this.computedStyles.push(new r(s,t))}get width(){return this._width}get height(){return this._height}clear(){for(let t=0;t<this.height;t++)this.computedStyles[t].clear();this.sprites={},this.locations={}}draw(t,e,s,i){let r=Math.max(e[0],0),h=Math.max(e[1],0),n=Math.min(e[0]+t.width,this.width),a=Math.min(e[1]+t.height,this.height);for(let l=h;l<a;l++){let h=r;for(;h<n;){let r=t.segmentLengthAt(h-e[0],l-e[1]);r>0?(this.computedStyles[l].loadSegment(r,h,s,e[2],i),h+=r):h++}}this.sprites[i]=t,this.locations[i]=e}getStyleAt(t,e){return this.computedStyles[e].getStyleAt(t)}getSegmentLengthAt(t,e){return this.computedStyles[e].getSegmentLengthAt(t)}}class r{constructor(t,e){this._width=e,this._rowNumber=t,this._computedStyles=new Array(e),this._nextPointer=new Array(e);for(let t=0;t<this.width;t++)this._computedStyles[t]=new h,this._nextPointer[t]=-1;this._nextPointer[0]=this.width}clear(){for(let t=1;t<this.width;t++)this._nextPointer[t]=-1;this._nextPointer[0]=this.width,this._computedStyles[0].clear()}get row(){return this._rowNumber}get width(){return this._width}insertSegmentStart(t){if(-1===this._nextPointer[t]){this._computedStyles[t].clear();let e=t-1;for(;-1===this._nextPointer[e];)e--;this._nextPointer[t]=this._nextPointer[e],this._nextPointer[e]=t,this._computedStyles[t].copy(this._computedStyles[e])}}loadSegment(t,e,s,i,r){let h=e+t;this.insertSegmentStart(e),this.insertSegmentStart(h),this._computedStyles[e].addStyle(s,i,r);let n=this._nextPointer[e];for(;n<this.width&&n<h;)this._computedStyles[n].addStyle(s,i,r),n=this._nextPointer[n]}getStyleAt(t){for(;-1===this._nextPointer[t];)t--;return this._computedStyles[t]}getSegmentLengthAt(t){let e=t;for(;-1===this._nextPointer[e];)e--;return this._nextPointer[e]-t}}class h extends e{constructor(){super(),this._priorities={},this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=null,this.clear()}copy(t){for(let s in e.defaultValues)this._styles[s]=t._styles[s],this._priorities[s]=t._priorities[s];this._frontId=t._frontId,this._highestPriority=t._highestPriority}clear(){for(let t in e.defaultValues)this._styles[t]=null,this._priorities[t]=Number.POSITIVE_INFINITY;this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=null}get completed(){for(let t in e.defaultValues)if(null===this._styles[t])return!1;return!0}get front(){return this._frontId}addStyle(t,e,s){for(let s of t)this._priorities[s]>e&&(this.setStyle(s,t.getStyle(s)),this._priorities[s]=e);e<this._highestPriority&&(this._highestPriority=e,this._frontId=s)}sameAs(t){return super.sameAs(t)&&this.front===t.front}}const n={generateId:function(){let t=0;return function(e){return void 0===e&&(e="AsciiEngine"),t++,e+"_"+t}}(),clamp:function(t,e,s){return Math.max(e,Math.min(t,s))}};Object.freeze(n);const a={MOUSE_ENTER_CANVAS:"mouseentercanvas",MOUSE_LEAVE_CANVAS:"mouseleavecanvas",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_MOVE:"mousemove",MOUSE_ENTER:"mouseenter",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",CLICK:"click",CONTEXT_MENU:"contextmenu"};Object.freeze(a);const l={Instance:class{constructor(t){console.assert(t,"AsciiGL constructor requires a valid HTML element id parameter.");let e=document.getElementById(t);for(console.assert(e,"AsciiGL constructor parameter containerId does not correspond to a valid HTML element."),console.assert("DIV"===e.tagName,"Container element must be a DIV");e.lastChild;)e.removeChild(e.lastChild);e.style.textAlign="center";let r=document.createElement("DIV");r.style.display="inline-block",r.style.fontFamily="Courier New",r.style.fontSize="1em",r.style.userSelect="none",e.appendChild(r),this._container=r,this._domBuffer=new s,this._nameBuffers=[{},{}],this._drawBufferIdx=0,this._activeBufferIdx=1,this._width=0,this._height=0,this._drawBuffer=new i,this._currMouseOver=void 0,this._handler=()=>{}}init(t,e){console.assert(t>0&&e>0,"AsciiGL must have positive dimensions."),this._width=t,this._height=e,this._drawBuffer.init(t,e),this._domBuffer.init(t,e),this._nameBuffers[0]={},this._nameBuffers[1]={},this._container.appendChild(this._domBuffer.getDomElement()),this._setupEventListeners(),this.render()}_setupEventListeners(){this._container.addEventListener("mouseenter",t=>{this._handler(t,"mouseentercanvas");let e=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId];this._currMouseOver=e,e&&this._handler(t,"mouseenter",this._currMouseOver)}),this._container.addEventListener("mouseleave",t=>{this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver),this._currMouseOver=void 0,this._handler(t,"mouseleavecanvas")}),this._container.addEventListener("mousemove",t=>{let e=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId];e!==this._currMouseOver&&(this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver),this._currMouseOver=e,e&&this._handler(t,"mouseenter",this._currMouseOver)),this._handler(t,"mousemove",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId])}),this._container.addEventListener("mousedown",t=>{this._handler(t,"mousedown",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId])}),this._container.addEventListener("mouseup",t=>{this._handler(t,"mouseup",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId])}),this._container.addEventListener("click",t=>{this._handler(t,"click",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId])}),this._container.addEventListener("contextmenu",t=>{t.preventDefault(),this._handler(t,"contextmenu",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId])})}_flipBuffers(){this._drawBufferIdx=1-this._drawBufferIdx,this._activeBufferIdx=1-this._activeBufferIdx}get width(){return this._width}get height(){return this._height}get backgroundStyles(){return this._drawBuffer.backgroundStyle}getBackgroundStyle(t){return this._drawBuffer.backgroundStyle.getStyle(t)}setBackgroundStyle(t,e){this._drawBuffer.backgroundStyle.setStyle(t,e)}setHandler(t){this._handler=t}draw(t,e,s,i){let r=n.generateId(i);this._drawBuffer.draw(t,e,s,r),i&&(this._nameBuffers[this._drawBufferIdx][r]=i)}render(){this._domBuffer.bind(this._drawBuffer),this._drawBuffer.clear(),this._nameBuffers[this._activeBufferIdx]={},this._flipBuffers()}},Sprite:t,SpriteStyle:e,SpriteBuilder:class{constructor(t){this._template=t,this._paramCount=t.length-1}construct(e){let s="";for(let t=0;t<this._template.length;t++)s+=this._template.length,t<this._paramCount&&(s+=e[t]);return new t(s)}},EventTypes:a};return Object.freeze(l),l}();
