class t{constructor(t,e){t=t||"",e=e||{},this._text=t,this._rowIndices=[],this._firstVisibleChar=[],this._width=0,this._height=1,this._segments=void 0,this._setAsBlank="",this._setAsBlankRegexp=null,this._spaceIsTransparent=!0,this._ignoreLeadingSpaces=!0,this._spaceHasFormatting=!1,"setAsBlank"in e&&(this._setAsBlank=e.setAsBlank),this._setAsBlankRegexp=new RegExp("["+this._setAsBlank+"]","g"),this._processedText=this._text.replace(this._setAsBlankRegexp," "),"spaceIsTransparent"in e&&(this._spaceIsTransparent=e.spaceIsTransparent),"ignoreLeadingSpaces"in e&&(this._ignoreLeadingSpaces=e.ignoreLeadingSpaces),"spaceHasFormatting"in e&&(this._spaceHasFormatting=e.spaceHasFormatting),this._parseSpriteShape(),this._parseSegmentData(),Object.freeze(this)}_parseSpriteShape(){let t=!1,e=0;for("\n"===this.text[0]&&(e=1),this._rowIndices.push(e),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:e);e<this.text.length;e++)"\n"===this.text[e]?(e-this._rowIndices[this._rowIndices.length-1]>this._width&&(this._width=Math.max(this._width,e-this._rowIndices[this._rowIndices.length-1])),this._rowIndices.push(e+1),this._firstVisibleChar.push(this.ignoreLeadingSpaces?void 0:e),t=!1):t||" "===this.text[e]||(t=!0,this._firstVisibleChar[this._firstVisibleChar.length-1]=e),e>1&&"\n"===this.text[e-1]&&this._height++;"\n"!==this.text.charAt(this.text.length-1)?(this._width=Math.max(this._width,this.text.length-this._rowIndices[this._rowIndices.length-1]),this._rowIndices.push(this.text.length+1)):this._rowIndices.push(this.text.length)}_parseSegmentData(){this._segments=new Array(this.height);for(let t=0;t<this.height;t++){this._segments[t]=[];let s=this._rowIndices[t],i=this._rowIndices[t+1]-1-s,r=this.ignoreLeadingSpaces?this._firstVisibleChar[t]-s:0,h=r,n=e.BLANK;for(;r<i;){let e=s+r,i=this.text[e],o=this._charState(i);o!==n&&(this._addSegment(h,r,t,n),h=r,n=o),r++}this._addSegment(h,r,t,n)}}_addSegment(t,s,i,r){r!==e.BLANK&&this._segments[i].push({x:t,y:i,length:s-t,visibleText:r===e.HAS_TEXT})}get text(){return this._text}get width(){return this._width}get height(){return this._height}get setAsBlank(){return this._setAsBlank}get spaceIsTransparent(){return this._spaceIsTransparent}get ignoreLeadingSpaces(){return this._ignoreLeadingSpaces}get spaceHasFormatting(){return this._spaceHasFormatting}*getItSpritePos(t,e,s,i){let r=Math.max(s,0),h=Math.min(i,this.height);if(!(s>=this.height||i<=0))for(let s=r;s<h;s++){if(void 0===this._firstVisibleChar[s])continue;let i=this._rowIndices[s],r=this._rowIndices[s+1]-1-i,h=this.ignoreLeadingSpaces?this._firstVisibleChar[s]-i:0;if(!(t>=r||e<=h))for(let i of this._segments[s]){let r=Math.max(i.x,t),h=Math.min(i.x+i.length,e);if(e<=r)break;h<=t||(yield{x:r,y:s,length:h-r,visibleText:i.visibleText})}}}*getItScreenPos(t,e,s,i,r,h){for(let n of this.getItSpritePos(s-t,s+r-t,i-e,i+h-e))n.x+=t,n.y+=e,yield n}_charHasFormatting(t){return" "!==t||!this.spaceIsTransparent||this.spaceHasFormatting}_charHasText(t){return" "!==t||!this.spaceIsTransparent}_charState(t){return this._charHasText(t)?e.HAS_TEXT:this._charHasFormatting(t)?e.HAS_FORMATTING:e.BLANK}segmentLengthAt(t,e){if(e<0||e>=this.height)return 0;if(t<0||t>=this.width)return 0;for(let s of this._segments[e])if(!(s.x+s.length<=t))return t<s.x?0:s.x+s.length-t;return 0}segmentAt(t,e,s){const i=this._rowIndices[e];let r=this.segmentLengthAt(t,e);return r=s&&s<r?s:r,this._processedText.substring(i+t,i+t+r)}}const e={BLANK:0,HAS_FORMATTING:1,HAS_TEXT:2};class s{constructor(){this._styles={};for(let t in s.defaultValues)this._styles[t]=null}freeze(){Object.freeze(this._styles),Object.freeze(this)}clear(){for(let t in s.defaultValues)this._styles[t]=null}copy(t){this.clear();for(let e of t)this.setStyle(e,t.getStyle(e))}sameAs(t){for(let e in s.defaultValues)if(this.hasStyle(e)!==t.hasStyle(e)||this.getStyle(e)!==t.getStyle(e))return!1;return!0}setStyle(t,e){t in s.defaultValues||console.warn("AsciiGL currently does not support the style",t),this._styles[t]=e||null}hasStyle(t){return null!==this._styles[t]}getStyle(t){return this.hasStyle(t)?this._styles[t]:""}*[Symbol.iterator](){for(let t in this._styles)this.hasStyle(t)&&(yield t)}fillRemainder(t){for(let e in s.defaultValues)this.hasStyle(e)||(t&&t.hasStyle(e)?this.setStyle(e,t.getStyle(e)):this.setStyle(e,s.defaultValues[e]))}}s.defaultValues={color:"black",backgroundColor:"transparent",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",cursor:"default"},s.setDefaultStyle=function(t,e){t in s.defaultValues?s.defaultValues[t]=e:console.warn("Style does not support",t)};class i{constructor(t){this._template=t,this._paramCount=t.length-1}construct(e){let s="";for(let t=0;t<this._template.length;t++)s+=this._template[t],t<this._paramCount&&(s+=e[t]);return new t(s)}}class r{constructor(){this.primaryElement=document.createElement("pre"),this._width=0,this._height=0,this.activeRowLength=[],this.rows=[],this.elements=[],this.primaryElement.style.margin="0"}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++){let e=document.createElement("div");e.dataset.asciiGlRow=s,this.primaryElement.appendChild(e),this.rows.push(e),this.elements.push([]),this.activeRowLength.push(0);for(let e=0;e<t;e++)this.elements[s].push(new h)}}get width(){return this._width}get height(){return this._height}getDomElement(){return this.primaryElement}setRowLength(t,e){if(e<this.activeRowLength[t])for(let s=this.activeRowLength[t]-1;s>=e;s--)this.rows[t].removeChild(this.elements[t][s].getDomElement());else if(e>this.activeRowLength[t])for(let s=this.activeRowLength[t];s<e;s++)this.rows[t].appendChild(this.elements[t][s].getDomElement());this.activeRowLength[t]=e}bind(t){for(let e=0;e<this.height;e++){let s=0,i=0;for(;s<this.width;){let r=this.elements[e][i],h=t.getSegmentLengthAt(s,e),n=t.getSegmentAt(s,e),o=n.textId,a=void 0;a=void 0===o?" ".repeat(h):t.sprites[o].segmentAt(s-t.locations[o][0],e-t.locations[o][1],h),r.setText(a);let l=n.styles;for(let t in l)r.setStyle(t,l[t]);r.setId(n.frontId),i++,s+=h,r.applyChanges()}this.setRowLength(e,i)}}}class h{constructor(){this._domElement=document.createElement("span"),this._currText="",this._currStyles={},this._nextText="",this._nextStyles={},this._currId="",this._nextId=""}getDomElement(){return this._domElement}setText(t){this._nextText=t}setStyle(t,e){this._nextStyles[t]=e||""}setId(t){this._nextId=t}applyChanges(){let t=this._domElement;this._nextText!==this._currText&&(t.textContent=this._nextText),this._currText=this._nextText;for(let e in this._nextStyles){let s=this._nextStyles[e];s!==this._currStyles[e]&&(t.style[e]=s),this._currStyles[e]=s}this._nextId!==this._currId&&(void 0===this._nextId?delete t.dataset.asciiGlId:t.dataset.asciiGlId=this._nextId),this._currId=this._nextId}}class n{constructor(){this._width=0,this._height=0,this.rowComputedData=[],this.sprites={},this.locations={},this.backgroundStyle=new s,this.backgroundStyle.fillRemainder()}init(t,e){this._width=t,this._height=e;for(let s=0;s<e;s++)this.rowComputedData.push(new o(s,t,this.backgroundStyle))}get width(){return this._width}get height(){return this._height}clear(){for(let t=0;t<this.height;t++)this.rowComputedData[t].clear();this.sprites={},this.locations={}}draw(t,e,s,i){for(let r of t.getItScreenPos(e[0],e[1],0,0,this.width,this.height)){let t=r.y;this.rowComputedData[t].loadSegment(r.length,r.x,s,e[2],i,r.visibleText)}this.sprites[i]=t,this.locations[i]=e}getSegmentLengthAt(t,e){return this.rowComputedData[e].getSegmentLengthAt(t)}getSegmentAt(t,e){return this.rowComputedData[e].getSegmentAt(t)}}class o{constructor(t,e,s){this._width=e,this._rowNumber=t,this._nextPointer=new Array(e),this._computedSegments=new Array(e);for(let t=0;t<this.width;t++)this._computedSegments[t]=new a(s),this._nextPointer[t]=-1;this._nextPointer[0]=this.width}clear(){for(let t=1;t<this.width;t++)this._nextPointer[t]=-1;this._computedSegments[0].clear(),this._nextPointer[0]=this.width}get row(){return this._rowNumber}get width(){return this._width}insertSegmentStart(t){if(-1===this._nextPointer[t]){this._computedSegments[t].clear();let e=t-1;for(;-1===this._nextPointer[e];)e--;this._nextPointer[t]=this._nextPointer[e],this._nextPointer[e]=t,this._computedSegments[t].copy(this._computedSegments[e])}}loadSegment(t,e,s,i,r,h){let n=e+t;this.insertSegmentStart(e),this.insertSegmentStart(n);let o=e;do{this._computedSegments[o].addStyle(r,h,s,i),o=this._nextPointer[o]}while(o<this.width&&o<n)}getSegmentLengthAt(t){let e=t;for(;-1===this._nextPointer[e];)e--;return this._nextPointer[e]-t}getSegmentAt(t){for(;-1===this._nextPointer[t];)t--;return this._computedSegments[t]}}class a{constructor(t){this._default=t,this._spriteId=void 0,this._spritePriority=void 0,this._styleValues={},this._stylePriorities={},this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=void 0,this.clear(),Object.seal(this),Object.seal(this._styleValues),Object.seal(this._stylePriorities)}copy(t){for(let e in s.defaultValues)this._styleValues[e]=t._styleValues[e],this._stylePriorities[e]=t._stylePriorities[e];this._spriteId=t._spriteId,this._spritePriority=t._spritePriority,this._highestPriority=t._highestPriority,this._frontId=t._frontId}clear(){for(let t in s.defaultValues)this._styleValues[t]=this._default.getStyle(t),this._stylePriorities[t]=Number.POSITIVE_INFINITY;this._spriteId=void 0,this._spritePriority=Number.POSITIVE_INFINITY,this._highestPriority=Number.POSITIVE_INFINITY,this._frontId=void 0}get frontId(){return this._frontId}get textId(){return this._spriteId}get styles(){return this._styleValues}addStyle(t,e,s,i){for(let t of s)if(i<this._stylePriorities[t]){let e=s.getStyle(t);void 0!==e&&(this._styleValues[t]=e,this._stylePriorities[t]=i)}e&&i<this._spritePriority&&(this._spriteId=t,this._spritePriority=i),i<this._highestPriority&&(this._highestPriority=i,this._frontId=t)}}const l={generateId:function(){let t=0;return function(e){return void 0===e&&(e="AsciiEngine"),t++,e+"_"+t}}(),clamp:function(t,e,s){return Math.max(e,Math.min(t,s))},breakLineIntoRows:(t,e,s=!1)=>{let i=t.split(" "),r=[],h=0,n=0,o=0;for(let t=0;t<i.length;t++){if(t>n){if(h+1+i[t].length<=e){h+=1+i[t].length;continue}let a=i.slice(n,t).join(" ").substr(o);a.length<e&&s&&(a+=" ".repeat(e-a.length)),r.push(a),h=0,n=t,o=0}if(i[t].length>e){let s=0;for(;s<i[t].length-e;s+=e)r.push(i[t].substr(s,e));h=i[t].length-s,o=s}else h=i[t].length}return r.push(i.slice(n,i.length).join(" ").substr(o)),r},stringSplice:(t,e,s,i)=>t.substring(0,e)+(i||"")+t.substring(e+s)};Object.freeze(l);class _{constructor(t){console.assert(t,"AsciiGL constructor requires a valid HTML element id parameter.");let e=document.getElementById(t);for(console.assert(e,"AsciiGL constructor parameter containerId does not correspond to a valid HTML element."),console.assert("DIV"===e.tagName,"Container element must be a DIV");e.lastChild;)e.removeChild(e.lastChild);e.style.textAlign="center";let s=document.createElement("DIV");s.style.display="inline-block",s.style.fontFamily="Courier New",s.style.fontSize="1em",s.style.userSelect="none",s.style.margin="0",e.appendChild(s),this._container=s,this._domBuffer=new r,this._nameBuffers=[{},{}],this._drawBufferIdx=0,this._activeBufferIdx=1,this._width=0,this._height=0,this._drawBuffer=new n,this._currMouseOver=void 0,this._currMouseDown=void 0,this._handler=()=>{}}init(t,e){console.assert(t>0&&e>0,"AsciiGL must have positive dimensions."),this._width=t,this._height=e,this._drawBuffer.init(t,e),this._domBuffer.init(t,e),this._nameBuffers[0]={},this._nameBuffers[1]={},this._container.appendChild(this._domBuffer.getDomElement()),this._setupEventListeners(),this.render()}_setupEventListeners(){this._container.addEventListener("mouseenter",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mouseentercanvas",void 0,e);let s=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId];this._currMouseOver=s,s&&this._handler(t,"mouseenter",this._currMouseOver,e)}),this._container.addEventListener("mouseleave",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver,e),this._currMouseDown&&(this._currMouseDown=void 0),this._currMouseOver=void 0,this._handler(t,"mouseleavecanvas",void 0,e)}),this._container.addEventListener("mousemove",t=>{let e=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],s=this.mousePositionToCoordinates(t.clientX,t.clientY);e!==this._currMouseOver&&(this._currMouseOver&&this._handler(t,"mouseleave",this._currMouseOver,s),this._currMouseOver=e,e&&this._handler(t,"mouseenter",this._currMouseOver,s)),this._handler(t,"mousemove",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],s)}),this._container.addEventListener("mousedown",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._currMouseDown=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId]||void 0,this._handler(t,"mousedown",this._currMouseDown,e)}),this._container.addEventListener("mouseup",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"mouseup",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)}),this._container.addEventListener("click",t=>{let e=this.mousePositionToCoordinates(t.clientX,t.clientY),s=this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId];void 0!==this._currMouseDown&&s!==this._currMouseDown&&(this._currMouseDown=void 0),this._handler(t,"click",this._currMouseDown,e),this._currMouseDown=void 0}),this._container.addEventListener("contextmenu",t=>{t.preventDefault();let e=this.mousePositionToCoordinates(t.clientX,t.clientY);this._handler(t,"contextmenu",this._nameBuffers[this._activeBufferIdx][t.target.dataset.asciiGlId],e)})}mousePositionToCoordinates(t,e){let s=this._container.getBoundingClientRect();return{x:Math.floor((t-s.x)*this.width/s.width),y:Math.floor((e-s.y)*this.height/s.height)}}_flipBuffers(){this._drawBufferIdx=1-this._drawBufferIdx,this._activeBufferIdx=1-this._activeBufferIdx}get width(){return this._width}get height(){return this._height}get backgroundStyles(){return this._drawBuffer.backgroundStyle}getBackgroundStyle(t){return this._drawBuffer.backgroundStyle.getStyle(t)}setBackgroundStyle(t,e){this._drawBuffer.backgroundStyle.setStyle(t,e)}setHandler(t){this._handler=t}draw(t,e,s,i){let r=l.generateId(i);this._drawBuffer.draw(t,e,s,r),i&&(this._nameBuffers[this._drawBufferIdx][r]=i)}render(){this._domBuffer.bind(this._drawBuffer),this._drawBuffer.clear(),this._nameBuffers[this._activeBufferIdx]={},this._flipBuffers()}}const d={MOUSE_ENTER_CANVAS:"mouseentercanvas",MOUSE_LEAVE_CANVAS:"mouseleavecanvas",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_MOVE:"mousemove",MOUSE_ENTER:"mouseenter",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",CLICK:"click",CONTEXT_MENU:"contextmenu"};Object.freeze(d);const u={Instance:_,Sprite:t,Style:s,SpriteBuilder:i,EventTypes:d};Object.freeze(u);export default u;export{_ as AsciiGL,t as Sprite,i as SpriteBuilder,s as Style};
